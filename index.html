<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>stacie v7</title>
    <meta name="description" content="espa√±ol con confianza ‚Äî para stacie"/>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d3d30">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --brand-50: #edf7f3;
        --brand-100: #d6efe6;
        --brand-200: #b0e0cf;
        --brand-600: #1f7d62;
        --brand-700: #186651;
        --brand-800: #115240;
        --brand-900: #0d3d30;
        --blossom-600: #db4b94;
        --otis: #f59e0b;
        --doom: #8b5cf6;
        --jules: #ec4899;
        --lassie: #10b981;
        --mia: #3b82f6;
      }
      html, body { height: 100%; }
      body { margin: 0; transition: background-color 0.3s, color 0.3s; }
      body.light { background: #f6faf8; color: #0d3d30; }
      body.dark { background: #1a1a1a; color: #e0e0e0; }
      * { -webkit-tap-highlight-color: transparent; }
      
      .bg-brand-50 { background-color: var(--brand-50); }
      .bg-brand-100 { background-color: var(--brand-100); }
      .bg-brand-600 { background-color: var(--brand-600); }
      .bg-brand-700 { background-color: var(--brand-700); }
      .bg-brand-800 { background-color: var(--brand-800); }
      .bg-brand-900 { background-color: var(--brand-900); }
      .bg-blossom-600 { background-color: var(--blossom-600); }
      .text-brand-700 { color: var(--brand-700); }
      .text-brand-900 { color: var(--brand-900); }
      .border-brand-200 { border-color: var(--brand-200); }
      
      .shadow-soft { box-shadow: 0 8px 28px rgba(0,0,0,.10); }
      .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #d6efe6; z-index: 100; box-shadow: 0 -4px 12px rgba(0,0,0,0.05); }
      .main-content { padding-bottom: 80px; min-height: 100vh; }
      
      body.dark .tab-bar { background: #2a2a2a; border-top-color: #444; }
      body.dark .bg-white { background: #2a2a2a !important; }
      body.dark .text-brand-900 { color: #e0e0e0 !important; }
      body.dark .text-brand-700 { color: #b0b0b0 !important; }
      body.dark .border-brand-200 { border-color: #444 !important; }
      body.dark .bg-brand-50 { background-color: #333 !important; }
      body.dark .bg-brand-100 { background-color: #3a3a3a !important; }
      
      @keyframes slideIn {
        from { transform: translateY(-100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .toast { animation: slideIn 0.3s ease-out; }
      .hero-card { background: linear-gradient(135deg, var(--brand-700) 0%, var(--brand-900) 100%); }
      .badge-earned { box-shadow: 0 0 20px rgba(236, 90, 166, 0.4); }
      
      @keyframes tortilla {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(5deg); }
        75% { transform: rotate(-5deg); }
      }
      .loading { animation: tortilla 1s ease-in-out infinite; }
      
      .cat-card { transition: transform 0.2s; }
      .cat-card:hover { transform: scale(1.05); }
      
      /* Confidence meter */
      .confidence-bar {
        height: 8px;
        border-radius: 4px;
        background: linear-gradient(to right, #ef4444 0%, #f59e0b 40%, #10b981 100%);
        position: relative;
      }
      .confidence-marker {
        position: absolute;
        top: -2px;
        width: 12px;
        height: 12px;
        background: white;
        border: 2px solid #0d3d30;
        border-radius: 50%;
        transition: left 0.3s ease;
      }
      
      /* Conversation flow */
      .conversation-bubble {
        animation: slideIn 0.3s ease;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .recording-pulse { animation: pulse 1.5s ease-in-out infinite; }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="light">
    <div id="root"></div>
    <script type="text/babel">
      /******************************************************************
       * stacie v7 ‚Äî Confidence Edition
       * Nuevo en v7:
       *  - Restored 200+ sentences from earlier versions
       *  - Conversation simulator with branching dialogues
       *  - Confidence tracking separate from accuracy
       *  - Dedicated "Suegros Mode" for parent interactions
       *  - Recording library to hear progress over time
       *  - Context-aware practice (morning/evening/weekend)
       *  - Panic button with survival phrases
       *  - Enhanced stats with confidence graphs
       *  - All v6 features preserved
       ******************************************************************/
      const { useEffect, useMemo, useRef, useState, useCallback } = React;
      
      // ---------------- helpers ----------------
      const esLocale = 'es-MX';
      function cx(...classes) { return classes.filter(Boolean).join(' '); }
      function todayISO(){
        const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10);
      }
      function ydayISO(){
        const d=new Date(); d.setDate(d.getDate()-1); d.setHours(0,0,0,0); return d.toISOString().slice(0,10);
      }
      function daysAgo(n){
        const d=new Date(); d.setDate(d.getDate()-n); d.setHours(0,0,0,0); return d.toISOString().slice(0,10);
      }
      function useLocalStorage(key, initial){
        const [value,setValue]=useState(()=>{
          try { const raw=localStorage.getItem(key); return raw?JSON.parse(raw):initial; }
          catch { return initial; }
        });
        useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(value)); }catch{} },[key,value]);
        return [value,setValue];
      }
      
      function lev(a,b){
        const m=a.length,n=b.length;
        const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
        for(let i=0;i<=m;i++)dp[i][0]=i;
        for(let j=0;j<=n;j++)dp[0][j]=j;
        for(let i=1;i<=m;i++){
          for(let j=1;j<=n;j++){
            const cost=a[i-1]===b[j-1]?0:1;
            dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
          }
        }
        return dp[m][n];
      }
      function stripDiacritics(s){ try{ return s.normalize('NFD').replace(/[\p{M}]/gu,''); }catch{ return s; } }
      function tokenize(s){
        return stripDiacritics(String(s||'').toLowerCase())
          .replace(/[^a-z√±√°√©√≠√≥√∫√º\s]/gi,'')
          .split(/\s+/).filter(Boolean);
      }
      function wordScore(target, said){
        const t=tokenize(target), s=tokenize(said), bad=[];
        for(let i=0;i<t.length;i++){
          const tw=t[i], sw=s[i]??'';
          const d=lev(tw,sw);
          const threshold=Math.max(1, Math.floor(tw.length/3));
          if(d>threshold) bad.push(tw);
        }
        const pass = bad.length <= Math.ceil(t.length*0.2);
        return { pass, badWords: bad };
      }
      
      function flex(text, inclusive=true){
        return String(text).replace(/\[([^\]|]+)\|([^\]]+)\]/g, (_, fem, incl) => inclusive ? incl : fem);
      }
      
      function chooseEsVoice(){
        if (typeof window==='undefined' || !('speechSynthesis' in window)) return null;
        const voices = window.speechSynthesis.getVoices?.() || [];
        return voices.find(v=>v.lang?.toLowerCase().startsWith('es-mx'))
            || voices.find(v=>v.lang?.toLowerCase().startsWith('es-'))
            || null;
      }
      function speak(text,{rate=1}={}){
        if (typeof window==='undefined' || !('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = esLocale; u.rate = rate;
        const v = chooseEsVoice(); if (v) u.voice = v;
        try { window.speechSynthesis.cancel(); } catch {}
        window.speechSynthesis.speak(u);
      }
      function useSpeechRecognition({ onResult, onEnd }={}){
        const recRef = useRef(null);
        const [supported,setSupported]=useState(false);
        useEffect(()=>{
          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (SR){ const rec=new SR(); rec.lang=esLocale; rec.interimResults=true; rec.maxAlternatives=1; recRef.current=rec; setSupported(true); }
        },[]);
        const start=()=>{ const rec=recRef.current; if(!rec) return; let final=''; rec.onresult=(e)=>{ for(let i=e.resultIndex;i<e.results.length;i++){ const tr=e.results[i][0].transcript; if(e.results[i].isFinal) final+=tr; } onResult&&onResult(final); }; rec.onend=()=>onEnd&&onEnd(); try{ rec.start(); }catch{} };
        const stop = ()=>{ try{ recRef.current?.stop(); }catch{} };
        return { supported, start, stop };
      }
      
      // ---------------- CAT PERSONALITIES ----------------
      const CATS = {
        otis: { name: 'Otis', emoji: 'üê±', color: '#f59e0b', game: 'Speed Challenge', personality: 'competitive' },
        doom: { name: 'DOOM', emoji: 'üêà', color: '#8b5cf6', game: 'Memory Match', personality: 'affectionate' },
        jules: { name: 'Jules', emoji: 'üêæ', color: '#ec4899', game: 'Truth Meter', personality: 'independent' },
        lassie: { name: 'Lassie', emoji: 'üò∏', color: '#10b981', game: 'Phrase Collector', personality: 'protective' },
        mia: { name: 'Mia', emoji: 'üíô', color: '#3b82f6', personality: 'supportive' }
      };
      
      // ---------------- TRACKS ----------------
      const TRACKS = [
        { key:'work', name:'Mi trabajo', icon:'üè†', color:'bg-blossom-600' },
        { key:'mia', name:'Mia & yo', icon:'üíï', color:'bg-blue-600' },
        { key:'family', name:'Familia', icon:'üë®‚Äçüë©‚Äçüëß', color:'bg-brand-800' },
        { key:'suegros', name:'Los suegros', icon:'üë¥üëµ', color:'bg-purple-600' },
        { key:'vida', name:'D√≠a a d√≠a', icon:'üåÆ', color:'bg-brand-700' },
        { key:'health', name:'Salud', icon:'üíä', color:'bg-emerald-600' },
        { key:'food', name:'Comida', icon:'üå∂Ô∏è', color:'bg-orange-600' }
      ];
      
// ---------------- EXPANDED CONTENT LIBRARY (FIXED) ----------------
const SENTENCES_BASE = {
  work: [
    // Residence Hall Basics
    { id:'w1', lvl:0, es:'Hola, bienvenido. ¬øC√≥mo te llamas?', hint:'welcome what is your name', tags:['greeting'] },
    { id:'w2', lvl:0, es:'¬øC√≥mo va todo en tu cuarto?', hint:'how is everything in your room', tags:['checkin'] },
    { id:'w3', lvl:0, es:'Estoy aqu√≠ para ayudar.', hint:'here to help', tags:['support'] },
    { id:'w4', lvl:1, es:'¬øNecesitas algo? Av√≠same porfa.', hint:'need anything let me know', tags:['support'] },
    { id:'w5', lvl:1, es:'Hay un evento esta noche en el sal√≥n.', hint:'event tonight in lounge', tags:['events'] },
    { id:'w6', lvl:1, es:'¬øC√≥mo te va con las clases?', hint:'how are classes', tags:['rapport'] },
    { id:'w7', lvl:2, es:'Si hay problema, comun√≠cate conmigo.', hint:'if problem communicate with me', tags:['boundaries'] },
    { id:'w8', lvl:2, es:'Respeten las horas de silencio porfa.', hint:'respect quiet hours please', tags:['rules'] },
    // Carleton-specific
    { id:'w9', lvl:0, es:'¬øTe fue bien en el tour hoy?', hint:'tour go well today', tags:['work','carleton'] },
    { id:'w10', lvl:1, es:'Las familias siempre preguntan sobre el clima.', hint:'families always ask about weather', tags:['work','minnesota'] },
    { id:'w11', lvl:1, es:'El Arb es mi parte favorita del campus.', hint:'arb is my favorite part', tags:['work','carleton'] },
    { id:'w12', lvl:2, es:'Cu√©ntales sobre las opciones de comida.', hint:'tell them about food options', tags:['work','tours'] },
  ],
  
  mia: [
    // Daily Check-ins
    { id:'m1', lvl:0, es:'¬øC√≥mo te fue hoy?', hint:'how was your day', tags:['checkin'] },
    { id:'m2', lvl:0, es:'Cu√©ntame de tu d√≠a en Carleton.', hint:'tell me about your day at Carleton', tags:['interest'] },
    { id:'m3', lvl:0, es:'¬øQuieres cocinar juntos esta noche?', hint:'cook together tonight', tags:['plans'] },
    { id:'m4', lvl:1, es:'¬øHubo tours interesantes hoy?', hint:'interesting tours today', tags:['work'] },
    { id:'m5', lvl:1, es:'Te guard√© la √∫ltima concha.', hint:'saved you the last pastry', tags:['sweet'] },
    { id:'m6', lvl:1, es:'¬øQuieres que hagamos algo especial este finde?', hint:'do something special weekend', tags:['plans'] },
    { id:'m7', lvl:1, es:'Eres incre√≠ble. Gracias por todo.', hint:'you are amazing thanks for everything', tags:['appreciation'] },
    { id:'m8', lvl:2, es:'Te ves [cansada|cansado]. ¬øNecesitas descansar?', hint:'you look tired need to rest', tags:['care'] },
    // Emotional Support
    { id:'m9', lvl:0, es:'Te extra√±o cuando no est√°s.', hint:'miss you when not here', tags:['love'] },
    { id:'m10', lvl:1, es:'Me encanta c√≥mo te r√≠es.', hint:'love how you laugh', tags:['compliment'] },
    { id:'m11', lvl:1, es:'Eres mi persona favorita.', hint:'you are my favorite person', tags:['love'] },
    { id:'m12', lvl:2, es:'Plat√≠came qu√© te preocupa.', hint:'tell me what worries you', tags:['support'] },
  ],
  
  family: [
    // Basic Greetings
    { id:'f1', lvl:0, es:'Buenos d√≠as. ¬øC√≥mo est√°n?', hint:'good morning how are you', tags:['greeting'] },
    { id:'f2', lvl:0, es:'La comida est√° deliciosa.', hint:'food is delicious', tags:['compliment'] },
    { id:'f3', lvl:0, es:'Disculpe, ¬ømande? No entend√≠.', hint:'pardon what did not understand', tags:['clarification'] },
    { id:'f4', lvl:1, es:'Me da mucho gusto verlos.', hint:'happy to see you', tags:['warmth'] },
    { id:'f5', lvl:1, es:'Gracias por recibirnos.', hint:'thanks for having us', tags:['gratitude'] },
    { id:'f6', lvl:1, es:'Practico mi espa√±ol cada d√≠a.', hint:'practice Spanish every day', tags:['effort'] },
    { id:'f7', lvl:2, es:'Cu√©ntennos de su semana.', hint:'tell us about your week', tags:['conversation'] },
    { id:'f8', lvl:2, es:'D√©jennos ayudar con los platos.', hint:'let us help with dishes', tags:['helping'] },
    // Extended Family
    { id:'f9', lvl:1, es:'¬øC√≥mo est√° la familia en M√©xico?', hint:'how is family in Mexico', tags:['extended'] },
    { id:'f10', lvl:1, es:'Me gustar√≠a conocer a todos.', hint:'would like to meet everyone', tags:['interest'] },
    { id:'f11', lvl:2, es:'Espero que podamos visitarlos pronto.', hint:'hope we can visit soon', tags:['future'] },
  ],
  
  suegros: [
    // Meeting Parents
    { id:'s1', lvl:0, es:'Mucho gusto en conocerlos.', hint:'nice to meet you', tags:['first_meeting'] },
    { id:'s2', lvl:0, es:'Jorge me ha hablado mucho de ustedes.', hint:'Jorge told me a lot about you', tags:['connection'] },
    { id:'s3', lvl:0, es:'Su casa es muy bonita.', hint:'your house is very pretty', tags:['compliment'] },
    { id:'s4', lvl:1, es:'¬øPuedo ayudar con algo?', hint:'can I help with something', tags:['helpful'] },
    { id:'s5', lvl:1, es:'Me encanta la comida mexicana.', hint:'love Mexican food', tags:['food'] },
    { id:'s6', lvl:1, es:'Jorge y yo estamos muy contentos.', hint:'Jorge and I are very happy', tags:['relationship'] },
    { id:'s7', lvl:2, es:'Trabajo en una residencia universitaria.', hint:'work in university residence', tags:['job'] },
    { id:'s8', lvl:2, es:'Aprecio mucho su hospitalidad.', hint:'appreciate your hospitality', tags:['formal'] },
    // Cultural Bridge
    { id:'s9', lvl:1, es:'En Minnesota hace mucho fr√≠o.', hint:'Minnesota very cold', tags:['minnesota'] },
    { id:'s10', lvl:1, es:'Me ense√±an mucho sobre M√©xico.', hint:'you teach me about Mexico', tags:['learning'] },
    { id:'s11', lvl:2, es:'Es importante para m√≠ hablar espa√±ol.', hint:'important for me to speak Spanish', tags:['commitment'] },
    { id:'s12', lvl:2, es:'Quiero que nuestros hijos sean biling√ºes.', hint:'want our children bilingual', tags:['future'] },
  ],
  
  vida: [
    // Morning Routines
    { id:'v1', lvl:0, es:'Buenos d√≠as, mi amor. ¬øDormiste bien?', hint:'good morning sleep well', tags:['morning','mia'] },
    { id:'v2', lvl:0, es:'Voy a hacer caf√©. ¬øQuieres?', hint:'making coffee want some', tags:['morning','coffee'] },
    { id:'v3', lvl:0, es:'¬øA qu√© hora sales hoy?', hint:'what time leave today', tags:['morning','schedule'] },
    { id:'v4', lvl:1, es:'Tengo que salir tempranito para el trabajo.', hint:'leave early for work', tags:['morning','work'] },
    { id:'v5', lvl:1, es:'¬øDesayunamos juntos?', hint:'breakfast together', tags:['morning','meal'] },
    // Evening Routines
    { id:'v6', lvl:0, es:'¬øQu√© se te antoja para cenar?', hint:'what want for dinner', tags:['evening','food'] },
    { id:'v7', lvl:0, es:'Ya llegu√©. ¬øC√≥mo est√°s?', hint:'arrived how are you', tags:['evening','arrival'] },
    { id:'v8', lvl:1, es:'Estoy cansado. ¬øPedimos comida?', hint:'tired order food', tags:['evening','tired'] },
    { id:'v9', lvl:1, es:'Vamos a ver algo en Netflix y descansar.', hint:'watch Netflix and rest', tags:['evening','relax'] },
    { id:'v10', lvl:2, es:'Prepara t√∫ la cena mientras yo lavo.', hint:'you make dinner while I wash', tags:['evening','chores'] },
    // Weekend
    { id:'v11', lvl:0, es:'Es s√°bado. Podemos dormir tantito m√°s.', hint:'Saturday sleep more', tags:['weekend','sleep'] },
    { id:'v12', lvl:1, es:'Vamos al Arb si hace buen clima.', hint:'go to Arb if good weather', tags:['weekend','minnesota'] },
    { id:'v13', lvl:1, es:'¬øQu√© tal un brunch y luego el mercado?', hint:'brunch then market', tags:['weekend','plans'] },
    { id:'v14', lvl:2, es:'Invitemos a amigos a cenar.', hint:'invite friends for dinner', tags:['weekend','social'] },
    // Minnesota Life
    { id:'v15', lvl:0, es:'Hace mucho fr√≠o afuera.', hint:'freezing cold outside', tags:['winter','minnesota'] },
    { id:'v16', lvl:1, es:'Si hace fr√≠o, hacemos t√© y nos quedamos.', hint:'if cold make tea and stay', tags:['winter','cozy'] },
    { id:'v17', lvl:1, es:'¬øTraes tu chamarra buena? Hace fr√≠o.', hint:'have good jacket cold', tags:['winter','care'] },
    { id:'v18', lvl:1, es:'La nieve est√° bonita pero qu√© flojera.', hint:'snow pretty but what laziness', tags:['winter','minnesota'] },
    // Errands & Shopping
    { id:'v19', lvl:0, es:'Necesitamos ir al s√∫per.', hint:'need to go to store', tags:['errands','shopping'] },
    { id:'v20', lvl:1, es:'¬øMe acompa√±as a Target?', hint:'come with me to Target', tags:['errands','shopping'] },
    { id:'v21', lvl:1, es:'Hay que comprar papel de ba√±o.', hint:'need to buy toilet paper', tags:['errands','necessities'] },
    { id:'v22', lvl:2, es:'Revisa qu√© hace falta en la cocina.', hint:'check what needed in kitchen', tags:['errands','planning'] },
  ],
  
  health: [
    // Basic Health
    { id:'h1', lvl:0, es:'Me duele la cabeza.', hint:'head hurts', tags:['pain'] },
    { id:'h2', lvl:0, es:'¬øTienes medicina?', hint:'have medicine', tags:['medication'] },
    { id:'h3', lvl:0, es:'Me siento mal.', hint:'feel bad', tags:['sick'] },
    { id:'h4', lvl:1, es:'Creo que tengo fiebre.', hint:'think I have fever', tags:['symptoms'] },
    { id:'h5', lvl:1, es:'Necesito descansar.', hint:'need to rest', tags:['recovery'] },
    // Emotions
    { id:'h6', lvl:0, es:'Estoy feliz.', hint:'I am happy', tags:['emotions','positive'] },
    { id:'h7', lvl:0, es:'Me siento triste.', hint:'feel sad', tags:['emotions','negative'] },
    { id:'h8', lvl:1, es:'Estoy estresada por el trabajo.', hint:'stressed about work', tags:['emotions','stress'] },
    { id:'h9', lvl:1, es:'Me siento orgullosa de ti.', hint:'feel proud of you', tags:['emotions','pride'] },
    { id:'h10', lvl:2, es:'Necesito hablar de algo que me molesta.', hint:'need to talk about something bothering', tags:['emotions','communication'] },
  ],
  
  food: [
    // Coffee Orders
    { id:'fo1', lvl:0, es:'Un caf√©, por favor.', hint:'coffee please', tags:['coffee','order'] },
    { id:'fo2', lvl:0, es:'Un oat milk latte, no muy caliente.', hint:'oat milk latte not too hot', tags:['coffee','specific'] },
    { id:'fo3', lvl:1, es:'¬øTienen descafeinado?', hint:'have decaf', tags:['coffee','question'] },
    // Restaurant
    { id:'fo4', lvl:0, es:'Mesa para dos, por favor.', hint:'table for two please', tags:['restaurant'] },
    { id:'fo5', lvl:0, es:'La cuenta, por favor.', hint:'check please', tags:['restaurant'] },
    { id:'fo6', lvl:1, es:'Para llevar, por favor. Sin cilantro.', hint:'to go no cilantro', tags:['takeout'] },
    { id:'fo7', lvl:1, es:'¬øQu√© me recomienda?', hint:'what do you recommend', tags:['restaurant','question'] },
    { id:'fo8', lvl:2, es:'¬øTienen opciones vegetarianas?', hint:'have vegetarian options', tags:['restaurant','dietary'] },
    // Mexican Food
    { id:'fo9', lvl:0, es:'Dos tacos de carnitas, porfa.', hint:'two carnitas tacos please', tags:['mexican'] },
    { id:'fo10', lvl:1, es:'Con todo menos cebolla.', hint:'with everything except onion', tags:['mexican','preference'] },
    { id:'fo11', lvl:1, es:'¬øPica mucho?', hint:'is it very spicy', tags:['mexican','spice'] },
    { id:'fo12', lvl:2, es:'Me gustan las tortillas de ma√≠z m√°s.', hint:'prefer corn tortillas', tags:['mexican','preference'] },
  ]
};

const ALL_SENTENCES = Object.values(SENTENCES).flat();

// 2) Variant engine: creates ~2 extra natural variants per phrase (‚âà3√ó total)
function makeVariants(s) {
  const variants = [s];

  // Politeness / discourse tweak
  const politeMap = [
    ['porfa', 'por favor'],
    ['por favor', 'porfa'],
  ];
  let v1 = s.es;
  for (const [a, b] of politeMap) {
    if (v1.includes(a)) { v1 = v1.replace(a, b); }
  }
  if (v1 === s.es) {
    // softener if nothing changed
    v1 = s.es.endsWith('?') ? s.es.replace('?', ', ¬øs√≠?') : s.es + ', ¬øs√≠?';
  }
  variants.push({ ...s, id: s.id + 'a', es: v1 });

  // Time/tense/context tweak
  let v2 = s.es;
  const action = /\b(cenar|cocinar|desayunar|hacer|salir|ir|practicar|ver|comprar|invitemos|vamos)\b/i.test(v2);
  if (action) {
    v2 = v2.includes('hoy') ? v2.replace(/\bhoy\b/i, 'ahorita') : (v2.endsWith('.') ? v2.replace(/\.$/, ' ahorita.') : v2 + ' ahorita');
  } else if (v2.endsWith('?')) {
    v2 = v2.replace('?', ' un momento?');
  } else {
    v2 = v2 + ' tantito.';
  }
  variants.push({ ...s, id: s.id + 'b', es: v2 });

  // De-dup
  const seen = new Set();
  return variants.filter(p => {
    const key = p.es.trim();
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}

// 3) Build the expanded SENTENCES object (~3√ó per category)
const SENTENCES = Object.fromEntries(
  Object.entries(SENTENCES_BASE).map(([key, arr]) => [key, arr.flatMap(makeVariants)])
);

// 4) Keep the rollup
const ALL_SENTENCES = Object.values(SENTENCES).flat();

// ---------------- LUNCH CARDS ----------------
const LUNCH_CARDS = [
  { id:'lc1', es:'Cu√©ntale a Mia sobre tu d√≠a en espa√±ol.', en:'Tell Mia about your day in Spanish.' },
  { id:'lc2', es:'Preg√∫ntale qu√© se le antoja para cenar.', en:'Ask what she craves for dinner.' },
  { id:'lc3', es:'Dile algo bonito usando "me encanta..."', en:'Say something nice using "me encanta..."' },
  { id:'lc4', es:'Inv√≠tala a cocinar juntes esta noche.', en:'Invite her to cook together tonight.' },
  { id:'lc5', es:'Pregunta: "¬øC√≥mo te sientes hoy?"', en:'Ask: "How do you feel today?"' },
  { id:'lc6', es:'Practica: "Estoy [orgullose|orgullose] de ti."', en:'Practice: "I\'m proud of you."' },
  { id:'lc7', es:'Sugiere planes para el fin de semana.', en:'Suggest weekend plans.' },
  { id:'lc8', es:'Habla del clima en espa√±ol.', en:'Talk about the weather in Spanish.' },
  { id:'lc9', es:'Pide ayuda con algo usando "¬øMe ayudas...?"', en:'Ask for help using "¬øMe ayudas...?"' },
  { id:'lc10', es:'Comparte qu√© aprendiste hoy.', en:'Share what you learned today.' },
  { id:'lc11', es:'Pregunta sobre su familia en M√©xico.', en:'Ask about her family in Mexico.' },
  { id:'lc12', es:'Dile tres cosas por las que est√°s [agradecide|agradecide].', en:'Tell three things you\'re grateful for.' },
  { id:'lc13', es:'Practica ordenar caf√© en espa√±ol.', en:'Practice ordering coffee in Spanish.' },
  { id:'lc14', es:'Describe tu comida favorita mexicana.', en:'Describe your favorite Mexican food.' },
  { id:'lc15', es:'Habla de tus metas en espa√±ol.', en:'Talk about your goals in Spanish.' },
];

// ---------------- ENCOURAGEMENTS ----------------
const ENCOURAGEMENTS = [
  // Otis (competitive)
  { cat: 'otis', text: 'MIAU MIAU... digo, excelente. Aunque yo lo hubiera hecho mejor. üòº' },
  { cat: 'otis', text: '*se estira todo lo largo* S√≠ s√≠, bien. ¬øYa terminaste? üê±' },
  { cat: 'otis', text: 'Aceptable. Para ser humana. *bosteza* üê±' },
  // Doom (affectionate)
  { cat: 'doom', text: 'Eso estuvo de lujo. Te mando un abrazo grande (como yo). üêàüíï' },
  { cat: 'doom', text: 'Le echaste salsita. Pica rico. üå∂Ô∏èüêà' },
  { cat: 'doom', text: '*ronroneo intenso* Bien hecho, Stacie. üêà' },
  // Jules (independent)
  { cat: 'jules', text: 'Qued√≥ chido. Ahora d√©jame en paz, necesito mi espacio. üêæ' },
  { cat: 'jules', text: 'Respeto. Hoy te ganaste tu espacio. üëèüêæ' },
  { cat: 'jules', text: 'No est√° mal. *se va a su rinc√≥n* üêæ' },
  // Lassie (protective)
  { cat: 'lassie', text: 'Te cuido siempre. Poquito a poquito es camino. üò∏' },
  { cat: 'lassie', text: 'Estoy [orgullosa|orgullose]. Yo vigilo. üõ°Ô∏èüò∏' },
  { cat: 'lassie', text: 'Bien, Stacie. Aqu√≠ estoy si necesitas. üò∏' },
  // Mia (supportive)
  { cat: 'mia', text: 'Mi amor, qu√© [orgullose|orgullose] estoy. Eres incre√≠ble. üíô' },
  { cat: 'mia', text: 'Te amo. Cada d√≠a mejor. üíô' },
  { cat: 'mia', text: 'Eso es, mi vida. Sigue as√≠. üíô' },
];

// ---------------- CONVERSATIONS ----------------
const CONVERSATIONS = {
  suegros_dinner: {
    name: 'Cena con los suegros',
    start: {
      them: 'Buenas noches, Stacie. ¬øC√≥mo est√°s?',
      responses: [
        { text: 'Muy bien, gracias. ¬øY ustedes?', confidence: 5, next: 'good_response' },
        { text: 'Bien, gracias.', confidence: 3, next: 'short_response' },
        { text: 'Estoy bien. La comida huele deliciosa.', confidence: 4, next: 'food_compliment' }
      ]
    },
    good_response: {
      them: 'Muy bien tambi√©n. ¬øC√≥mo te fue en el trabajo?',
      responses: [
        { text: 'Bien, tuve muchos tours hoy.', confidence: 4, next: 'work_talk' },
        { text: 'Un poco cansada, pero bien.', confidence: 3, next: 'tired' },
        { text: 'Muy bien. Los estudiantes est√°n emocionados.', confidence: 5, next: 'students' }
      ]
    },
    short_response: {
      them: 'Qu√© bueno. P√°sale, ya casi est√° la cena.',
      responses: [
        { text: 'Gracias. ¬øPuedo ayudar con algo?', confidence: 5, next: 'helpful' },
        { text: 'Gracias, huele muy rico.', confidence: 4, next: 'food_compliment' }
      ]
    },
    food_compliment: {
      them: 'Gracias, es mole de la abuela. ¬øTe gusta la comida mexicana?',
      responses: [
        { text: 'Me encanta. Mia me ha ense√±ado mucho.', confidence: 5, next: 'end_good' },
        { text: 'S√≠, mucho. Especialmente el mole.', confidence: 4, next: 'end_good' },
        { text: 'S√≠, pero todav√≠a estoy aprendiendo sobre los picantes.', confidence: 4, next: 'end_good' }
      ]
    },
    work_talk: {
      them: 'Qu√© bueno. Mia nos cuenta que trabajas muy duro.',
      responses: [
        { text: 'Me gusta mucho mi trabajo.', confidence: 4, next: 'end_good' },
        { text: 'S√≠, pero vale la pena. Me encanta Carleton.', confidence: 5, next: 'end_good' }
      ]
    },
    tired: {
      them: 'Descansa. La cena te va a dar energ√≠a.',
      responses: [
        { text: 'Gracias, son muy amables.', confidence: 5, next: 'end_good' },
        { text: 'S√≠, necesito la comida de casa.', confidence: 4, next: 'end_good' }
      ]
    },
    students: {
      them: '¬°Qu√© padre! ¬øDe d√≥nde vienen los estudiantes?',
      responses: [
        { text: 'De todo el pa√≠s, y algunos internacionales.', confidence: 5, next: 'end_good' },
        { text: 'De muchos lugares. Es muy diverso.', confidence: 4, next: 'end_good' }
      ]
    },
    helpful: {
      them: 'No te preocupes, ya est√° todo. Mejor plat√≠canos de tu semana.',
      responses: [
        { text: 'Fue buena. Mia y yo fuimos al Arb el s√°bado.', confidence: 5, next: 'end_good' },
        { text: 'Muy ocupada, pero productiva.', confidence: 4, next: 'end_good' }
      ]
    },
    end_good: {
      them: '¬°Qu√© bien! Vamos a cenar.',
      complete: true,
      feedback: '¬°Excelente conversaci√≥n! Los suegros est√°n impresionados.'
    }
  },
  
  morning_routine: {
    name: 'Rutina de la ma√±ana',
    start: {
      them: 'Buenos d√≠as, mi amor.',
      responses: [
        { text: 'Buenos d√≠as. ¬øDormiste bien?', confidence: 5, next: 'sleep_well' },
        { text: 'Hola, mi vida. ¬øCaf√©?', confidence: 4, next: 'coffee' },
        { text: 'Buenos d√≠as. ¬øQu√© hora es?', confidence: 3, next: 'time' }
      ]
    },
    sleep_well: {
      them: 'S√≠, muy bien. ¬øY t√∫?',
      responses: [
        { text: 'Tambi√©n. So√±√© contigo.', confidence: 5, next: 'sweet' },
        { text: 'M√°s o menos. Los gatos me despertaron.', confidence: 4, next: 'cats' },
        { text: 'Bien, pero necesito caf√©.', confidence: 3, next: 'coffee' }
      ]
    },
    coffee: {
      them: 'Yo hago el caf√©. ¬øEl de siempre?',
      responses: [
        { text: 'S√≠, porfa. Oat milk latte.', confidence: 5, next: 'breakfast' },
        { text: 'S√≠, gracias mi amor.', confidence: 4, next: 'breakfast' },
        { text: 'Mejor t√© hoy, gracias.', confidence: 3, next: 'breakfast' }
      ]
    },
    time: {
      them: 'Las siete y media. ¬øTienes que salir temprano?',
      responses: [
        { text: 'S√≠, tengo tours a las nueve.', confidence: 4, next: 'work' },
        { text: 'No, hoy empiezo tarde.', confidence: 4, next: 'late_start' },
        { text: 'Un poco. ¬øDesayunamos juntes?', confidence: 5, next: 'breakfast' }
      ]
    },
    sweet: {
      them: 'Ay, qu√© linde. Te amo.',
      responses: [
        { text: 'Y yo a ti. ¬øQu√© haces hoy?', confidence: 5, next: 'day_plans' },
        { text: 'Te amo m√°s. ¬øDesayunamos?', confidence: 5, next: 'breakfast' }
      ]
    },
    cats: {
      them: 'Jaja, Otis seguro. Es un despertador peludo.',
      responses: [
        { text: 'Necesita su desayuno a las 6 AM exactas.', confidence: 5, next: 'breakfast' },
        { text: 'S√≠, muy puntual el se√±or.', confidence: 4, next: 'breakfast' }
      ]
    },
    work: {
      them: '¬øCu√°ntos tours tienes hoy?',
      responses: [
        { text: 'Tres, y una reuni√≥n despu√©s.', confidence: 5, next: 'end_good' },
        { text: 'Varios. Va a ser un d√≠a largo.', confidence: 4, next: 'end_good' }
      ]
    },
    late_start: {
      them: 'Qu√© bueno. Entonces podemos desayunar con calma.',
      responses: [
        { text: 'S√≠, me encanta. ¬øQu√© hacemos?', confidence: 5, next: 'end_good' },
        { text: 'Perfecto. Hagamos pancakes.', confidence: 5, next: 'end_good' }
      ]
    },
    breakfast: {
      them: '¬øQu√© se te antoja?',
      responses: [
        { text: 'Lo que sea est√° bien. ¬øHay fruta?', confidence: 4, next: 'end_good' },
        { text: 'Huevitos con tortilla.', confidence: 5, next: 'end_good' },
        { text: 'Algo r√°pido, tengo que salir.', confidence: 3, next: 'end_good' }
      ]
    },
    day_plans: {
      them: 'Trabajo desde casa hoy. ¬øNos vemos para almorzar?',
      responses: [
        { text: 'S√≠, ¬øa la una est√° bien?', confidence: 5, next: 'end_good' },
        { text: 'Me encantar√≠a. Te texto cuando salga.', confidence: 5, next: 'end_good' }
      ]
    },
    end_good: {
      them: 'Perfecto. Ten un buen d√≠a, mi amor.',
      complete: true,
      feedback: '¬°Conversaci√≥n natural y fluida! Mia est√° feliz.'
    }
  },
  
  panic_situations: {
    name: 'Situaciones de p√°nico',
    start: {
      them: '[Hablan muy r√°pido y no entiendes nada]',
      responses: [
        { text: 'Disculpe, ¬øpuede repetir m√°s despacio?', confidence: 5, next: 'slower' },
        { text: 'Perd√≥n, no entend√≠. ¬øMande?', confidence: 4, next: 'repeat' },
        { text: 'Lo siento, mi espa√±ol no es perfecto.', confidence: 3, next: 'understanding' }
      ]
    },
    slower: {
      them: '[Repiten m√°s lento]',
      responses: [
        { text: 'Ah, s√≠. Entiendo. Gracias.', confidence: 4, next: 'end_good' },
        { text: 'Gracias por su paciencia.', confidence: 5, next: 'end_good' },
        { text: 'Creo que s√≠. ¬øEs sobre [topic]?', confidence: 3, next: 'clarify' }
      ]
    },
    repeat: {
      them: '[Repiten la pregunta]',
      responses: [
        { text: 'Ah, ya. D√©jeme pensar...', confidence: 4, next: 'thinking' },
        { text: 'Gracias. S√≠, entiendo.', confidence: 4, next: 'end_good' },
        { text: 'Una vez m√°s, por favor.', confidence: 3, next: 'third_time' }
      ]
    },
    understanding: {
      them: 'No te preocupes, est√° bien.',
      responses: [
        { text: 'Gracias. Estoy aprendiendo.', confidence: 5, next: 'end_good' },
        { text: 'Practico todos los d√≠as.', confidence: 4, next: 'end_good' }
      ]
    },
    clarify: {
      them: '[Confirman o corrigen]',
      responses: [
        { text: 'Ah, okay. Entiendo ahora.', confidence: 4, next: 'end_good' },
        { text: 'Gracias por explicar.', confidence: 5, next: 'end_good' }
      ]
    },
    thinking: {
      them: '[Esperan tu respuesta]',
      responses: [
        { text: '[Das tu mejor respuesta]', confidence: 3, next: 'end_okay' },
        { text: 'No estoy segura, pero creo que...', confidence: 4, next: 'end_okay' }
      ]
    },
    third_time: {
      them: '[Repiten muy despacio]',
      responses: [
        { text: 'Ya, gracias. Muy amable.', confidence: 4, next: 'end_good' },
        { text: 'S√≠, ahora s√≠ entend√≠.', confidence: 4, next: 'end_good' }
      ]
    },
    end_good: {
      them: '[Contin√∫a la conversaci√≥n normal]',
      complete: true,
      feedback: '¬°Bien manejado! Pediste ayuda con confianza.'
    },
    end_okay: {
      them: '[Aceptan tu respuesta]',
      complete: true,
      feedback: 'Lo resolviste. Con pr√°ctica ser√° m√°s f√°cil.'
    }
  }
};

// ---------------- PANIC PHRASES ----------------
const PANIC_PHRASES = [
  { es: 'Disculpe, no entend√≠.', hint: 'Sorry, I didn\'t understand' },
  { es: '¬øPuede repetir, por favor?', hint: 'Can you repeat please?' },
  { es: '¬øPuede hablar m√°s despacio?', hint: 'Can you speak slower?' },
  { es: 'Mi espa√±ol est√° mejorando.', hint: 'My Spanish is improving' },
  { es: '¬øMande? (polite "what?")', hint: 'Pardon? (polite)' },
  { es: 'Un momento, por favor.', hint: 'One moment please' },
  { es: '¬øC√≥mo se dice...?', hint: 'How do you say...?' },
  { es: 'Gracias por su paciencia.', hint: 'Thanks for your patience' },
  { es: 'Estoy aprendiendo.', hint: 'I\'m learning' },
  { es: '¬øMe puede ayudar?', hint: 'Can you help me?' }
];

// ---------------- BADGES ----------------
const BADGES = [
  // Original food-based
  { id: 'b1', name: 'Tamal sin pasita', emoji: 'ü´î', desc: '10 correctas seguidas', req: 'streak_correct', count: 10 },
  { id: 'b2', name: 'Taquere de confianza', emoji: 'üåÆ', desc: '7 d√≠as consecutivos', req: 'streak', count: 7 },
  { id: 'b3', name: 'Cafecite perfect', emoji: '‚òï', desc: '20 pr√°cticas', req: 'practices', count: 20 },
  { id: 'b4', name: 'Conchera', emoji: 'ü•ê', desc: '30 d√≠as streak', req: 'streak', count: 30 },
  { id: 'b5', name: 'Masa que reposa', emoji: 'ü´ì', desc: '10 diarios', req: 'journals', count: 10 },
  // Cat-based
  { id: 'b6', name: 'Gato favorito', emoji: 'üòª', desc: 'Juega con cada gato', req: 'cat_games', count: 4 },
  { id: 'b7', name: 'Ronroneo constante', emoji: 'üêà', desc: '50 frases dominadas', req: 'mastered', count: 50 },
  // Confidence-based (NEW)
  { id: 'b8', name: 'Voz segura', emoji: 'üé§', desc: 'Confidence promedio > 4', req: 'confidence', count: 4 },
  { id: 'b9', name: 'Sin miedo', emoji: 'üí™', desc: '10 conversaciones completas', req: 'conversations', count: 10 },
  { id: 'b10', name: 'Biling√ºe en proceso', emoji: 'üåü', desc: '100 recordings', req: 'recordings', count: 100 },
];

      
      // ---------------- Context-Aware Content ----------------
      function getContextualContent() {
        const now = new Date();
        const hour = now.getHours();
        const day = now.getDay();
        const month = now.getMonth();
        
        let contextPhrases = [];
        let greeting = '';
        let activity = '';
        
        // Time of day
        if (hour < 12) {
          greeting = 'Buenos d√≠as ‚òÄÔ∏è';
          activity = 'Perfecto para practicar mientras tomas caf√©';
          contextPhrases = ALL_SENTENCES.filter(s => s.tags?.includes('morning'));
        } else if (hour < 18) {
          greeting = 'Buenas tardes üå§Ô∏è';
          activity = 'Un break perfecto del trabajo';
          contextPhrases = ALL_SENTENCES.filter(s => s.tags?.includes('work'));
        } else {
          greeting = 'Buenas noches üåô';
          activity = 'Rel√°jate con pr√°ctica suave';
          contextPhrases = ALL_SENTENCES.filter(s => s.tags?.includes('evening'));
        }
        
        // Weekend special
        if (day === 0 || day === 6) {
          activity = 'Fin de semana = pr√°ctica relajada';
          contextPhrases = ALL_SENTENCES.filter(s => s.tags?.includes('weekend'));
        }
        
        // Winter in Minnesota (Nov-Mar)
        if (month >= 10 || month <= 2) {
          contextPhrases = [...contextPhrases, ...ALL_SENTENCES.filter(s => s.tags?.includes('winter'))];
        }
        
        // If we have context-specific phrases, use them; otherwise fall back
        if (contextPhrases.length < 5) {
          contextPhrases = ALL_SENTENCES;
        }
        
        return { greeting, activity, phrases: contextPhrases };
      }
      
      // ---------------- Badge System Hook ----------------
      function useBadges(){
        const [earned, setEarned] = useLocalStorage('stacie.badges', []);
        const [sessions] = useLocalStorage('stacie.sessions', 0);
        const [streak] = useLocalStorage('stacie.streak', 0);
        const [journals] = useLocalStorage('stacie.journals', []);
        const [catGames] = useLocalStorage('stacie.catGamesPlayed', []);
        const [recordings] = useLocalStorage('stacie.recordings', []);
        const [conversations] = useLocalStorage('stacie.conversations', []);
        const [confidence] = useLocalStorage('stacie.confidenceHistory', []);
        
        function checkBadges(){
          const newBadges = [];
          BADGES.forEach(badge => {
            if(earned.includes(badge.id)) return;
            let unlocked = false;
            
            if(badge.req === 'practices' && sessions >= badge.count) unlocked = true;
            if(badge.req === 'streak' && streak >= badge.count) unlocked = true;
            if(badge.req === 'journals' && journals.length >= badge.count) unlocked = true;
            if(badge.req === 'recordings' && recordings.length >= badge.count) unlocked = true;
            if(badge.req === 'conversations' && conversations.length >= badge.count) unlocked = true;
            
            if(badge.req === 'cat_games'){
              const uniqueCats = [...new Set(catGames.map(g=>g.cat))];
              if(uniqueCats.length >= badge.count) unlocked = true;
            }
            
            if(badge.req === 'mastered'){
              const mastered = recordings.filter(r => r.passed).length;
              if(mastered >= badge.count) unlocked = true;
            }
            
            if(badge.req === 'confidence' && confidence.length > 0){
              const avg = confidence.reduce((a,b)=>a+b,0) / confidence.length;
              if(avg >= badge.count) unlocked = true;
            }
            
            if(unlocked) newBadges.push(badge.id);
          });
          
          if(newBadges.length > 0){
            setEarned(prev => [...prev, ...newBadges]);
            return newBadges;
          }
          return [];
        }
        
        return { earned, checkBadges };
      }
      
      // ---------------- Main App ----------------
      function App(){
        const [tab, setTab] = useState('hoy');
        const [level, setLevel] = useLocalStorage('stacie.level', 0);
        const [inclusive, setInclusive] = useLocalStorage('stacie.inclusive', true);
        const [darkMode, setDarkMode] = useLocalStorage('stacie.darkMode', false);
        const [streak, setStreak] = useLocalStorage('stacie.streak', 0);
        const [streakFreeze, setStreakFreeze] = useLocalStorage('stacie.streakFreeze', 1);
        const [lastDone, setLastDone] = useLocalStorage('stacie.lastDone', '');
        const [sessions, setSessions] = useLocalStorage('stacie.sessions', 0);
        const [recordings, setRecordings] = useLocalStorage('stacie.recordings', []);
        const [dailyScores, setDailyScores] = useLocalStorage('stacie.dailyScores', []);
        const [journals, setJournals] = useLocalStorage('stacie.journals', []);
        const [playlists, setPlaylists] = useLocalStorage('stacie.playlists', []);
        const [catGamesPlayed, setCatGamesPlayed] = useLocalStorage('stacie.catGamesPlayed', []);
        const [conversations, setConversations] = useLocalStorage('stacie.conversations', []);
        const [confidenceHistory, setConfidenceHistory] = useLocalStorage('stacie.confidenceHistory', []);
        const [panicMode, setPanicMode] = useState(false);
        const [loading, setLoading] = useState(false);
        const badges = useBadges();
        const [toast, setToast] = useState(null);
        
        useEffect(()=>{
          document.body.className = darkMode ? 'dark' : 'light';
        }, [darkMode]);

        function showToast(msg, cat){
          const catData = CATS[cat];
          const icon = catData ? `${catData.emoji} ${catData.name}: ` : '';
          setToast(icon + msg);
          setTimeout(()=>setToast(null), 4000);
        }

        // Auto-level progression logic
        const checkAndUpdateLevel = useCallback(() => {
          // Don't level up if already at max
          if(level >= 2) return false;

          // Analyze recent recordings (last 20 attempts)
          const recentRecordings = recordings.slice(-20);
          if(recentRecordings.length < 10) return false; // Need at least 10 attempts

          const passed = recentRecordings.filter(r => r.passed).length;
          const passRate = passed / recentRecordings.length;
          const avgConfidence = recentRecordings.reduce((sum, r) => sum + (r.confidence || 0), 0) / recentRecordings.length;

          console.log('Level check:', { level, passRate, avgConfidence, passed, total: recentRecordings.length });

          // Level up criteria:
          // Level 0 -> 1: 70% pass rate AND avg confidence >= 3.5
          // Level 1 -> 2: 80% pass rate AND avg confidence >= 4.0

          if(level === 0 && passRate >= 0.7 && avgConfidence >= 3.5){
            setLevel(1);
            showToast('¬°Nivel desbloqueado! Ahora tienes frases intermedias.', 'otis');
            return true;
          }

          if(level === 1 && passRate >= 0.8 && avgConfidence >= 4.0){
            setLevel(2);
            showToast('¬°Nivel avanzado desbloqueado! Impresionante progreso.', 'otis');
            return true;
          }

          return false;
        }, [level, recordings, setLevel, showToast]);

        // Check for level up whenever recordings change
        useEffect(()=>{
          if(recordings.length > 0 && recordings.length % 5 === 0){
            // Check every 5 recordings to avoid too frequent checks
            checkAndUpdateLevel();
          }
        }, [recordings.length, checkAndUpdateLevel]);

        function saveWithToast(msg){
          setLoading(true);
          setTimeout(()=>{
            setLoading(false);
            showToast(msg, 'doom');
          }, 500);
        }

function completeSession(){
  try {
    const today = todayISO();

    // Debug logging
    console.log('Completing session:', { today, lastDone, streak });

    // Track daily progress
    const todayScore = {
      date: today,
      phrasesAttempted: recordings.filter(r => {
        const recDate = new Date(r.timestamp).toISOString().slice(0,10);
        return recDate === today;
      }).length,
      timestamp: Date.now()
    };

    setDailyScores(prev => {
      const filtered = prev.filter(s => s.date !== today);
      return [...filtered, todayScore];
    });

    if(lastDone !== today){
      if(lastDone === ydayISO()) {
        setStreak(prev => {
          const newStreak = prev + 1;
          console.log('Incrementing streak to:', newStreak);
          return newStreak;
        });
        showToast('¬°Streak vivo!', 'doom');
      } else if (streakFreeze > 0) {
        setStreakFreeze(prev => prev - 1);
        showToast(`Usaste un freeze. Quedan ${streakFreeze-1}.`, 'jules');
      } else {
        setStreak(1);
        showToast('Streak reiniciado. Poquito pero diario.', 'lassie');
      }
      setLastDone(today);
    }

    setSessions(prev => prev + 1);

    // Check for level up
    const leveledUp = checkAndUpdateLevel();

    // Check badges with error handling
    try {
      const newBadges = badges.checkBadges();
      if(newBadges && newBadges.length > 0){
        const badge = BADGES.find(b => b.id === newBadges[0]);
        if(badge) {
          showToast(`¬°Nueva insignia! ${badge.emoji} ${badge.name}`, 'jules');
        }
      }
    } catch(e) {
      console.error('Badge check error:', e);
    }

    if(!leveledUp){
      showToast('Sesi√≥n guardada', 'doom');
    }
  } catch(error) {
    console.error('Error completing session:', error);
    showToast('Error al guardar', 'otis');
  }
}
        
        return (
          <div className="min-h-screen">
            {loading && (
              <div className="fixed top-20 left-1/2 transform -translate-x-1/2 z-50">
                <div className="bg-white dark:bg-gray-800 px-4 py-2 rounded-xl shadow-lg">
                  <span className="loading inline-block">ü´ì</span>
                  <span className="ml-2">Calentando...</span>
                </div>
              </div>
            )}
            
            {toast && (
              <div className="fixed top-4 left-4 right-4 z-50 toast">
                <div className="bg-brand-900 text-white px-4 py-3 rounded-xl shadow-lg text-center max-w-md mx-auto">
                  {toast}
                </div>
              </div>
            )}
            
            {panicMode && (
              <PanicOverlay onClose={()=>setPanicMode(false)} />
            )}
            
            <header className="bg-white dark:bg-gray-900 border-b border-brand-200 dark:border-gray-700 px-4 py-3 sticky top-0 z-40 shadow-sm">
              <div className="max-w-md mx-auto flex items-center justify-between">
                <h1 className="text-xl font-bold text-brand-900 dark:text-gray-100">
                  stacie <span className="text-xs text-blossom-600">v7</span>
                </h1>
                <div className="flex items-center gap-2">
                  <button 
                    onClick={()=>setPanicMode(true)}
                    className="px-2 py-1 bg-rose-500 text-white rounded-lg text-xs font-bold"
                  >
                    ¬°P√ÅNICO!
                  </button>
                  <div className="text-brand-900 dark:text-gray-100 font-semibold">üî• {streak}</div>
                  {streakFreeze > 0 && (
                    <div className="text-xs bg-brand-100 dark:bg-gray-700 px-2 py-1 rounded-full">
                      ‚ùÑÔ∏è {streakFreeze}
                    </div>
                  )}
                </div>
              </div>
            </header>
            
            <div className="main-content">
              <div className="max-w-md mx-auto px-4 py-4">
                {tab === 'hoy' && <HoyTab 
                  level={level} 
                  inclusive={inclusive} 
                  onComplete={completeSession} 
                  onNavigate={setTab} 
                  showToast={showToast}
                  confidenceHistory={confidenceHistory}
                />}
                {tab === 'practica' && <PracticaTab 
                  level={level} 
                  inclusive={inclusive} 
                  recordings={recordings} 
                  setRecordings={setRecordings} 
                  playlists={playlists} 
                  setPlaylists={setPlaylists}
                  confidenceHistory={confidenceHistory}
                  setConfidenceHistory={setConfidenceHistory}
                  onComplete={completeSession} 
                  showToast={showToast} 
                />}
                {tab === 'conversar' && <ConversarTab
                  conversations={conversations}
                  setConversations={setConversations}
                  confidenceHistory={confidenceHistory}
                  setConfidenceHistory={setConfidenceHistory}
                  showToast={showToast}
                />}
                {tab === 'gatos' && <GatosTab 
                  catGamesPlayed={catGamesPlayed} 
                  setCatGamesPlayed={setCatGamesPlayed} 
                  showToast={showToast} 
                  badges={badges} 
                />}
                {tab === 'stats' && <StatsTab 
                  sessions={sessions} 
                  streak={streak} 
                  badges={badges} 
                  recordings={recordings}
                  confidenceHistory={confidenceHistory}
                  conversations={conversations}
                />}
                {tab === 'mas' && <MasTab
                  level={level}
                  setLevel={setLevel}
                  inclusive={inclusive}
                  setInclusive={setInclusive}
                  darkMode={darkMode}
                  setDarkMode={setDarkMode}
                  journals={journals}
                  setJournals={setJournals}
                  recordings={recordings}
                  showToast={showToast}
                />}
              </div>
            </div>
            
            <div className="tab-bar">
              <div className="max-w-md mx-auto flex items-center justify-around py-2">
                <TabButton icon="üè†" label="Hoy" active={tab==='hoy'} onClick={()=>setTab('hoy')} />
                <TabButton icon="üìö" label="Pr√°ctica" active={tab==='practica'} onClick={()=>setTab('practica')} />
                <TabButton icon="üí¨" label="Conversar" active={tab==='conversar'} onClick={()=>setTab('conversar')} />
                <TabButton icon="üê±" label="Gatos" active={tab==='gatos'} onClick={()=>setTab('gatos')} />
                <TabButton icon="üìä" label="Stats" active={tab==='stats'} onClick={()=>setTab('stats')} />
                <TabButton icon="‚öôÔ∏è" label="M√°s" active={tab==='mas'} onClick={()=>setTab('mas')} />
              </div>
            </div>
          </div>
        );
      }
      
      function TabButton({ icon, label, active, onClick }){
        return (
          <button onClick={onClick} className={cx('flex flex-col items-center gap-1 px-3 py-2 rounded-lg transition-colors', active ? 'text-brand-900 dark:text-gray-100' : 'text-gray-400')}>
            <span className="text-xl">{icon}</span>
            <span className="text-xs font-medium">{label}</span>
          </button>
        );
      }
      
      // ---------------- PANIC OVERLAY (NEW) ----------------
      function PanicOverlay({ onClose }){
        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-sm w-full max-h-[80vh] overflow-y-auto">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">
                üÜò Frases de emergencia
              </h2>
              <div className="space-y-3">
                {PANIC_PHRASES.map((phrase, idx) => (
                  <div key={idx} className="bg-brand-50 dark:bg-gray-700 rounded-xl p-3">
                    <p className="text-brand-900 dark:text-gray-100 font-medium">{phrase.es}</p>
                    <p className="text-sm text-brand-700 dark:text-gray-400">{phrase.hint}</p>
                    <button 
                      onClick={()=>speak(phrase.es, {rate:0.8})}
                      className="text-xs text-blossom-600 mt-2"
                    >
                      üëÇ Escuchar
                    </button>
                  </div>
                ))}
              </div>
              <button 
                onClick={onClose}
                className="w-full mt-4 py-2 bg-brand-900 text-white rounded-xl font-semibold"
              >
                Cerrar
              </button>
            </div>
          </div>
        );
      }
      
      // ---------------- HOY TAB with Context ----------------
      function HoyTab({ level, inclusive, onComplete, onNavigate, showToast, confidenceHistory }){
        const context = getContextualContent();
        const sentences = context.phrases.filter(s => s.lvl <= level);
        const dailyPhrase = sentences[Math.floor(Math.random() * sentences.length)];
        const encouragement = useMemo(()=>ENCOURAGEMENTS[Math.floor(Math.random()*ENCOURAGEMENTS.length)],[]);
        const lunchCard = useMemo(()=>LUNCH_CARDS[Math.floor(Math.random()*LUNCH_CARDS.length)],[]);
        
        // Calculate average confidence
        const avgConfidence = confidenceHistory.length > 0 
          ? (confidenceHistory.reduce((a,b)=>a+b,0) / confidenceHistory.length).toFixed(1)
          : 0;
        
        return (
          <div className="space-y-4">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-2">{context.greeting}</h2>
              <p className="text-brand-700 dark:text-gray-300 mb-1">{context.activity}</p>
              <p className="text-sm text-brand-700 dark:text-gray-300 mb-3">Meta: 3 frases con confianza</p>
              
              {avgConfidence > 0 && (
                <div className="mb-3">
                  <div className="flex justify-between text-xs text-brand-700 dark:text-gray-400 mb-1">
                    <span>Tu confianza</span>
                    <span>{avgConfidence}/5</span>
                  </div>
                  <div className="confidence-bar">
                    <div className="confidence-marker" style={{left: `${(avgConfidence/5)*100}%`}}></div>
                  </div>
                </div>
              )}
              
              <button onClick={onComplete} className="w-full py-2 rounded-xl bg-brand-900 text-white font-semibold">
                Empezar pr√°ctica diaria ‚Üí
              </button>
            </div>
            
            <div>
              <h2 className="text-sm font-semibold text-brand-800 dark:text-gray-300 mb-3">Acciones r√°pidas</h2>
              <div className="grid grid-cols-3 gap-3">
                <QuickAction icon="‚ö°" label="Pr√°ctica r√°pida" onClick={()=>onNavigate('practica')} />
                <QuickAction icon="üí¨" label="Conversaci√≥n" onClick={()=>onNavigate('conversar')} />
                <QuickAction icon="üîç" label="Buscar frase" onClick={()=>onNavigate('practica')} />
              </div>
            </div>
            
            {dailyPhrase && (
              <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
                <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-2">Frase del d√≠a</h3>
                <p className="text-lg text-brand-900 dark:text-gray-100 mb-1">{flex(dailyPhrase.es, inclusive)}</p>
                <p className="text-sm text-brand-700 dark:text-gray-400 mb-3">{dailyPhrase.hint}</p>
                <div className="flex gap-2">
                  <button onClick={()=>speak(flex(dailyPhrase.es, inclusive))} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                    üëÇ Normal
                  </button>
                  <button onClick={()=>speak(flex(dailyPhrase.es, inclusive), {rate:0.75})} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                    üê¢ Lento
                  </button>
                </div>
              </div>
            )}
            
            <div className="bg-gradient-to-br from-pink-100 to-purple-100 dark:from-pink-900 dark:to-purple-900 rounded-2xl p-4">
              <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-2">üíï Lunch Card para hoy</h3>
              <p className="text-brand-900 dark:text-gray-200 mb-2">{lunchCard.es}</p>
              <p className="text-sm text-brand-800 dark:text-gray-300 italic">{lunchCard.en}</p>
              <button 
                onClick={()=>{
                  navigator.clipboard.writeText(lunchCard.es);
                  showToast('Copiado!', 'mia');
                }}
                className="text-xs text-brand-700 dark:text-gray-400 mt-2"
              >
                üìã Copiar
              </button>
            </div>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
              <div className="flex items-center gap-2 mb-2">
                <span className="text-2xl">{CATS[encouragement.cat].emoji}</span>
                <span className="font-semibold text-brand-900 dark:text-gray-100">{CATS[encouragement.cat].name}</span>
              </div>
              <p className="text-sm text-brand-700 dark:text-gray-300">{flex(encouragement.text, inclusive)}</p>
            </div>
          </div>
        );
      }
      
      function QuickAction({ icon, label, onClick }){
        return (
          <button onClick={onClick} className="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-soft border border-brand-200 dark:border-gray-700 flex flex-col items-center gap-2 hover:bg-brand-50 dark:hover:bg-gray-700 transition-colors">
            <span className="text-3xl">{icon}</span>
            <span className="text-xs font-medium text-brand-900 dark:text-gray-100 text-center">{label}</span>
          </button>
        );
      }
      
      // ---------------- CONVERSAR TAB (NEW) ----------------
      function ConversarTab({ conversations, setConversations, confidenceHistory, setConfidenceHistory, showToast }){
        const [selectedConvo, setSelectedConvo] = useState(null);
        const [currentNode, setCurrentNode] = useState(null);
        const [history, setHistory] = useState([]);
        
        if(!selectedConvo){
          return (
            <div className="space-y-4">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Conversaciones</h2>
              
              <div className="space-y-3">
                {Object.entries(CONVERSATIONS).map(([key, convo]) => (
                  <button
                    key={key}
                    onClick={()=>{
                      setSelectedConvo(key);
                      setCurrentNode(convo.start);
                      setHistory([]);
                    }}
                    className="w-full bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft border border-brand-200 dark:border-gray-700 text-left hover:bg-brand-50 dark:hover:bg-gray-700"
                  >
                    <h3 className="font-semibold text-brand-900 dark:text-gray-100">{convo.name}</h3>
                    <p className="text-sm text-brand-700 dark:text-gray-400 mt-1">
                      Practica conversaci√≥n realista
                    </p>
                  </button>
                ))}
              </div>
              
              <div className="bg-gradient-to-br from-purple-100 to-blue-100 dark:from-purple-900 dark:to-blue-900 rounded-2xl p-4">
                <p className="text-sm text-brand-900 dark:text-gray-100">
                  üí° Tip: Las conversaciones te ayudan a practicar intercambios completos, no solo frases sueltas.
                </p>
              </div>
            </div>
          );
        }
        
        const convo = CONVERSATIONS[selectedConvo];
        
        function handleResponse(response){
          setHistory([...history, { them: currentNode.them, you: response.text }]);
          setConfidenceHistory(prev => [...prev, response.confidence]);
          
          if(convo[response.next]){
            setCurrentNode(convo[response.next]);
          } else if(convo[response.next]?.complete){
            setConversations(prev => [...prev, { 
              id: selectedConvo, 
              completed: Date.now(),
              confidence: response.confidence 
            }]);
            showToast(convo[response.next].feedback, 'mia');
            setSelectedConvo(null);
          }
        }
        
        if(currentNode?.complete){
          return (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üéâ</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-2">¬°Conversaci√≥n completa!</h2>
              <p className="text-brand-700 dark:text-gray-300 mb-4">{currentNode.feedback}</p>
              <button 
                onClick={()=>setSelectedConvo(null)}
                className="px-4 py-2 rounded-xl bg-brand-900 text-white"
              >
                Volver
              </button>
            </div>
          );
        }
        
        return (
          <div>
            <button 
              onClick={()=>setSelectedConvo(null)}
              className="text-brand-700 dark:text-gray-400 mb-4"
            >
              ‚Üê Atr√°s
            </button>
            
            <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-4">{convo.name}</h3>
            
            <div className="space-y-3 mb-4 max-h-64 overflow-y-auto">
              {history.map((exchange, idx) => (
                <div key={idx} className="space-y-2">
                  <div className="bg-gray-100 dark:bg-gray-700 rounded-2xl p-3 mr-12">
                    <p className="text-sm text-brand-900 dark:text-gray-100">{exchange.them}</p>
                  </div>
                  <div className="bg-brand-600 text-white rounded-2xl p-3 ml-12">
                    <p className="text-sm">{exchange.you}</p>
                  </div>
                </div>
              ))}
              
              {currentNode && (
                <div className="conversation-bubble bg-gray-100 dark:bg-gray-700 rounded-2xl p-3 mr-12">
                  <p className="text-sm text-brand-900 dark:text-gray-100">{currentNode.them}</p>
                </div>
              )}
            </div>
            
            {currentNode && (
              <div className="space-y-2">
                <p className="text-sm text-brand-700 dark:text-gray-400 mb-2">Elige tu respuesta:</p>
                {currentNode.responses.map((response, idx) => (
                  <button
                    key={idx}
                    onClick={()=>handleResponse(response)}
                    className="w-full text-left bg-white dark:bg-gray-800 rounded-xl p-3 border border-brand-200 dark:border-gray-700 hover:bg-brand-50 dark:hover:bg-gray-700"
                  >
                    <p className="text-brand-900 dark:text-gray-100">{response.text}</p>
                    <div className="flex items-center gap-2 mt-2">
                      <span className="text-xs text-brand-700 dark:text-gray-400">Confianza:</span>
                      <div className="flex gap-1">
                        {[1,2,3,4,5].map(n => (
                          <span key={n} className={n <= response.confidence ? 'text-amber-500' : 'text-gray-300'}>
                            ‚òÖ
                          </span>
                        ))}
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            )}
          </div>
        );
      }
      
     /* START: Enhanced PracticaTab with all features */
      // ---------------- PRACTICA TAB with Everything ----------------
      function PracticaTab({ level, inclusive, recordings, setRecordings, playlists, setPlaylists, confidenceHistory, setConfidenceHistory, onComplete, showToast }){
        const [mode, setMode] = useState(null); // 'quick', 'structured', 'search', 'playlist', 'library', 'suegros'
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedTrack, setSelectedTrack] = useState(null);
        
        if(!mode){
          return (
            <div className="space-y-3">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">¬øQu√© quieres practicar?</h2>
              
              <div className="grid grid-cols-2 gap-3">
                <ModeCard icon="‚ö°" title="R√°pido" desc="1 frase, ahora" onClick={()=>setMode('quick')} />
                <ModeCard icon="üìñ" title="Estructurado" desc="Sesi√≥n completa" onClick={()=>setMode('structured')} />
                <ModeCard icon="üë¥" title="Suegros Mode" desc="Pr√°ctica formal" onClick={()=>setMode('suegros')} color="bg-purple-100 dark:bg-purple-900" />
                <ModeCard icon="üéµ" title="Playlist" desc="Tu colecci√≥n" onClick={()=>setMode('playlist')} />
                <ModeCard icon="üîç" title="Buscar" desc="Encuentra frases" onClick={()=>setMode('search')} />
                <ModeCard icon="üìº" title="Biblioteca" desc="Tus grabaciones" onClick={()=>setMode('library')} color="bg-emerald-100 dark:bg-emerald-900" />
              </div>
              
              <div className="bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900 dark:to-purple-900 rounded-2xl p-4">
                <p className="text-sm text-brand-900 dark:text-gray-100">
                  üí° Nuevo: Graba tu confianza despu√©s de cada frase para ver tu progreso emocional
                </p>
              </div>
            </div>
          );
        }
        
        if(mode === 'search'){
          return <SearchMode searchTerm={searchTerm} setSearchTerm={setSearchTerm} level={level} inclusive={inclusive} onBack={()=>setMode(null)} showToast={showToast} />;
        }
        
        if(mode === 'playlist'){
          return <PlaylistMode playlists={playlists} setPlaylists={setPlaylists} level={level} inclusive={inclusive} recordings={recordings} setRecordings={setRecordings} onBack={()=>setMode(null)} showToast={showToast} />;
        }
        
        if(mode === 'library'){
          return <RecordingLibrary recordings={recordings} inclusive={inclusive} onBack={()=>setMode(null)} showToast={showToast} />;
        }
        
        if(mode === 'suegros'){
          return <SuegrosMode level={level} inclusive={inclusive} recordings={recordings} setRecordings={setRecordings} confidenceHistory={confidenceHistory} setConfidenceHistory={setConfidenceHistory} onBack={()=>setMode(null)} onComplete={onComplete} showToast={showToast} />;
        }
        
        if(mode === 'quick' || mode === 'structured'){
          return <PracticeMode mode={mode} level={level} inclusive={inclusive} recordings={recordings} setRecordings={setRecordings} confidenceHistory={confidenceHistory} setConfidenceHistory={setConfidenceHistory} selectedTrack={selectedTrack} setSelectedTrack={setSelectedTrack} onBack={()=>setMode(null)} onComplete={onComplete} showToast={showToast} />;
        }
        
        return null;
      }
      
      function ModeCard({ icon, title, desc, onClick, color }){
        return (
          <button onClick={onClick} className={cx("rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700 text-left hover:scale-105 transition-transform", color || "bg-white dark:bg-gray-800")}>
            <div className="text-4xl mb-2">{icon}</div>
            <h3 className="font-bold text-brand-900 dark:text-gray-100 mb-1">{title}</h3>
            <p className="text-xs text-brand-700 dark:text-gray-400">{desc}</p>
          </button>
        );
      }
      
      // Enhanced Search with tags
      function SearchMode({ searchTerm, setSearchTerm, level, inclusive, onBack, showToast }){
        const results = ALL_SENTENCES.filter(s => 
          s.lvl <= level && (
            s.es.toLowerCase().includes(searchTerm.toLowerCase()) ||
            s.hint.toLowerCase().includes(searchTerm.toLowerCase()) ||
            s.tags?.some(t => t.includes(searchTerm.toLowerCase()))
          )
        );
        
        // Popular tags for quick filtering
        const popularTags = ['greeting', 'work', 'mia', 'morning', 'evening', 'weekend', 'coffee', 'food', 'emotions'];
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            
            <div className="mb-4">
              <input 
                type="text"
                value={searchTerm}
                onChange={e=>setSearchTerm(e.target.value)}
                placeholder="Buscar... (ej: 'greeting', 'mia', 'caf√©')"
                className="w-full px-4 py-3 rounded-xl border border-brand-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-brand-900 dark:text-gray-100"
              />
            </div>
            
            <div className="flex flex-wrap gap-2 mb-4">
              {popularTags.map(tag => (
                <button
                  key={tag}
                  onClick={()=>setSearchTerm(tag)}
                  className="px-3 py-1 rounded-full bg-brand-100 dark:bg-gray-700 text-xs text-brand-900 dark:text-gray-100"
                >
                  #{tag}
                </button>
              ))}
            </div>
            
            {searchTerm && (
              <div className="space-y-2">
                <p className="text-sm text-brand-700 dark:text-gray-400">{results.length} resultados</p>
                {results.slice(0,20).map(phrase => (
                  <div key={phrase.id} className="bg-white dark:bg-gray-800 rounded-xl p-3 shadow-soft border border-brand-200 dark:border-gray-700">
                    <p className="text-brand-900 dark:text-gray-100 mb-1">{flex(phrase.es, inclusive)}</p>
                    <p className="text-xs text-brand-700 dark:text-gray-400">{phrase.hint}</p>
                    <div className="flex items-center gap-2 mt-2">
                      <button onClick={()=>{speak(flex(phrase.es, inclusive)); showToast('Reproduciendo', 'lassie');}} className="text-xs text-blossom-600">
                        üëÇ Normal
                      </button>
                      <button onClick={()=>{speak(flex(phrase.es, inclusive), {rate:0.75}); showToast('Lento', 'lassie');}} className="text-xs text-blossom-600">
                        üê¢ Lento
                      </button>
                      {phrase.tags && (
                        <span className="text-xs text-gray-500">
                          {phrase.tags.map(t => `#${t}`).join(' ')}
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }
      
      // Recording Library (NEW)
      function RecordingLibrary({ recordings, inclusive, onBack, showToast }){
        const [filter, setFilter] = useState('all'); // 'all', 'passed', 'failed', 'recent'
        
        const filtered = recordings.filter(r => {
          if(filter === 'passed') return r.passed;
          if(filter === 'failed') return !r.passed;
          if(filter === 'recent') return Date.now() - r.timestamp < 7*24*60*60*1000;
          return true;
        }).slice(-50).reverse(); // Show last 50, newest first
        
        // Group by phrase for comparison
        const groupedByPhrase = {};
        recordings.forEach(r => {
          if(!groupedByPhrase[r.target]) groupedByPhrase[r.target] = [];
          groupedByPhrase[r.target].push(r);
        });
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Tu biblioteca de grabaciones</h2>
            
            <div className="flex gap-2 mb-4">
              {['all', 'passed', 'failed', 'recent'].map(f => (
                <button
                  key={f}
                  onClick={()=>setFilter(f)}
                  className={cx('px-3 py-1 rounded-lg text-sm', 
                    filter === f ? 'bg-brand-900 text-white' : 'bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100'
                  )}
                >
                  {f === 'all' ? 'Todas' : f === 'passed' ? '‚úì Correctas' : f === 'failed' ? '‚úó Practicar' : 'üïê Recientes'}
                </button>
              ))}
            </div>
            
            {filtered.length === 0 ? (
              <p className="text-center text-brand-700 dark:text-gray-400 py-8">No hay grabaciones {filter !== 'all' && `(${filter})`}</p>
            ) : (
              <div className="space-y-2">
                {filtered.map((rec, idx) => (
                  <div key={idx} className={cx('rounded-xl p-3 border', 
                    rec.passed ? 'bg-emerald-50 dark:bg-emerald-900 border-emerald-200 dark:border-emerald-700' : 'bg-amber-50 dark:bg-amber-900 border-amber-200 dark:border-amber-700'
                  )}>
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <p className="text-sm text-brand-900 dark:text-gray-100 font-medium">{rec.target}</p>
                        <p className="text-xs text-brand-700 dark:text-gray-400">Tu respuesta: {rec.transcript}</p>
                        {rec.confidence && (
                          <p className="text-xs text-brand-700 dark:text-gray-400 mt-1">
                            Confianza: {'‚≠ê'.repeat(rec.confidence)}
                          </p>
                        )}
                      </div>
                      <div className="text-xs text-gray-500">
                        {new Date(rec.timestamp).toLocaleDateString('es-MX')}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
            
            {Object.keys(groupedByPhrase).length > 0 && (
              <div className="mt-6 bg-gradient-to-br from-blue-100 to-green-100 dark:from-blue-900 dark:to-green-900 rounded-2xl p-4">
                <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-2">üìà Tu progreso</h3>
                <p className="text-sm text-brand-900 dark:text-gray-200">
                  Has practicado {Object.keys(groupedByPhrase).length} frases diferentes.
                  {Object.values(groupedByPhrase).filter(attempts => attempts.some(a => a.passed)).length} dominadas.
                </p>
              </div>
            )}
          </div>
        );
      }
      
      // Suegros Mode (NEW)
      function SuegrosMode({ level, inclusive, recordings, setRecordings, confidenceHistory, setConfidenceHistory, onBack, onComplete, showToast }){
        const suegrosContent = [...SENTENCES.suegros, ...SENTENCES.family].filter(s => s.lvl <= level);
        const practice = useMemo(()=>suegrosContent.sort(()=>0.5-Math.random()).slice(0,5),[]);
        const [idx, setIdx] = useState(0);
        const [recording, setRecording] = useState(false);
        const [transcript, setTranscript] = useState('');
        const [result, setResult] = useState(null);
        const [confidence, setConfidence] = useState(0);
        const rec = useSpeechRecognition({ onResult:(t)=>setTranscript(t), onEnd:()=>setRecording(false) });
        
        const phrase = practice[idx];
        const done = idx >= practice.length;
        
        if(done){
          onComplete();
          return (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üë¥üëµ</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-4">¬°Listo para los suegros!</h2>
              <p className="text-brand-700 dark:text-gray-300 mb-4">Practicaste frases formales y respetuosas.</p>
              <button onClick={onBack} className="px-4 py-2 rounded-xl bg-brand-900 text-white">Salir</button>
            </div>
          );
        }
        
        function handleRecord(){
          if(!rec.supported) return;
          if(!recording){ setTranscript(''); setResult(null); rec.start(); setRecording(true); }
          else {
            rec.stop();
            const { pass } = wordScore(flex(phrase.es, inclusive), transcript);
            setResult(pass);
          }
        }
        
        function saveAndNext(){
          if(confidence > 0){
            setConfidenceHistory(prev => [...prev, confidence]);
            setRecordings(prev => [...prev, { 
              transcript, 
              target: phrase.es, 
              passed: result, 
              confidence,
              timestamp: Date.now(),
              phraseId: phrase.id,
              track: 'suegros'
            }]);
            showToast(confidence >= 4 ? 'Con confianza!' : 'Sigue practicando', confidence >= 4 ? 'doom' : 'jules');
          }
          
          setIdx(i=>i+1);
          setTranscript('');
          setResult(null);
          setConfidence(0);
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            
            <div className="bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900 dark:to-pink-900 rounded-2xl p-4 mb-4">
              <h3 className="font-semibold text-brand-900 dark:text-gray-100">üë¥üëµ Modo Suegros</h3>
              <p className="text-sm text-brand-800 dark:text-gray-200">Practica frases formales y respetuosas</p>
            </div>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft border border-brand-200 dark:border-gray-700">
              <div className="text-xs text-brand-700 dark:text-gray-400 mb-2">{idx+1} / {practice.length}</div>
              <p className="text-xl text-brand-900 dark:text-gray-100 mb-2">{flex(phrase.es, inclusive)}</p>
              <p className="text-sm text-brand-700 dark:text-gray-400 mb-4">{phrase.hint}</p>
              
              <div className="flex gap-2 mb-4">
                <button onClick={()=>speak(flex(phrase.es, inclusive), {rate:0.75})} className="px-3 py-2 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                  üê¢ Lento
                </button>
                <button onClick={()=>speak(flex(phrase.es, inclusive))} className="px-3 py-2 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                  üëÇ Normal
                </button>
                <button onClick={handleRecord} className={cx('flex-1 py-2 rounded-xl text-white', recording?'bg-rose-600 recording-pulse':'bg-brand-900')}>
                  {recording ? '‚èπ Detener' : 'üé§ Grabar'}
                </button>
              </div>
              
              {transcript && (
                <div className="p-3 bg-brand-50 dark:bg-gray-700 rounded-lg mb-3">
                  <div className="text-xs text-brand-700 dark:text-gray-400 mb-1">Tu respuesta:</div>
                  <div className="text-sm text-brand-900 dark:text-gray-100">{transcript}</div>
                </div>
              )}
              
              {result !== null && (
                <>
                  <div className={cx('p-3 rounded-xl mb-3', result?'bg-emerald-100 dark:bg-emerald-900':'bg-amber-100 dark:bg-amber-900')}>
                    {result ? '‚úì Correcto' : '‚óª Casi - intenta otra vez'}
                  </div>
                  
                  <div className="mb-4">
                    <p className="text-sm text-brand-700 dark:text-gray-400 mb-2">¬øQu√© tan seguro te sentiste?</p>
                    <div className="flex gap-2">
                      {[1,2,3,4,5].map(n => (
                        <button
                          key={n}
                          onClick={()=>setConfidence(n)}
                          className={cx('flex-1 py-2 rounded-lg text-sm',
                            confidence === n ? 'bg-brand-900 text-white' : 'bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100'
                          )}
                        >
                          {n}
                        </button>
                      ))}
                    </div>
                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                      <span>Nada</span>
                      <span>Muy seguro</span>
                    </div>
                  </div>
                </>
              )}
              
              <button onClick={saveAndNext} disabled={!confidence} className="w-full py-2 rounded-xl bg-brand-900 text-white disabled:opacity-50">
                Siguiente ‚Üí
              </button>
            </div>
          </div>
        );
      }
      
      // Enhanced Practice Mode with track selection and confidence
      function PracticeMode({ mode, level, inclusive, recordings, setRecordings, confidenceHistory, setConfidenceHistory, selectedTrack, setSelectedTrack, onBack, onComplete, showToast }){
        // Track selection first
        if(!selectedTrack && mode === 'structured'){
          return (
            <div>
              <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
              <h3 className="text-lg font-semibold text-brand-900 dark:text-gray-100 mb-4">Elige un tema</h3>
              <div className="space-y-2">
                {TRACKS.map(track => (
                  <button
                    key={track.key}
                    onClick={()=>setSelectedTrack(track.key)}
                    className={cx('w-full text-left p-4 rounded-xl border border-brand-200 dark:border-gray-700 hover:bg-brand-50 dark:hover:bg-gray-700', track.color)}
                  >
                    <div className="flex items-center gap-3">
                      <span className="text-2xl">{track.icon}</span>
                      <div>
                        <h4 className="font-semibold text-brand-900 dark:text-gray-100">{track.name}</h4>
                        <p className="text-xs text-brand-700 dark:text-gray-400">
                          {SENTENCES[track.key]?.filter(s => s.lvl <= level).length || 0} frases disponibles
                        </p>
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            </div>
          );
        }
        
        const trackSentences = selectedTrack ? SENTENCES[selectedTrack] : ALL_SENTENCES;
        const sentences = trackSentences.filter(s => s.lvl <= level);
        const count = mode === 'quick' ? 1 : 5;
        const practice = useMemo(()=>sentences.sort(()=>0.5-Math.random()).slice(0,count),[selectedTrack]);
        
        const [idx, setIdx] = useState(0);
        const [recording, setRecording] = useState(false);
        const [transcript, setTranscript] = useState('');
        const [result, setResult] = useState(null);
        const [confidence, setConfidence] = useState(0);
        const rec = useSpeechRecognition({ onResult:(t)=>setTranscript(t), onEnd:()=>setRecording(false) });
        
        const phrase = practice[idx];
        const done = idx >= practice.length;
        
        if(done){
          onComplete();
          return (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üéâ</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-4">¬°De lujo!</h2>
              <button onClick={onBack} className="px-4 py-2 rounded-xl bg-brand-900 text-white">Salir</button>
            </div>
          );
        }
        
        function handleRecord(){
          if(!rec.supported) return;
          if(!recording){ setTranscript(''); setResult(null); rec.start(); setRecording(true); }
          else {
            rec.stop();
            const { pass } = wordScore(flex(phrase.es, inclusive), transcript);
            setResult(pass);
          }
        }
        
        function saveAndNext(){
          if(confidence > 0){
            setConfidenceHistory(prev => [...prev, confidence]);
          }
          
          setRecordings(prev => [...prev, { 
            transcript, 
            target: phrase.es, 
            passed: result, 
            confidence,
            timestamp: Date.now(),
            phraseId: phrase.id,
            track: selectedTrack || 'mixed'
          }]);
          
          // Dynamic encouragement based on confidence
          if(confidence >= 4){
            showToast('¬°Con mucha confianza!', 'mia');
          } else if(confidence === 3){
            showToast('Vas mejorando', 'doom');
          } else {
            showToast('Poquito a poquito', 'lassie');
          }
          
          setIdx(i=>i+1);
          setTranscript('');
          setResult(null);
          setConfidence(0);
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            
            {selectedTrack && (
              <div className="flex items-center gap-2 mb-4 text-sm text-brand-700 dark:text-gray-400">
                <span>{TRACKS.find(t => t.key === selectedTrack)?.icon}</span>
                <span>{TRACKS.find(t => t.key === selectedTrack)?.name}</span>
              </div>
            )}
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft border border-brand-200 dark:border-gray-700">
              <div className="text-xs text-brand-700 dark:text-gray-400 mb-2">{idx+1} / {practice.length}</div>
              <p className="text-xl text-brand-900 dark:text-gray-100 mb-2">{flex(phrase.es, inclusive)}</p>
              <p className="text-sm text-brand-700 dark:text-gray-400 mb-4">{phrase.hint}</p>
              
              <div className="flex gap-2 mb-4">
                <button onClick={()=>speak(flex(phrase.es, inclusive), {rate:0.75})} className="px-3 py-2 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                  üê¢ Lento
                </button>
                <button onClick={()=>speak(flex(phrase.es, inclusive))} className="px-3 py-2 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                  üëÇ Normal
                </button>
                <button onClick={handleRecord} className={cx('flex-1 py-2 rounded-xl text-white', recording?'bg-rose-600 recording-pulse':'bg-brand-900')}>
                  {recording ? '‚èπ Detener' : 'üé§ Grabar'}
                </button>
              </div>
              
              {transcript && (
                <div className="p-3 bg-brand-50 dark:bg-gray-700 rounded-lg mb-3">
                  <div className="text-xs text-brand-700 dark:text-gray-400 mb-1">Tu respuesta:</div>
                  <div className="text-sm text-brand-900 dark:text-gray-100">{transcript}</div>
                </div>
              )}
              
              {result !== null && (
                <>
                  <div className={cx('p-3 rounded-xl mb-3', result?'bg-emerald-100 dark:bg-emerald-900':'bg-amber-100 dark:bg-amber-900')}>
                    {result ? '‚úì Qued√≥ chido' : '‚óª Poquito m√°s'}
                  </div>
                  
                  <div className="mb-4">
                    <p className="text-sm text-brand-700 dark:text-gray-400 mb-2">¬øC√≥mo te sentiste diciendo esto?</p>
                    <div className="flex gap-2">
                      {[1,2,3,4,5].map(n => (
                        <button
                          key={n}
                          onClick={()=>setConfidence(n)}
                          className={cx('flex-1 py-3 rounded-lg',
                            confidence === n ? 'bg-brand-900 text-white' : 'bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100'
                          )}
                        >
                          <div className="text-lg">{['üò∞','üòü','üòê','üôÇ','üòä'][n-1]}</div>
                          <div className="text-xs mt-1">{n}</div>
                        </button>
                      ))}
                    </div>
                  </div>
                </>
              )}
              
              <button onClick={saveAndNext} disabled={!confidence && result !== null} className="w-full py-2 rounded-xl bg-brand-900 text-white disabled:opacity-50">
                {result === null ? 'Graba primero' : 'Siguiente ‚Üí'}
              </button>
            </div>
          </div>
        );
      }
      
      function PlaylistMode({ playlists, setPlaylists, level, inclusive, recordings, setRecordings, onBack, showToast }){
        const [creating, setCreating] = useState(false);
        const [newName, setNewName] = useState('');
        const [selectedPhrases, setSelectedPhrases] = useState([]);
        const [practicing, setPracticing] = useState(null);
        
        if(creating){
          const available = ALL_SENTENCES.filter(s => s.lvl <= level);
          
          function savePlaylist(){
            if(!newName) return;
            setPlaylists(prev => [...prev, { 
              id: Date.now(), 
              name: newName, 
              phrases: selectedPhrases, 
              created: Date.now() 
            }]);
            setCreating(false);
            setNewName('');
            setSelectedPhrases([]);
            showToast('Playlist guardado', 'doom');
          }
          
          return (
            <div>
              <button onClick={()=>setCreating(false)} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
              <input 
                type="text"
                value={newName}
                onChange={e=>setNewName(e.target.value)}
                placeholder="Nombre del playlist"
                className="w-full px-4 py-2 rounded-xl border border-brand-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-brand-900 dark:text-gray-100 mb-4"
              />
              
              <p className="text-sm text-brand-700 dark:text-gray-400 mb-2">Selecciona frases ({selectedPhrases.length})</p>
              <div className="space-y-2 mb-4 max-h-96 overflow-y-auto">
                {available.map(phrase => (
                  <button
                    key={phrase.id}
                    onClick={()=>{
                      if(selectedPhrases.includes(phrase.id)) setSelectedPhrases(prev => prev.filter(id=>id!==phrase.id));
                      else setSelectedPhrases(prev => [...prev, phrase.id]);
                    }}
                    className={cx('w-full text-left p-3 rounded-xl border', 
                      selectedPhrases.includes(phrase.id) ? 'border-brand-900 bg-brand-50 dark:bg-gray-700' : 'border-brand-200 dark:border-gray-700 bg-white dark:bg-gray-800')}
                  >
                    <p className="text-sm text-brand-900 dark:text-gray-100">{flex(phrase.es, inclusive)}</p>
                    <p className="text-xs text-brand-700 dark:text-gray-400">{phrase.hint}</p>
                  </button>
                ))}
              </div>
              
              <button onClick={savePlaylist} disabled={!newName || selectedPhrases.length===0} className="w-full py-2 rounded-xl bg-brand-900 text-white disabled:opacity-50">
                Guardar playlist
              </button>
            </div>
          );
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            
            <button onClick={()=>setCreating(true)} className="w-full py-3 rounded-xl bg-brand-900 text-white mb-4">
              + Crear playlist
            </button>
            
            {playlists.length === 0 ? (
              <p className="text-center text-brand-700 dark:text-gray-400 py-8">No hay playlists todav√≠a</p>
            ) : (
              <div className="space-y-3">
                {playlists.map((pl) => (
                  <div key={pl.id} className="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
                    <h3 className="font-semibold text-brand-900 dark:text-gray-100">{pl.name}</h3>
                    <p className="text-xs text-brand-700 dark:text-gray-400 mb-2">{pl.phrases.length} frases</p>
                    <button 
                      onClick={()=>showToast('Pr√°ctica de playlist pr√≥ximamente', 'otis')}
                      className="text-xs text-blossom-600"
                    >
                      ‚ñ∂ Practicar
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }
/* END: Enhanced PracticaTab */

/* START: All Cat Games from v6 */
      // ---------------- GATOS TAB - All 4 Games ----------------
      function GatosTab({ catGamesPlayed, setCatGamesPlayed, showToast, badges }){
        const [selectedGame, setSelectedGame] = useState(null);
        
        if(!selectedGame){
          return (
            <div className="space-y-4">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Juegos de gatos üê±</h2>
              
              <div className="grid grid-cols-2 gap-3">
                {Object.entries(CATS).filter(([k,v]) => v.game).map(([key, cat]) => (
                  <button
                    key={key}
                    onClick={()=>setSelectedGame(key)}
                    className="cat-card bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700 text-center"
                    style={{borderColor: cat.color}}
                  >
                    <div className="text-6xl mb-2">{cat.emoji}</div>
                    <h3 className="font-bold text-brand-900 dark:text-gray-100 mb-1">{cat.name}</h3>
                    <p className="text-xs text-brand-700 dark:text-gray-400">{cat.game}</p>
                    {catGamesPlayed.filter(g => g.cat === key).length > 0 && (
                      <p className="text-xs text-emerald-600 mt-2">
                        Jugado {catGamesPlayed.filter(g => g.cat === key).length}x
                      </p>
                    )}
                  </button>
                ))}
              </div>
              
              <div className="bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900 dark:to-pink-900 rounded-2xl p-4">
                <p className="text-sm text-brand-900 dark:text-gray-100">
                  üèÜ Juega con los 4 gatos para desbloquear "Gato favorito"
                </p>
                <div className="flex gap-4 mt-3">
                  {['otis','doom','jules','lassie'].map(cat => (
                    <div key={cat} className={cx('text-2xl opacity-30', 
                      catGamesPlayed.some(g => g.cat === cat) && 'opacity-100'
                    )}>
                      {CATS[cat].emoji}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );
        }
        
        if(selectedGame === 'otis') return <OtisGame onBack={()=>setSelectedGame(null)} catGamesPlayed={catGamesPlayed} setCatGamesPlayed={setCatGamesPlayed} showToast={showToast} />;
        if(selectedGame === 'doom') return <DoomGame onBack={()=>setSelectedGame(null)} catGamesPlayed={catGamesPlayed} setCatGamesPlayed={setCatGamesPlayed} showToast={showToast} />;
        if(selectedGame === 'jules') return <JulesGame onBack={()=>setSelectedGame(null)} catGamesPlayed={catGamesPlayed} setCatGamesPlayed={setCatGamesPlayed} showToast={showToast} />;
        if(selectedGame === 'lassie') return <LassieGame onBack={()=>setSelectedGame(null)} catGamesPlayed={catGamesPlayed} setCatGamesPlayed={setCatGamesPlayed} showToast={showToast} />;
        
        return null;
      }
      
      // Otis: Speed Challenge - How many phrases can you recognize in 10 seconds?
      function OtisGame({ onBack, catGamesPlayed, setCatGamesPlayed, showToast }){
        const [timeLeft, setTimeLeft] = useState(10);
        const [score, setScore] = useState(0);
        const [started, setStarted] = useState(false);
        const [phrase, setPhrase] = useState(null);
        const [highScore] = useState(() => {
          const otisGames = catGamesPlayed.filter(g => g.cat === 'otis');
          return otisGames.length > 0 ? Math.max(...otisGames.map(g => g.score || 0)) : 0;
        });
        
        useEffect(()=>{
          if(!started || timeLeft <= 0) return;
          const id = setInterval(()=>setTimeLeft(t=>t-1), 1000);
          return ()=>clearInterval(id);
        }, [started, timeLeft]);
        
        useEffect(()=>{
          if(timeLeft === 0 && started){
            setCatGamesPlayed(prev => [...prev, {cat:'otis', score, timestamp:Date.now()}]);
            const msg = score > highScore ? `¬°Nuevo r√©cord: ${score}! MIAU MIAU!` : `${score} puntos! No mal para un humano...`;
            showToast(msg, 'otis');
          }
        }, [timeLeft, started]);
        
        function start(){
          setStarted(true);
          setTimeLeft(10);
          setScore(0);
          nextPhrase();
        }
        
        function nextPhrase(){
          const p = ALL_SENTENCES[Math.floor(Math.random()*ALL_SENTENCES.length)];
          setPhrase(p);
        }
        
        function check(isCorrect){
          if(isCorrect) setScore(s=>s+1);
          nextPhrase();
        }
        
        if(!started){
          return (
            <div className="text-center py-8">
              <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
              <div className="text-8xl mb-4">üê±</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-2">Speed Challenge de Otis</h2>
              <p className="text-brand-700 dark:text-gray-300 mb-2">10 segundos. ¬øCu√°ntas frases reconoces?</p>
              {highScore > 0 && (
                <p className="text-sm text-amber-600 mb-4">Tu r√©cord: {highScore} puntos</p>
              )}
              <button onClick={start} className="px-6 py-3 rounded-xl bg-amber-600 text-white font-semibold">
                Empezar
              </button>
            </div>
          );
        }
        
        if(timeLeft === 0){
          return (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üê±</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-2">¬°Terminado!</h2>
              <p className="text-4xl font-bold text-brand-900 dark:text-gray-100 mb-2">{score} puntos</p>
              {score > highScore && (
                <p className="text-amber-600 font-semibold mb-2">üèÜ ¬°Nuevo r√©cord!</p>
              )}
              <p className="text-sm text-brand-700 dark:text-gray-400 mb-4">
                Otis dice: "{score >= 8 ? 'Impresionante... para un humano.' : score >= 5 ? 'Aceptable. Yo hubiera hecho 20.' : 'Necesitas m√°s pr√°ctica. Obvio.'}"
              </p>
              <button onClick={onBack} className="px-4 py-2 rounded-xl bg-brand-900 text-white">Salir</button>
            </div>
          );
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Salir</button>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft">
              <div className="flex justify-between mb-4">
                <div className="text-2xl font-bold">‚è±Ô∏è {timeLeft}s</div>
                <div className="text-2xl font-bold">üéØ {score}</div>
              </div>
              
              {phrase && (
                <>
                  <p className="text-xl text-brand-900 dark:text-gray-100 mb-2 text-center">{phrase.es}</p>
                  <p className="text-sm text-brand-700 dark:text-gray-400 mb-4 text-center">{phrase.hint}</p>
                  <div className="grid grid-cols-2 gap-2">
                    <button onClick={()=>check(true)} className="py-3 rounded-xl bg-emerald-600 text-white font-semibold">
                      ‚úì S√© esto
                    </button>
                    <button onClick={()=>check(false)} className="py-3 rounded-xl bg-rose-600 text-white font-semibold">
                      ‚úó No s√©
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        );
      }
      
      // Doom: Memory Match - Match Spanish phrases with their meanings
      function DoomGame({ onBack, catGamesPlayed, setCatGamesPlayed, showToast }){
        const [cards, setCards] = useState([]);
        const [flipped, setFlipped] = useState([]);
        const [matched, setMatched] = useState([]);
        const [moves, setMoves] = useState(0);
        const [bestMoves] = useState(() => {
          const doomGames = catGamesPlayed.filter(g => g.cat === 'doom');
          return doomGames.length > 0 ? Math.min(...doomGames.map(g => g.moves || 999)) : 0;
        });
        
        useEffect(()=>{
          const phrases = ALL_SENTENCES.slice(0,4);
          const cards = phrases.map(p => [
            { id: p.id + '_es', text: p.es, match: p.id, type: 'es' },
            { id: p.id + '_en', text: p.hint, match: p.id, type: 'en' }
          ]).flat();
          setCards(cards.sort(()=>0.5-Math.random()));
        }, []);
        
        function flip(idx){
          if(flipped.length === 2 || flipped.includes(idx) || matched.includes(idx)) return;
          const newFlipped = [...flipped, idx];
          setFlipped(newFlipped);
          
          if(newFlipped.length === 2){
            setMoves(m=>m+1);
            const [a,b] = newFlipped;
            if(cards[a].match === cards[b].match && cards[a].type !== cards[b].type){
              setMatched([...matched, a, b]);
              setFlipped([]);
              if(matched.length + 2 === cards.length){
                setCatGamesPlayed(prev => [...prev, {cat:'doom', moves, timestamp:Date.now()}]);
                const msg = bestMoves === 0 || moves < bestMoves 
                  ? `¬°Nuevo r√©cord: ${moves} movimientos! Te mando abrazo.` 
                  : `¬°Completado en ${moves} movimientos! Bien hecho.`;
                showToast(msg, 'doom');
              }
            } else {
              setTimeout(()=>setFlipped([]), 1000);
            }
          }
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft">
              <div className="flex justify-between mb-4">
                <h3 className="font-bold text-brand-900 dark:text-gray-100">üêà Memory de Doom</h3>
                <div className="text-sm text-brand-700 dark:text-gray-400">
                  Movimientos: {moves}
                  {bestMoves > 0 && ` (R√©cord: ${bestMoves})`}
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-2">
                {cards.map((card, idx) => (
                  <button
                    key={idx}
                    onClick={()=>flip(idx)}
                    className={cx('aspect-square rounded-xl flex items-center justify-center text-xs p-2 transition-all',
                      matched.includes(idx) ? 'bg-purple-200 dark:bg-purple-800' :
                      flipped.includes(idx) ? 'bg-purple-100 dark:bg-purple-900' :
                      'bg-brand-100 dark:bg-gray-700'
                    )}
                  >
                    {(flipped.includes(idx) || matched.includes(idx)) 
                      ? card.text 
                      : <span className="text-2xl">{card.type === 'es' ? 'üá≤üáΩ' : 'üá∫üá∏'}</span>}
                  </button>
                ))}
              </div>
              
              {matched.length === cards.length && (
                <div className="mt-4 text-center">
                  <p className="text-emerald-600 font-semibold">¬°Completado!</p>
                  <p className="text-sm text-brand-700 dark:text-gray-400">Doom dice: "Te quiero mucho"</p>
                </div>
              )}
            </div>
          </div>
        );
      }
      
      // Jules: Truth Meter - Rate your confidence honestly
      function JulesGame({ onBack, catGamesPlayed, setCatGamesPlayed, showToast }){
        const phrases = useMemo(()=>ALL_SENTENCES.sort(()=>0.5-Math.random()).slice(0,5),[]);
        const [idx, setIdx] = useState(0);
        const [ratings, setRatings] = useState([]);
        
        const phrase = phrases[idx];
        const done = idx >= phrases.length;
        
        if(done){
          setCatGamesPlayed(prev => [...prev, {cat:'jules', ratings, timestamp:Date.now()}]);
          const avg = ratings.reduce((a,b)=>a+b,0)/ratings.length;
          return (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üêæ</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-2">Evaluaci√≥n completa</h2>
              <p className="text-brand-700 dark:text-gray-300 mb-2">
                Confianza promedio: {avg.toFixed(1)}/5
              </p>
              <p className="text-sm text-brand-700 dark:text-gray-400 mb-4">
                Jules dice: "{avg >= 4 ? 'Confianza s√≥lida. Respeto.' : avg >= 3 ? 'Vas bien. Sigue trabajando.' : 'Necesitas m√°s pr√°ctica. Es obvio.'}"
              </p>
              <button onClick={onBack} className="px-4 py-2 rounded-xl bg-brand-900 text-white">Salir</button>
            </div>
          );
        }
        
        function rate(score){
          setRatings([...ratings, score]);
          setIdx(i=>i+1);
          speak(phrase.es);
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft">
              <div className="text-center mb-4">
                <div className="text-6xl mb-2">üêæ</div>
                <h3 className="font-bold text-brand-900 dark:text-gray-100">Jules Truth Meter</h3>
                <p className="text-xs text-brand-700 dark:text-gray-400">{idx+1} / {phrases.length}</p>
              </div>
              
              <p className="text-lg text-brand-900 dark:text-gray-100 text-center mb-2">{phrase.es}</p>
              <p className="text-sm text-brand-700 dark:text-gray-400 text-center mb-6">¬øQu√© tan segure te sientes diciendo esto?</p>
              
              <div className="space-y-2">
                {[1,2,3,4,5].map(n=>(
                  <button key={n} onClick={()=>rate(n)} className="w-full py-3 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 hover:bg-brand-200 dark:hover:bg-gray-600 transition-colors">
                    <div className="flex items-center justify-center gap-2">
                      <span>{'‚≠ê'.repeat(n)}</span>
                      <span className="text-sm">
                        {n === 1 ? 'No entiendo nada' : 
                         n === 2 ? 'Muy insegure' :
                         n === 3 ? 'Algo segure' :
                         n === 4 ? 'Bastante segure' :
                         'S√∫per segure'}
                      </span>
                    </div>
                  </button>
                ))}
              </div>
            </div>
          </div>
        );
      }
      
      // Lassie: Phrase Collector - Find the right translation
      function LassieGame({ onBack, catGamesPlayed, setCatGamesPlayed, showToast }){
        const [round, setRound] = useState(0);
        const [score, setScore] = useState(0);
        const [target, setTarget] = useState(null);
        const [options, setOptions] = useState([]);
        const totalRounds = 5;
        
        useEffect(()=>{
          if(round < totalRounds){
            const t = ALL_SENTENCES[Math.floor(Math.random()*ALL_SENTENCES.length)];
            const others = ALL_SENTENCES.filter(p=>p.id!==t.id).sort(()=>0.5-Math.random()).slice(0,3);
            setTarget(t);
            setOptions([...others, t].sort(()=>0.5-Math.random()));
          } else {
            setCatGamesPlayed(prev => [...prev, {cat:'lassie', score, timestamp:Date.now()}]);
            const msg = score === totalRounds ? '¬°Perfecto! Te protejo siempre.' : `${score}/${totalRounds} correctas. Sigo aqu√≠ para ti.`;
            showToast(msg, 'lassie');
          }
        }, [round]);
        
        function select(phrase){
          if(phrase.id === target.id){
            setScore(s=>s+1);
            showToast('¬°Correcto!', 'lassie');
          } else {
            showToast('No es esa, pero est√° bien', 'lassie');
          }
          setRound(r=>r+1);
        }
        
        if(round >= totalRounds){
          return (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üò∏</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-2">¬°Terminado!</h2>
              <p className="text-3xl font-bold text-brand-900 dark:text-gray-100 mb-2">{score}/{totalRounds}</p>
              <p className="text-sm text-brand-700 dark:text-gray-400 mb-4">
                Lassie dice: "{score === totalRounds ? 'Perfecto. Siempre te cuido.' : score >= 3 ? 'Bien hecho. Aqu√≠ estoy.' : 'Practica m√°s. Te apoyo.'}"
              </p>
              <button onClick={onBack} className="px-4 py-2 rounded-xl bg-brand-900 text-white">Salir</button>
            </div>
          );
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft">
              <div className="text-center mb-4">
                <div className="text-6xl mb-2">üò∏</div>
                <h3 className="font-bold text-brand-900 dark:text-gray-100">Lassie Phrase Collector</h3>
                <p className="text-sm text-brand-700 dark:text-gray-400">Ronda {round+1}/{totalRounds} ‚Ä¢ Puntos: {score}</p>
              </div>
              
              {target && (
                <>
                  <p className="text-center text-brand-700 dark:text-gray-300 mb-2">Encuentra la traducci√≥n:</p>
                  <div className="bg-emerald-100 dark:bg-emerald-900 rounded-xl p-3 mb-6">
                    <p className="text-lg text-center text-brand-900 dark:text-gray-100 font-semibold">{target.hint}</p>
                  </div>
                  
                  <div className="space-y-2">
                    {options.map((p,i)=>(
                      <button key={i} onClick={()=>select(p)} className="w-full text-left py-3 px-4 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 hover:bg-brand-200 dark:hover:bg-gray-600 transition-colors">
                        {p.es}
                      </button>
                    ))}
                  </div>
                </>
              )}
            </div>
          </div>
        );
      }
/* END: All Cat Games */

/* START: Enhanced StatsTab with confidence tracking */
      // ---------------- STATS TAB with Everything ----------------
      function StatsTab({ sessions, streak, badges, recordings, confidenceHistory, conversations }){
        const [view, setView] = useState('overview'); // 'overview', 'confidence', 'tracks', 'timeline'
        
        // Calculate stats
        const totalPhrases = recordings.length;
        const passedPhrases = recordings.filter(r => r.passed).length;
        const successRate = totalPhrases > 0 ? Math.round((passedPhrases/totalPhrases)*100) : 0;
        
        const avgConfidence = confidenceHistory.length > 0 
          ? (confidenceHistory.reduce((a,b)=>a+b,0) / confidenceHistory.length).toFixed(1)
          : 0;
        
        const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
        const thisWeek = recordings.filter(r => r.timestamp >= weekAgo);
        const thisWeekRate = thisWeek.length ? Math.round((thisWeek.filter(r=>r.passed).length / thisWeek.length)*100) : 0;
        
        // Track breakdown
        const trackStats = {};
        TRACKS.forEach(track => {
          const trackRecs = recordings.filter(r => r.track === track.key);
          const passed = trackRecs.filter(r => r.passed).length;
          trackStats[track.key] = {
            total: trackRecs.length,
            passed,
            rate: trackRecs.length ? Math.round((passed / trackRecs.length)*100) : 0,
            avgConfidence: trackRecs
              .filter(r => r.confidence)
              .reduce((sum, r) => sum + r.confidence, 0) / (trackRecs.filter(r => r.confidence).length || 1)
          };
        });
        
        // Confidence over time (last 30 recordings)
        const recentConfidence = recordings
          .filter(r => r.confidence)
          .slice(-30)
          .map(r => r.confidence);
        
        if(view === 'overview'){
          return (
            <div className="space-y-4">
              <div className="flex gap-2 mb-4">
                <button onClick={()=>setView('overview')} className="px-3 py-1 rounded-lg bg-brand-900 text-white text-sm">Vista general</button>
                <button onClick={()=>setView('confidence')} className="px-3 py-1 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">Confianza</button>
                <button onClick={()=>setView('tracks')} className="px-3 py-1 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">Temas</button>
                <button onClick={()=>setView('timeline')} className="px-3 py-1 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">Progreso</button>
              </div>
              
              <div className="bg-gradient-to-br from-blossom-600 to-brand-900 text-white rounded-2xl p-6">
                <h2 className="text-xl font-bold mb-2">Esta semana</h2>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <div className="text-3xl font-bold">{thisWeek.length}</div>
                    <div className="text-sm opacity-90">pr√°cticas</div>
                  </div>
                  <div>
                    <div className="text-3xl font-bold">{thisWeekRate}%</div>
                    <div className="text-sm opacity-90">√©xito</div>
                  </div>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <StatCard 
                  icon="üéØ"
                  title="Total frases"
                  value={totalPhrases}
                  detail={`${passedPhrases} correctas`}
                />
                <StatCard 
                  icon="üí™"
                  title="Confianza"
                  value={avgConfidence}
                  detail="promedio /5"
                  color="bg-purple-100 dark:bg-purple-900"
                />
                <StatCard 
                  icon="üî•"
                  title="Streak"
                  value={streak}
                  detail="d√≠as seguidos"
                  color="bg-orange-100 dark:bg-orange-900"
                />
                <StatCard 
                  icon="üí¨"
                  title="Conversaciones"
                  value={conversations.length}
                  detail="completadas"
                  color="bg-blue-100 dark:bg-blue-900"
                />
              </div>
              
              <div className="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700">
                <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-4">Insignias ganadas</h3>
                <div className="grid grid-cols-3 gap-3">
                  {BADGES.map(badge => {
                    const earned = badges.earned.includes(badge.id);
                    return (
                      <div key={badge.id} className={cx('p-3 rounded-xl text-center transition-all', 
                        earned ? 'bg-pink-100 dark:bg-pink-900 scale-100' : 'bg-gray-100 dark:bg-gray-700 opacity-50 scale-95'
                      )}>
                        <div className="text-3xl mb-1">{badge.emoji}</div>
                        <div className="text-xs font-semibold text-brand-900 dark:text-gray-100">{badge.name}</div>
                        {!earned && <div className="text-xs text-gray-500 mt-1">{badge.desc}</div>}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        }
        
        if(view === 'confidence'){
          return (
            <div className="space-y-4">
              <button onClick={()=>setView('overview')} className="text-brand-700 dark:text-gray-400">‚Üê Vista general</button>
              
              <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft">
                <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Tu confianza al hablar</h2>
                
                <div className="mb-6">
                  <div className="flex justify-between items-end mb-2">
                    <span className="text-sm text-brand-700 dark:text-gray-400">Promedio actual</span>
                    <span className="text-3xl font-bold text-brand-900 dark:text-gray-100">{avgConfidence}/5</span>
                  </div>
                  <div className="confidence-bar h-12 rounded-lg">
                    <div className="confidence-marker" style={{left: `${(avgConfidence/5)*100}%`, width: '20px', height: '20px', top: '14px'}}></div>
                  </div>
                </div>
                
                {recentConfidence.length > 0 && (
                  <div>
                    <h3 className="text-sm font-semibold text-brand-900 dark:text-gray-100 mb-3">√öltimas 30 pr√°cticas</h3>
                    <div className="flex gap-1 items-end" style={{height: '100px'}}>
                      {recentConfidence.map((conf, idx) => (
                        <div 
                          key={idx}
                          className="flex-1 bg-gradient-to-t from-brand-600 to-brand-400 rounded-t"
                          style={{height: `${(conf/5)*100}%`}}
                          title={`Confianza: ${conf}/5`}
                        />
                      ))}
                    </div>
                    <p className="text-xs text-brand-700 dark:text-gray-400 mt-2 text-center">‚Üí Tiempo</p>
                  </div>
                )}
                
                <div className="mt-6 bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900 dark:to-pink-900 rounded-xl p-4">
                  <p className="text-sm text-brand-900 dark:text-gray-100">
                    {avgConfidence >= 4 ? 'üåü ¬°Excelente confianza! Sigue as√≠.' :
                     avgConfidence >= 3 ? 'üí™ Vas bien. La pr√°ctica hace la confianza.' :
                     avgConfidence >= 2 ? 'üå± Mejorando poco a poco. No te rindas.' :
                     'ü§ó Todos empezamos con poca confianza. Sigue practicando.'}
                  </p>
                </div>
              </div>
            </div>
          );
        }
        
        if(view === 'tracks'){
          return (
            <div className="space-y-4">
              <button onClick={()=>setView('overview')} className="text-brand-700 dark:text-gray-400">‚Üê Vista general</button>
              
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100">Progreso por tema</h2>
              
              {TRACKS.map(track => {
                const stats = trackStats[track.key];
                if(!stats || stats.total === 0) return null;
                
                return (
                  <div key={track.key} className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
                    <div className="flex items-center gap-3 mb-3">
                      <span className="text-2xl">{track.icon}</span>
                      <div className="flex-1">
                        <h3 className="font-semibold text-brand-900 dark:text-gray-100">{track.name}</h3>
                        <p className="text-xs text-brand-700 dark:text-gray-400">{stats.total} pr√°cticas</p>
                      </div>
                      <div className="text-right">
                        <div className="text-2xl font-bold text-brand-900 dark:text-gray-100">{stats.rate}%</div>
                        <div className="text-xs text-brand-700 dark:text-gray-400">√©xito</div>
                      </div>
                    </div>
                    
                    <div className="bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                      <div 
                        className="bg-gradient-to-r from-brand-600 to-brand-400 h-full rounded-full transition-all"
                        style={{width: `${stats.rate}%`}}
                      />
                    </div>
                    
                    {stats.avgConfidence > 0 && (
                      <p className="text-xs text-brand-700 dark:text-gray-400 mt-2">
                        Confianza promedio: {stats.avgConfidence.toFixed(1)}/5
                      </p>
                    )}
                  </div>
                );
              })}
              
              {Object.values(trackStats).every(s => s.total === 0) && (
                <p className="text-center text-brand-700 dark:text-gray-400 py-8">
                  Todav√≠a no has practicado ning√∫n tema espec√≠fico
                </p>
              )}
            </div>
          );
        }
        
        if(view === 'timeline'){
          // Group recordings by day
          const dailyStats = {};
          recordings.forEach(r => {
            const day = new Date(r.timestamp).toLocaleDateString('es-MX');
            if(!dailyStats[day]) dailyStats[day] = { total: 0, passed: 0, confidence: [] };
            dailyStats[day].total++;
            if(r.passed) dailyStats[day].passed++;
            if(r.confidence) dailyStats[day].confidence.push(r.confidence);
          });
          
          const last7Days = Object.entries(dailyStats).slice(-7);
          
          return (
            <div className="space-y-4">
              <button onClick={()=>setView('overview')} className="text-brand-700 dark:text-gray-400">‚Üê Vista general</button>
              
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100">Tu progreso</h2>
              
              <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft">
                <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-4">√öltimos 7 d√≠as</h3>
                
                {last7Days.length === 0 ? (
                  <p className="text-center text-brand-700 dark:text-gray-400 py-6">
                    No hay datos de los √∫ltimos 7 d√≠as
                  </p>
                ) : (
                  <div className="space-y-3">
                    {last7Days.map(([day, stats]) => (
                      <div key={day} className="border-b border-brand-200 dark:border-gray-700 pb-3">
                        <div className="flex justify-between items-start mb-2">
                          <span className="text-sm font-medium text-brand-900 dark:text-gray-100">{day}</span>
                          <span className="text-xs text-brand-700 dark:text-gray-400">{stats.total} frases</span>
                        </div>
                        <div className="grid grid-cols-2 gap-2 text-xs">
                          <div className="bg-emerald-100 dark:bg-emerald-900 rounded px-2 py-1">
                            √âxito: {Math.round((stats.passed/stats.total)*100)}%
                          </div>
                          {stats.confidence.length > 0 && (
                            <div className="bg-purple-100 dark:bg-purple-900 rounded px-2 py-1">
                              Confianza: {(stats.confidence.reduce((a,b)=>a+b,0)/stats.confidence.length).toFixed(1)}
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                
                <div className="mt-4 text-center">
                  <p className="text-sm text-brand-700 dark:text-gray-400">
                    Total hist√≥rico: {recordings.length} pr√°cticas en {Object.keys(dailyStats).length} d√≠as
                  </p>
                </div>
              </div>
            </div>
          );
        }
      }
      
      function StatCard({ icon, title, value, detail, color }){
        return (
          <div className={cx("rounded-xl p-4 border border-brand-200 dark:border-gray-700", color || "bg-white dark:bg-gray-800")}>
            <div className="text-2xl mb-2">{icon}</div>
            <div className="text-2xl font-bold text-brand-900 dark:text-gray-100">{value}</div>
            <div className="text-xs text-brand-700 dark:text-gray-400">{detail}</div>
          </div>
        );
      }
/* END: Enhanced StatsTab */

/* START: Enhanced MasTab with better journal */
      // ---------------- MAS TAB with Voice Journal ----------------
      function MasTab({ level, setLevel, inclusive, setInclusive, darkMode, setDarkMode, journals, setJournals, recordings, showToast }){
        const [tab, setTab] = useState('settings'); // 'settings', 'journal', 'tips', 'about'

        // Calculate progress to next level
        const recentRecordings = recordings.slice(-20);
        const passRate = recentRecordings.length > 0
          ? (recentRecordings.filter(r => r.passed).length / recentRecordings.length)
          : 0;
        const avgConfidence = recentRecordings.length > 0
          ? (recentRecordings.reduce((sum, r) => sum + (r.confidence || 0), 0) / recentRecordings.length)
          : 0;

        let progressMsg = '';
        let progressPercent = 0;
        if(level === 0){
          const passGoal = 0.7;
          const confGoal = 3.5;
          const passProgress = Math.min((passRate / passGoal) * 100, 100);
          const confProgress = Math.min((avgConfidence / confGoal) * 100, 100);
          progressPercent = (passProgress + confProgress) / 2;
          progressMsg = recentRecordings.length < 10
            ? `Practica ${10 - recentRecordings.length} m√°s frases para evaluar nivel`
            : `${progressPercent.toFixed(0)}% hacia nivel Intermedio (necesitas 70% √©xito + confianza 3.5)`;
        } else if(level === 1){
          const passGoal = 0.8;
          const confGoal = 4.0;
          const passProgress = Math.min((passRate / passGoal) * 100, 100);
          const confProgress = Math.min((avgConfidence / confGoal) * 100, 100);
          progressPercent = (passProgress + confProgress) / 2;
          progressMsg = recentRecordings.length < 10
            ? `Practica ${10 - recentRecordings.length} m√°s frases para evaluar nivel`
            : `${progressPercent.toFixed(0)}% hacia nivel Avanzado (necesitas 80% √©xito + confianza 4.0)`;
        } else {
          progressMsg = '¬°Ya est√°s en el nivel m√°ximo!';
          progressPercent = 100;
        }
        
        if(tab === 'journal'){
          return <JournalSection journals={journals} setJournals={setJournals} showToast={showToast} onBack={()=>setTab('settings')} />;
        }
        
        if(tab === 'tips'){
          return <TipsSection onBack={()=>setTab('settings')} />;
        }
        
        if(tab === 'about'){
          return <AboutSection onBack={()=>setTab('settings')} />;
        }
        
        return (
          <div className="space-y-4">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Ajustes</h2>
              
              <div className="space-y-3">
                <div className="py-2 border-b border-brand-200 dark:border-gray-700">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-brand-900 dark:text-gray-100">Nivel</span>
                    <select value={level} onChange={e=>setLevel(parseInt(e.target.value))} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                      <option value={0}>0 - Principiante</option>
                      <option value={1}>1 - Intermedio</option>
                      <option value={2}>2 - Avanzado</option>
                    </select>
                  </div>
                  {level < 2 && recentRecordings.length > 0 && (
                    <div className="mt-2">
                      <div className="flex justify-between text-xs text-brand-700 dark:text-gray-400 mb-1">
                        <span>Progreso al siguiente nivel</span>
                        <span>{progressPercent.toFixed(0)}%</span>
                      </div>
                      <div className="w-full bg-brand-100 dark:bg-gray-700 rounded-full h-2">
                        <div
                          className="bg-brand-600 h-2 rounded-full transition-all duration-300"
                          style={{width: `${Math.min(progressPercent, 100)}%`}}
                        ></div>
                      </div>
                      <p className="text-xs text-brand-700 dark:text-gray-400 mt-1">{progressMsg}</p>
                    </div>
                  )}
                  {level < 2 && recentRecordings.length === 0 && (
                    <p className="text-xs text-brand-700 dark:text-gray-400 mt-2">
                      Empieza a practicar para desbloquear niveles autom√°ticamente
                    </p>
                  )}
                </div>

                <div className="flex items-center justify-between py-2 border-b border-brand-200 dark:border-gray-700">
                  <span className="text-brand-900 dark:text-gray-100">Lenguaje inclusivo</span>
                  <button onClick={()=>setInclusive(v=>!v)} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                    {inclusive ? 'S√≠' : 'No'}
                  </button>
                </div>
                
                <div className="flex items-center justify-between py-2">
                  <span className="text-brand-900 dark:text-gray-100">Modo oscuro üåô</span>
                  <button onClick={()=>setDarkMode(v=>!v)} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                    {darkMode ? 'S√≠' : 'No'}
                  </button>
                </div>
              </div>
            </div>
            
            <button onClick={()=>setTab('journal')} className="w-full bg-brand-900 text-white py-3 rounded-xl font-semibold">
              üí¨ Mi diario de voz
            </button>
            
            <button onClick={()=>setTab('tips')} className="w-full bg-blossom-600 text-white py-3 rounded-xl font-semibold">
              üìö Tips culturales
            </button>
            
            <button onClick={()=>setTab('about')} className="w-full bg-purple-600 text-white py-3 rounded-xl font-semibold">
              üíú Sobre esta app
            </button>
            
            <div className="text-center space-y-2 py-4">
              <div className="flex justify-center gap-3 text-2xl">
                {Object.values(CATS).map(cat => (
                  <span key={cat.name} title={cat.name}>{cat.emoji}</span>
                ))}
              </div>
              <div className="text-xs text-brand-700 dark:text-gray-400">
                para stacie ¬∑ v7.0 ¬∑ con amor de mia
              </div>
            </div>
          </div>
        );
      }
      
      // Enhanced Voice Journal with better prompts
      function JournalSection({ journals, setJournals, showToast, onBack }){
        const [recording, setRecording] = useState(false);
        const [transcript, setTranscript] = useState('');
        const [selectedPrompt, setSelectedPrompt] = useState(0);
        const rec = useSpeechRecognition({ onResult:(t)=>setTranscript(t), onEnd:()=>setRecording(false) });
        
        const JOURNAL_PROMPTS = [
          { es: '¬øC√≥mo te fue en la residencia hoy?', en: 'How was the residence today?' },
          { es: '¬øQu√© fue lo mejor de tu d√≠a?', en: 'What was the best part of your day?' },
          { es: 'Cu√©ntale a Mia algo nuevo que aprendiste', en: 'Tell Mia something new you learned' },
          { es: '¬øC√≥mo te sientes en este momento?', en: 'How are you feeling right now?' },
          { es: 'Describe tu comida favorita mexicana', en: 'Describe your favorite Mexican food' },
          { es: '¬øQu√© planes tienes para el fin de semana?', en: 'What are your weekend plans?' },
          { es: '¬øQu√© extra√±as de casa?', en: 'What do you miss from home?' },
          { es: 'Habla de tu gato favorito y por qu√©', en: 'Talk about your favorite cat and why' },
          { es: '¬øQu√© quieres hacer con Mia ma√±ana?', en: 'What do you want to do with Mia tomorrow?' },
          { es: 'Practica presentarte a los suegros', en: 'Practice introducing yourself to in-laws' }
        ];
        
        const prompt = JOURNAL_PROMPTS[selectedPrompt];
        
        function handleRecord(){
          if(!rec.supported) return;
          if(!recording){ setTranscript(''); rec.start(); setRecording(true); }
          else {
            rec.stop();
            if(transcript){
              setJournals(prev => [...prev, { 
                text: transcript, 
                prompt: prompt.es,
                timestamp: Date.now() 
              }]);
              setTranscript('');
              showToast('Guardado en tu diario', 'mia');
            }
          }
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700 mb-4">
              <h3 className="font-bold text-brand-900 dark:text-gray-100 mb-3">Prompt de hoy:</h3>
              
              <div className="mb-4">
                <p className="text-brand-900 dark:text-gray-100 font-medium">{prompt.es}</p>
                <p className="text-sm text-brand-700 dark:text-gray-400 italic">{prompt.en}</p>
              </div>
              
              <div className="flex gap-2 mb-4">
                <button 
                  onClick={()=>setSelectedPrompt((p+1) % JOURNAL_PROMPTS.length)}
                  className="px-3 py-1 rounded-lg bg-brand-100 dark:bg-gray-700 text-sm text-brand-900 dark:text-gray-100"
                >
                  üîÑ Otro prompt
                </button>
                <button 
                  onClick={()=>speak(prompt.es, {rate:0.9})}
                  className="px-3 py-1 rounded-lg bg-brand-100 dark:bg-gray-700 text-sm text-brand-900 dark:text-gray-100"
                >
                  üëÇ Escuchar
                </button>
              </div>
              
              <button onClick={handleRecord} className={cx('w-full py-3 rounded-xl text-white font-semibold', recording?'bg-rose-600 recording-pulse':'bg-brand-900')}>
                {recording ? '‚èπ Detener grabaci√≥n' : 'üé§ Grabar respuesta'}
              </button>
              
              {transcript && (
                <div className="mt-3 p-3 bg-brand-50 dark:bg-gray-700 rounded-xl">
                  <p className="text-brand-900 dark:text-gray-100">{transcript}</p>
                </div>
              )}
            </div>
            
            <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-3">Entradas recientes</h3>
            {journals.length === 0 ? (
              <p className="text-center text-brand-700 dark:text-gray-400 py-6">
                Tu diario est√° vac√≠o. ¬°Graba tu primera entrada!
              </p>
            ) : (
              <div className="space-y-2">
                {journals.slice().reverse().slice(0,5).map((j,i)=>(
                  <div key={i} className="bg-white dark:bg-gray-800 rounded-xl p-3 shadow-soft border border-brand-200 dark:border-gray-700">
                    <div className="flex justify-between items-start mb-1">
                      <div className="text-xs text-brand-700 dark:text-gray-400">
                        {new Date(j.timestamp).toLocaleDateString('es-MX')}
                      </div>
                      <button 
                        onClick={()=>speak(j.text)}
                        className="text-xs text-blossom-600"
                      >
                        üëÇ
                      </button>
                    </div>
                    {j.prompt && (
                      <p className="text-xs text-brand-700 dark:text-gray-400 italic mb-1">
                        Prompt: {j.prompt}
                      </p>
                    )}
                    <p className="text-sm text-brand-900 dark:text-gray-100">{j.text}</p>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }
      
      function TipsSection({ onBack }){
        const tips = [
          { title: '¬øMande?', text: 'Forma cort√©s de "¬øqu√©?" muy com√∫n en M√©xico. Los suegros lo apreciar√°n.' },
          { title: 'Jitomate vs. Tomate', text: 'En M√©xico: jitomate = rojo (lo normal), tomate = verde (para salsa verde).' },
          { title: 'Diminutivos con cari√±o', text: 'Poquito, ratito, ahorita, tantito = no es vago, es cari√±oso.' },
          { title: 'Usted con los suegros', text: 'Al principio usa "usted" con los pap√°s de Mia. Ellos te dir√°n cu√°ndo tutear.' },
          { title: 'La sobremesa', text: 'Despu√©s de comer, se platica. No te levantes r√°pido de la mesa.' },
          { title: 'El "ahorita"', text: 'Ahorita = en un rato. Ahora mismo = right now. Ahorita no es urgente.' },
          { title: 'Comida = almuerzo', text: 'Desayuno (morning), comida (lunch/main meal), cena (dinner).' },
          { title: 'No digas "no" directo', text: 'Mejor "d√©jame ver", "a ver si puedo", "tal vez" que un "no" seco.' }
        ];
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Tips culturales üåÆ</h2>
            <div className="space-y-3">
              {tips.map((tip,i)=>(
                <div key={i} className="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
                  <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-1">{tip.title}</h3>
                  <p className="text-sm text-brand-700 dark:text-gray-300">{tip.text}</p>
                </div>
              ))}
            </div>
          </div>
        );
      }
      
      function AboutSection({ onBack }){
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            
            <div className="bg-gradient-to-br from-pink-100 to-purple-100 dark:from-pink-900 dark:to-purple-900 rounded-2xl p-6 mb-4">
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-4">
                Hecha con amor üíú
              </h2>
              <p className="text-brand-900 dark:text-gray-200 mb-3">
                Esta app fue creada por Mia para Stacie, con la ayuda de cuatro gatos supervisores.
              </p>
              <p className="text-sm text-brand-800 dark:text-gray-300">
                Despu√©s de 11,000 d√≠as en Duolingo, era hora de algo diferente. 
                Esta app no es sobre memorizar palabras ‚Äî es sobre sentir confianza al hablar espa√±ol con la familia.
              </p>
            </div>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft mb-4">
              <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-3">Los supervisores:</h3>
              <div className="space-y-2">
                {Object.entries(CATS).map(([key, cat]) => (
                  <div key={key} className="flex items-center gap-3">
                    <span className="text-2xl">{cat.emoji}</span>
                    <div>
                      <span className="font-medium text-brand-900 dark:text-gray-100">{cat.name}</span>
                      <span className="text-sm text-brand-700 dark:text-gray-400 ml-2">
                        ‚Äî {cat.personality}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            <div className="text-center text-sm text-brand-700 dark:text-gray-400">
              <p>Versi√≥n 7.0 ‚Ä¢ Confidence Edition</p>
              <p className="mt-2">Para Stacie, siempre üíô</p>
            </div>
          </div>
        );
      }
      
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
