<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>stacie v5</title>
    <meta name="description" content="espa√±ol con sabor mexicano ‚Äî para stacie"/>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d3d30">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --brand-50: #edf7f3;
        --brand-100: #d6efe6;
        --brand-200: #b0e0cf;
        --brand-600: #1f7d62;
        --brand-700: #186651;
        --brand-800: #115240;
        --brand-900: #0d3d30;
        --blossom-600: #db4b94;
      }
      html, body { height: 100%; }
      body { margin: 0; transition: background-color 0.3s, color 0.3s; }
      body.light { background: #f6faf8; color: #0d3d30; }
      body.dark { background: #1a1a1a; color: #e0e0e0; }
      * { -webkit-tap-highlight-color: transparent; }
      
      .bg-brand-50 { background-color: var(--brand-50); }
      .bg-brand-100 { background-color: var(--brand-100); }
      .bg-brand-600 { background-color: var(--brand-600); }
      .bg-brand-700 { background-color: var(--brand-700); }
      .bg-brand-800 { background-color: var(--brand-800); }
      .bg-brand-900 { background-color: var(--brand-900); }
      .bg-blossom-600 { background-color: var(--blossom-600); }
      .text-brand-700 { color: var(--brand-700); }
      .text-brand-800 { color: var(--brand-800); }
      .text-brand-900 { color: var(--brand-900); }
      .border-brand-200 { border-color: var(--brand-200); }
      
      .shadow-soft { box-shadow: 0 8px 28px rgba(0,0,0,.10); }
      .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #d6efe6; z-index: 100; box-shadow: 0 -4px 12px rgba(0,0,0,0.05); }
      .main-content { padding-bottom: 80px; min-height: 100vh; }
      
      body.dark .tab-bar { background: #2a2a2a; border-top-color: #444; }
      body.dark .bg-white { background: #2a2a2a !important; }
      body.dark .text-brand-900 { color: #e0e0e0 !important; }
      body.dark .text-brand-700 { color: #b0b0b0 !important; }
      body.dark .border-brand-200 { border-color: #444 !important; }
      body.dark .bg-brand-50 { background-color: #333 !important; }
      body.dark .bg-brand-100 { background-color: #3a3a3a !important; }
      
      @keyframes slideIn {
        from { transform: translateY(-100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .toast { animation: slideIn 0.3s ease-out; }
      .hero-card { background: linear-gradient(135deg, var(--brand-700) 0%, var(--brand-900) 100%); }
      .badge-earned { box-shadow: 0 0 20px rgba(236, 90, 166, 0.4); }
      
      /* Loading animation */
      @keyframes tortilla {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(5deg); }
        75% { transform: rotate(-5deg); }
      }
      .loading { animation: tortilla 1s ease-in-out infinite; }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="light">
    <div id="root"></div>
    <script type="text/babel">
      /******************************************************************
       * stacie v5 ‚Äî Para Stacie
       * Nuevas caracter√≠sticas:
       *  - Perspectiva correcta: Stacie = usuario, Mia = pareja
       *  - 4 gatos con personalidades (Otis, Doom, Jules, Lassie)
       *  - Comida como met√°fora en todo
       *  - Microcopy M√©xico-coded
       *  - Retroalimentaci√≥n de pronunciaci√≥n mejorada
       *  - Aprendizaje adaptativo
       *  - Pr√°ctica de sombra (shadowing)
       *  - Modo oscuro
       *  - B√∫squeda mejorada
       *  - Red de seguridad de racha
       *  - M√°s insignias con temas de comida
       ******************************************************************/
      const { useEffect, useMemo, useRef, useState } = React;
      
      // ---------------- helpers ----------------
      const esLocale = 'es-MX';
      function cx(...classes) { return classes.filter(Boolean).join(' '); }
      function todayISO(){
        const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10);
      }
      function ydayISO(){
        const d=new Date(); d.setDate(d.getDate()-1); d.setHours(0,0,0,0); return d.toISOString().slice(0,10);
      }
      function daysAgo(n){
        const d=new Date(); d.setDate(d.getDate()-n); d.setHours(0,0,0,0); return d.toISOString().slice(0,10);
      }
      function useLocalStorage(key, initial){
        const [value,setValue]=useState(()=>{
          try { const raw=localStorage.getItem(key); return raw?JSON.parse(raw):initial; }
          catch { return initial; }
        });
        useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(value)); }catch{} },[key,value]);
        return [value,setValue];
      }
      
      // Levenshtein + tokenization
      function lev(a,b){
        const m=a.length,n=b.length;
        const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
        for(let i=0;i<=m;i++)dp[i][0]=i;
        for(let j=0;j<=n;j++)dp[0][j]=j;
        for(let i=1;i<=m;i++){
          for(let j=1;j<=n;j++){
            const cost=a[i-1]===b[j-1]?0:1;
            dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
          }
        }
        return dp[m][n];
      }
      function stripDiacritics(s){ try{ return s.normalize('NFD').replace(/[\p{M}]/gu,''); }catch{ return s; } }
      function tokenize(s){
        return stripDiacritics(String(s||'').toLowerCase())
          .replace(/[^a-z√±√°√©√≠√≥√∫√º\s]/gi,'')
          .split(/\s+/).filter(Boolean);
      }
      function wordScore(target, said){
        const t=tokenize(target), s=tokenize(said), bad=[];
        for(let i=0;i<t.length;i++){
          const tw=t[i], sw=s[i]??'';
          const d=lev(tw,sw);
          const threshold=Math.max(1, Math.floor(tw.length/3));
          if(d>threshold) bad.push(tw);
        }
        const pass = bad.length <= Math.ceil(t.length*0.2);
        return { pass, badWords: bad };
      }
      
      function flex(text, inclusive=true){
        return String(text).replace(/\[([^\]|]+)\|([^\]]+)\]/g, (_, fem, incl) => inclusive ? incl : fem);
      }
      
      // speech synthesis
      function chooseEsVoice(){
        if (typeof window==='undefined' || !('speechSynthesis' in window)) return null;
        const voices = window.speechSynthesis.getVoices?.() || [];
        return voices.find(v=>v.lang?.toLowerCase().startsWith('es-mx'))
            || voices.find(v=>v.lang?.toLowerCase().startsWith('es-'))
            || null;
      }
      function speak(text,{rate=1}={}){
        if (typeof window==='undefined' || !('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = esLocale; u.rate = rate;
        const v = chooseEsVoice(); if (v) u.voice = v;
        try { window.speechSynthesis.cancel(); } catch {}
        window.speechSynthesis.speak(u);
      }
      function useSpeechRecognition({ onResult, onEnd }={}){
        const recRef = useRef(null);
        const [supported,setSupported]=useState(false);
        useEffect(()=>{
          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (SR){ const rec=new SR(); rec.lang=esLocale; rec.interimResults=true; rec.maxAlternatives=1; recRef.current=rec; setSupported(true); }
        },[]);
        const start=()=>{ const rec=recRef.current; if(!rec) return; let final=''; rec.onresult=(e)=>{ for(let i=e.resultIndex;i<e.results.length;i++){ const tr=e.results[i][0].transcript; if(e.results[i].isFinal) final+=tr; } onResult&&onResult(final); }; rec.onend=()=>onEnd&&onEnd(); try{ rec.start(); }catch{} };
        const stop = ()=>{ try{ recRef.current?.stop(); }catch{} };
        return { supported, start, stop };
      }
      
      // ---------------- CAT PERSONALITIES ----------------
      const CATS = {
        otis: { 
          name: 'Otis', 
          emoji: 'üê±', 
          personality: 'aloof, talkative, dramatic',
          color: '#f59e0b'
        },
        doom: { 
          name: 'Doom', 
          emoji: 'üêà', 
          personality: 'cuddly, loving, dog-like',
          color: '#8b5cf6'
        },
        jules: { 
          name: 'Jules', 
          emoji: 'üêæ', 
          personality: 'sassy, needs space, attitude',
          color: '#ec4899'
        },
        lassie: { 
          name: 'Lassie', 
          emoji: 'üò∏', 
          personality: 'laid-back, protective, steady',
          color: '#10b981'
        }
      };
      
      // ---------------- CONTENT ----------------
      const TRACKS = [
        { key:'work', name:'Mi trabajo (UMN)', icon:'üè†', color:'bg-blossom-600', desc:'Residence life phrases' },
        { key:'mia', name:'Mia & yo', icon:'üíï', color:'bg-brand-900', desc:'Talking with your partner' },
        { key:'family', name:'Familia', icon:'üë®‚Äçüë©‚Äçüëß', color:'bg-brand-800', desc:'Con los suegros' },
        { key:'vida', name:'Nuestra vida', icon:'üåÆ', color:'bg-brand-700', desc:'Comida, salud, diario' }
      ];
      
      const SENTENCES = {
        work: [
          // UMN Residence Life
          { id:'w1', lvl:0, es:'Hola, bienvenide. ¬øC√≥mo te llamas?', hint:'welcome, what is your name', ctx:'Greeting new residents' },
          { id:'w2', lvl:0, es:'¬øC√≥mo va todo en tu cuarto?', hint:'how is everything in your room', ctx:'Check-in with residents' },
          { id:'w3', lvl:0, es:'Estoy aqu√≠ para ayudar.', hint:'I am here to help', ctx:'Offering support' },
          { id:'w4', lvl:1, es:'¬øNecesitas algo? Av√≠same por favor.', hint:'need anything let me know', ctx:'Being available' },
          { id:'w5', lvl:1, es:'Hay un evento esta noche en el sal√≥n.', hint:'event tonight in lounge', ctx:'Announcing events' },
          { id:'w6', lvl:2, es:'Si hay alg√∫n problema, comun√≠cate conmigo.', hint:'if problem, communicate with me', ctx:'Setting boundaries' },
          { id:'w7', lvl:2, es:'Respeten las horas de silencio por favor.', hint:'respect quiet hours', ctx:'Enforcing rules' },
          { id:'w8', lvl:1, es:'¬øC√≥mo te est√° yendo con las clases?', hint:'how are classes going', ctx:'Building rapport' }
        ],
        mia: [
          // Talking TO/ABOUT Mia
          { id:'m1', lvl:0, es:'¬øC√≥mo te fue en el trabajo hoy?', hint:'how was work today', ctx:'Evening check-in' },
          { id:'m2', lvl:0, es:'Cu√©ntame de tu d√≠a en Carleton.', hint:'tell me about your day', ctx:'Showing interest' },
          { id:'m3', lvl:1, es:'¬øHubo alg√∫n tour interesante hoy?', hint:'any interesting tours', ctx:'Asking about admissions' },
          { id:'m4', lvl:1, es:'Te guard√© la √∫ltima concha porque soy un amor.', hint:'saved you the last pastry', ctx:'Being sweet' },
          { id:'m5', lvl:0, es:'¬øQuieres cocinar algo juntes esta noche?', hint:'want to cook together tonight', ctx:'Making plans' },
          { id:'m6', lvl:2, es:'Te ves [cansada|cansade]. ¬øNecesitas un ratito de descanso?', hint:'you look tired need rest', ctx:'Checking in on partner' },
          { id:'m7', lvl:1, es:'Mia, eres [incre√≠ble|incre√≠ble]. Gracias por todo.', hint:'you are amazing thanks', ctx:'Appreciation' },
          { id:'m8', lvl:2, es:'¬øC√≥mo estuvo tu junta con las familias?', hint:'how was your meeting with families', ctx:'About Carleton work' }
        ],
        family: [
          // Con los suegros
          { id:'f1', lvl:0, es:'Buenos d√≠as. ¬øC√≥mo est√°n?', hint:'good morning how are you', ctx:'Greeting in-laws' },
          { id:'f2', lvl:0, es:'La comida est√° deliciosa, gracias.', hint:'food is delicious thanks', ctx:'Appreciating meal' },
          { id:'f3', lvl:1, es:'Me da mucho gusto verlos.', hint:'so happy to see you', ctx:'Expressing joy' },
          { id:'f4', lvl:1, es:'Gracias por recibirnos en su casa.', hint:'thanks for having us', ctx:'Being gracious' },
          { id:'f5', lvl:2, es:'Cu√©ntennos c√≥mo estuvo su semana.', hint:'tell us about your week', ctx:'Making conversation' },
          { id:'f6', lvl:0, es:'Disculpe, ¬ømande? No entend√≠ bien.', hint:'pardon I did not understand', ctx:'Asking for clarification' },
          { id:'f7', lvl:1, es:'Estoy practicando mi espa√±ol cada d√≠a.', hint:'practicing my Spanish every day', ctx:'Showing effort' },
          { id:'f8', lvl:2, es:'D√©jennos ayudar con los platos.', hint:'let us help with dishes', ctx:'Offering help' }
        ],
        vida: [
          // Daily life: food, health, etc
          { id:'v1', lvl:0, es:'Se me antoja algo rico para cenar.', hint:'craving something good for dinner', ctx:'Planning meals' },
          { id:'v2', lvl:0, es:'¬øHay tortillas? Quiero hacer tacos.', hint:'are there tortillas want tacos', ctx:'Cooking together' },
          { id:'v3', lvl:1, es:'Me duele la cabeza un poquito.', hint:'my head hurts a little', ctx:'Expressing discomfort' },
          { id:'v4', lvl:1, es:'Prefiero leche de avena. ¬øTienen para llevar?', hint:'prefer oat milk to go', ctx:'Ordering coffee' },
          { id:'v5', lvl:0, es:'Vamos al Arb si hace buen clima.', hint:'go to arb if good weather', ctx:'Minnesota activities' },
          { id:'v6', lvl:2, es:'Despu√©s de clase, armo una playlist y practico.', hint:'after class make playlist and practice', ctx:'Daily routine' },
          { id:'v7', lvl:1, es:'Si hace fr√≠o, hacemos t√© y nos quedamos en casa.', hint:'if cold make tea stay home', ctx:'Winter in MN' },
          { id:'v8', lvl:2, es:'Quiero pertenecer al proceso, como masa que reposa.', hint:'want to belong to process like resting dough', ctx:'Being patient with learning' }
        ]
      };
      
      // Cat-themed encouragements
      const ENCOURAGEMENTS = [
        { cat: 'doom', text: 'Doom: Eso estuvo de lujo. Te mando un abrazo grande (como yo). üêàüíï' },
        { cat: 'otis', text: 'Otis: MIAU MIAU MIAU... digo, ¬°excelente! Aunque yo lo hubiera hecho mejor. üòº' },
        { cat: 'jules', text: 'Jules: Qued√≥ chido. Pero no me molestes, necesito mi espacio. üêæ' },
        { cat: 'lassie', text: 'Lassie: Te cuido siempre. Poquito a poquito es camino. üò∏' },
        { cat: 'doom', text: 'Doom: Eres mi [favorita|favorite]. Le echaste salsita a tu pronunciaci√≥n. üå∂Ô∏è' },
        { cat: 'otis', text: 'Otis: Bueeeeeno, estuvo aceptable. (En realidad estuvo perfecto pero no te lo voy a decir). üôÑ' },
        { cat: 'jules', text: 'Jules: Respeto. Hoy s√≠ te ganaste tu espacio. üëè' },
        { cat: 'lassie', text: 'Lassie: Estoy [orgullosa|orgullose]. Sigue as√≠, yo vigilo. üõ°Ô∏è' },
        { cat: 'doom', text: 'Doom: Ven aqu√≠, te mereces mimos. Tu espa√±ol pica rico. üòª' },
        { cat: 'otis', text: 'Otis: *se estira todo lo largo que es* S√≠ s√≠, estuvo bien. ¬øYa terminamos? üê±' }
      ];
      
      const BADGES = [
        { id: 'b1', name: 'Tamal sin pasita', emoji: 'ü´î', desc: '10 respuestas correctas seguidas', req: 'streak_correct', count: 10, tooltip: 'Todo bonito, nada raro' },
        { id: 'b2', name: 'Taquere de confianza', emoji: 'üåÆ', desc: '7 d√≠as consecutivos', req: 'streak', count: 7, tooltip: 'Ya eres de la casa' },
        { id: 'b3', name: 'Salseo controlado', emoji: 'üå∂Ô∏è', desc: 'Usar tildes 5 veces', req: 'tildes', count: 5, tooltip: 'Ni muy muy, ni tan tan' },
        { id: 'b4', name: 'Diminutive digne', emoji: '‚òï', desc: 'Usar 3 diminutivos', req: 'diminutivos', count: 3, tooltip: 'Ratito, cafecito, pasito' },
        { id: 'b5', name: 'Conchera', emoji: 'ü•ê', desc: '30 d√≠as de pr√°ctica', req: 'streak', count: 30, tooltip: 'Guardaste la √∫ltima para Mia' },
        { id: 'b6', name: 'Masa que reposa', emoji: 'ü´ì', desc: '10 entradas de diario', req: 'journals', count: 10, tooltip: 'Pertenecer al proceso' }
      ];
      
      const VOICE_PROMPTS = [
        '¬øC√≥mo te fue hoy en la residencia?',
        '¬øQu√© se te antoja para cenar?',
        'Cu√©ntale a Mia algo que pas√≥ hoy',
        '¬øC√≥mo te sientes en este momento?',
        'Algo que te hizo feliz hoy',
        'Describe tu d√≠a en 3 frases',
        '¬øQu√© aprendiste hoy?'
      ];
      
      const CULTURAL_TIPS = [
        {
          id: 'c1',
          title: '¬øMande?',
          content: '¬øMande? = forma amable de "¬øqu√© dijiste?" Es m√°s com√∫n en M√©xico que "¬øc√≥mo?" o "¬øqu√©?"'
        },
        {
          id: 'c2',
          title: 'Jitomate vs. Tomate',
          content: 'En M√©xico decimos jitomate (rojo) y tomate (verde). En otros pa√≠ses es al rev√©s!'
        },
        {
          id: 'c3',
          title: 'Diminutivos con cari√±o',
          content: 'Poquito, tantito, ratito no son vaguedad ‚Äî es cari√±o y suavidad en el lenguaje.'
        },
        {
          id: 'c4',
          title: 'Usted en el trabajo',
          content: 'Con estudiantes puedes usar t√∫, pero con sus familias usa usted hasta que te digan "tut√©ame".'
        }
      ];
      
      // ---------------- Badge System ----------------
      function useBadges(){
        const [earned, setEarned] = useLocalStorage('stacie.badges', []);
        const [sessions, ] = useLocalStorage('stacie.sessions', 0);
        const [streak, ] = useLocalStorage('stacie.streak', 0);
        const [journals, ] = useLocalStorage('stacie.journals', []);
        
        function checkBadges(){
          const newBadges = [];
          BADGES.forEach(badge => {
            if(earned.includes(badge.id)) return;
            let unlocked = false;
            if(badge.req === 'sessions' && sessions >= badge.count) unlocked = true;
            if(badge.req === 'streak' && streak >= badge.count) unlocked = true;
            if(badge.req === 'journals' && journals.length >= badge.count) unlocked = true;
            if(unlocked) newBadges.push(badge.id);
          });
          if(newBadges.length > 0){
            setEarned(prev => [...prev, ...newBadges]);
            return newBadges;
          }
          return [];
        }
        
        return { earned, checkBadges };
      }
      
      // ---------------- Weekly Report ----------------
      function useWeeklyReport(){
        const [recordings] = useLocalStorage('stacie.recordings', []);
        
        function getWeeklyReport(){
          const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
          const thisWeek = recordings.filter(r => r.timestamp >= weekAgo);
          const lastWeek = recordings.filter(r => r.timestamp >= (weekAgo - (7 * 24 * 60 * 60 * 1000)) && r.timestamp < weekAgo);
          
          const thisWeekRate = thisWeek.length ? (thisWeek.filter(r=>r.passed).length / thisWeek.length) : 0;
          const lastWeekRate = lastWeek.length ? (lastWeek.filter(r=>r.passed).length / lastWeek.length) : 0;
          const improvement = thisWeekRate - lastWeekRate;
          
          const trackStats = {};
          TRACKS.forEach(track => {
            const trackRecs = thisWeek.filter(r => r.phraseId?.startsWith(track.key[0]));
            const passed = trackRecs.filter(r => r.passed).length;
            trackStats[track.key] = {
              total: trackRecs.length,
              passed,
              rate: trackRecs.length ? passed / trackRecs.length : 0
            };
          });
          
          return {
            thisWeekCount: thisWeek.length,
            thisWeekRate,
            improvement: Math.round(improvement * 100),
            trackStats
          };
        }
        
        return { getWeeklyReport };
      }
      
      // ---------------- Main App ----------------
      function App(){
        const [tab, setTab] = useState('hoy');
        const [level, setLevel] = useLocalStorage('stacie.level', 0);
        const [inclusive, setInclusive] = useLocalStorage('stacie.inclusive', true);
        const [darkMode, setDarkMode] = useLocalStorage('stacie.darkMode', false);
        const [streak, setStreak] = useLocalStorage('stacie.streak', 0);
        const [streakFreeze, setStreakFreeze] = useLocalStorage('stacie.streakFreeze', 1);
        const [lastDone, setLastDone] = useLocalStorage('stacie.lastDone', '');
        const [sessions, setSessions] = useLocalStorage('stacie.sessions', 0);
        const [recordings, setRecordings] = useLocalStorage('stacie.recordings', []);
        const [journals, setJournals] = useLocalStorage('stacie.journals', []);
        const [loading, setLoading] = useState(false);
        const badges = useBadges();
        const [toast, setToast] = useState(null);
        
        useEffect(()=>{
          document.body.className = darkMode ? 'dark' : 'light';
        }, [darkMode]);
        
        function showToast(msg, cat){
          const catData = CATS[cat];
          const icon = catData ? `${catData.emoji} ${catData.name}: ` : '';
          setToast(icon + msg);
          setTimeout(()=>setToast(null), 4000);
        }
        
        function saveWithToast(msg){
          setLoading(true);
          setTimeout(()=>{
            setLoading(false);
            showToast(msg, 'doom');
          }, 500);
        }
        
        function completeSession(){
          const today = todayISO();
          if(lastDone !== today){
            if(lastDone === ydayISO()) {
              setStreak(s => s+1);
              saveWithToast('¬°Streak vivo! Salsita en la mesa.');
            } else if (streakFreeze > 0) {
              setStreakFreeze(f => f-1);
              saveWithToast(`Usaste un streak freeze. Te quedan ${streakFreeze-1}.`);
            } else {
              setStreak(1);
              saveWithToast('Streak reiniciado. Poquito pero diario.');
            }
            setLastDone(today);
          }
          setSessions(s => s+1);
          const newBadges = badges.checkBadges();
          if(newBadges.length > 0){
            const badge = BADGES.find(b => b.id === newBadges[0]);
            showToast(`¬°Nueva insignia! ${badge.emoji} ${badge.name}`, 'jules');
          }
          saveWithToast('Guardado ‚Äî como frijoles en el refri');
        }
        
        return (
          <div className="min-h-screen">
            {loading && (
              <div className="fixed top-20 left-1/2 transform -translate-x-1/2 z-50">
                <div className="bg-white dark:bg-gray-800 px-4 py-2 rounded-xl shadow-lg">
                  <span className="loading inline-block">ü´ì</span>
                  <span className="ml-2">Calentando las tortillas...</span>
                </div>
              </div>
            )}
            
            {toast && (
              <div className="fixed top-4 left-4 right-4 z-50 toast">
                <div className="bg-brand-900 text-white px-4 py-3 rounded-xl shadow-lg text-center max-w-md mx-auto">
                  {toast}
                </div>
              </div>
            )}
            
            <header className="bg-white dark:bg-gray-900 border-b border-brand-200 dark:border-gray-700 px-4 py-3 sticky top-0 z-40 shadow-sm">
              <div className="max-w-md mx-auto flex items-center justify-between">
                <div>
                  <h1 className="text-xl font-bold text-brand-900 dark:text-gray-100">
                    stacie <span className="text-xs text-blossom-600">v5</span>
                  </h1>
                </div>
                <div className="flex items-center gap-3">
                  <div className="text-brand-900 dark:text-gray-100 font-semibold">üî• {streak}</div>
                  {streakFreeze > 0 && (
                    <div className="text-xs bg-brand-100 dark:bg-gray-700 px-2 py-1 rounded-full">
                      ‚ùÑÔ∏è {streakFreeze}
                    </div>
                  )}
                </div>
              </div>
            </header>
            
            <div className="main-content">
              <div className="max-w-md mx-auto px-4 py-4">
                {tab === 'hoy' && <HoyTab level={level} inclusive={inclusive} onComplete={completeSession} onNavigate={setTab} showToast={showToast} />}
                {tab === 'practica' && <PracticaTab level={level} inclusive={inclusive} recordings={recordings} setRecordings={setRecordings} onComplete={completeSession} showToast={showToast} />}
                {tab === 'diario' && <DiarioTab journals={journals} setJournals={setJournals} inclusive={inclusive} showToast={showToast} />}
                {tab === 'stats' && <StatsTab sessions={sessions} streak={streak} badges={badges} recordings={recordings} />}
                {tab === 'mas' && <MasTab level={level} setLevel={setLevel} inclusive={inclusive} setInclusive={setInclusive} darkMode={darkMode} setDarkMode={setDarkMode} />}
              </div>
            </div>
            
            <div className="tab-bar">
              <div className="max-w-md mx-auto flex items-center justify-around py-2">
                <TabButton icon="üè†" label="Hoy" active={tab==='hoy'} onClick={()=>setTab('hoy')} />
                <TabButton icon="üìö" label="Pr√°ctica" active={tab==='practica'} onClick={()=>setTab('practica')} />
                <TabButton icon="üí¨" label="Diario" active={tab==='diario'} onClick={()=>setTab('diario')} />
                <TabButton icon="üìä" label="Stats" active={tab==='stats'} onClick={()=>setTab('stats')} />
                <TabButton icon="‚öôÔ∏è" label="M√°s" active={tab==='mas'} onClick={()=>setTab('mas')} />
              </div>
            </div>
          </div>
        );
      }
      
      function TabButton({ icon, label, active, onClick }){
        return (
          <button onClick={onClick} className={cx('flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-colors', active ? 'text-brand-900 dark:text-gray-100' : 'text-gray-400')}>
            <span className="text-xl">{icon}</span>
            <span className="text-xs font-medium">{label}</span>
          </button>
        );
      }
      
      // ---------------- HOY TAB ----------------
      function HoyTab({ level, inclusive, onComplete, onNavigate, showToast }){
        const [selectedTrack] = useState('work');
        const trackData = TRACKS.find(t => t.key === selectedTrack);
        const sentences = SENTENCES[selectedTrack].filter(s => s.lvl <= level);
        const dailyPhrase = sentences[Math.floor(Math.random() * sentences.length)];
        const encouragement = useMemo(()=>{
          const enc = ENCOURAGEMENTS[Math.floor(Math.random()*ENCOURAGEMENTS.length)];
          return enc;
        },[]);
        
        return (
          <div className="space-y-4">
            <div className="hero-card text-white rounded-2xl p-6 shadow-lg">
              <div className="text-sm opacity-90 mb-2">Meta del d√≠a</div>
              <div className="text-xl font-semibold mb-4">Una quesadilla de vocab (3 frases)</div>
              <button onClick={onComplete} className="bg-white text-brand-900 px-4 py-2 rounded-xl font-semibold">
                Empezar ‚Üí
              </button>
            </div>
            
            <div>
              <h2 className="text-sm font-semibold text-brand-800 dark:text-gray-300 mb-3">Acciones r√°pidas</h2>
              <div className="grid grid-cols-3 gap-3">
                <QuickAction icon="üé§" label="Diario" onClick={()=>onNavigate('diario')} />
                <QuickAction icon="üé≤" label="Sorpr√©ndeme" onClick={()=>onNavigate('practica')} />
                <QuickAction icon="üè†" label="Mi trabajo" onClick={()=>onNavigate('practica')} />
              </div>
            </div>
            
            {dailyPhrase && (
              <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
                <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-2">Frase del d√≠a</h3>
                <p className="text-lg text-brand-900 dark:text-gray-100 mb-1">{flex(dailyPhrase.es, inclusive)}</p>
                <p className="text-sm text-brand-700 dark:text-gray-400 mb-2">{dailyPhrase.hint}</p>
                <p className="text-xs text-brand-700 dark:text-gray-500 italic mb-3">Contexto: {dailyPhrase.ctx}</p>
                <div className="flex gap-2">
                  <button onClick={()=>speak(flex(dailyPhrase.es, inclusive))} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                    üëÇ Escuchar
                  </button>
                  <button onClick={()=>{navigator.clipboard?.writeText(flex(dailyPhrase.es, inclusive)); showToast('Copiado', 'lassie');}} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                    üìã Copiar
                  </button>
                </div>
              </div>
            )}
            
            <div className="bg-gradient-to-br from-pink-100 to-purple-100 dark:from-pink-900 dark:to-purple-900 rounded-2xl p-4 border border-pink-300 dark:border-pink-700">
              <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-2">üíï Para Mia</h3>
              <p className="text-brand-900 dark:text-gray-200 mb-1">¬øC√≥mo te fue en Carleton hoy?</p>
              <p className="text-sm text-brand-700 dark:text-gray-400">(Ask about her day at work)</p>
            </div>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
              <div className="flex items-center gap-2 mb-2">
                <span className="text-2xl">{CATS[encouragement.cat].emoji}</span>
                <span className="font-semibold text-brand-900 dark:text-gray-100">{CATS[encouragement.cat].name}</span>
              </div>
              <p className="text-sm text-brand-700 dark:text-gray-300">{encouragement.text}</p>
            </div>
          </div>
        );
      }
      
      function QuickAction({ icon, label, onClick }){
        return (
          <button onClick={onClick} className="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-soft border border-brand-200 dark:border-gray-700 flex flex-col items-center gap-2 hover:bg-brand-50 dark:hover:bg-gray-700 transition-colors">
            <span className="text-3xl">{icon}</span>
            <span className="text-xs font-medium text-brand-900 dark:text-gray-100">{label}</span>
          </button>
        );
      }
      
      // Simple Practice Tab (keeping it lighter for now)
      function PracticaTab({ level, inclusive, recordings, setRecordings, onComplete, showToast }){
        const [track, setTrack] = useState(null);
        const [idx, setIdx] = useState(0);
        const [recording, setRecording] = useState(false);
        const [transcript, setTranscript] = useState('');
        const [result, setResult] = useState(null);
        const rec = useSpeechRecognition({ onResult:(t)=>setTranscript(t), onEnd:()=>setRecording(false) });
        
        if(!track){
          return (
            <div className="space-y-3">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Elige tema</h2>
              <div className="grid grid-cols-2 gap-3">
                {TRACKS.map(t => (
                  <button key={t.key} onClick={()=>setTrack(t.key)} className={cx('rounded-2xl p-6 text-white shadow-lg', t.color)}>
                    <div className="text-4xl mb-2">{t.icon}</div>
                    <div className="font-semibold">{t.name}</div>
                    <div className="text-xs opacity-90 mt-1">{t.desc}</div>
                  </button>
                ))}
              </div>
            </div>
          );
        }
        
        const sentences = SENTENCES[track].filter(s => s.lvl <= level);
        const phrase = sentences[idx];
        const done = idx >= sentences.length - 1;
        
        function handleRecord(){
          if(!rec.supported) return;
          if(!recording){ setTranscript(''); setResult(null); rec.start(); setRecording(true); }
          else {
            rec.stop();
            const { pass } = wordScore(flex(phrase.es, inclusive), transcript);
            setResult(pass);
            setRecordings(prev => [...prev, { 
              transcript, 
              target: phrase.es, 
              passed: pass, 
              timestamp: Date.now(),
              phraseId: phrase.id 
            }]);
            const cat = pass ? 'doom' : 'jules';
            showToast(pass ? 'De lujo!' : 'Casi, intenta otra vez', cat);
          }
        }
        
        function next(){
          if(done){ onComplete(); setTrack(null); setIdx(0); }
          else { setIdx(i=>i+1); setTranscript(''); setResult(null); }
        }
        
        return (
          <div>
            <button onClick={()=>setTrack(null)} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft border border-brand-200 dark:border-gray-700">
              <div className="text-xs text-brand-700 dark:text-gray-400 mb-2">{idx+1} / {sentences.length}</div>
              <p className="text-xl text-brand-900 dark:text-gray-100 mb-2">{flex(phrase.es, inclusive)}</p>
              <p className="text-sm text-brand-700 dark:text-gray-400 mb-2">{phrase.hint}</p>
              <p className="text-xs text-brand-700 dark:text-gray-500 italic mb-4">{phrase.ctx}</p>
              
              <div className="flex gap-2 mb-4">
                <button onClick={()=>speak(flex(phrase.es, inclusive))} className="px-4 py-2 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                  üëÇ
                </button>
                <button onClick={handleRecord} className={cx('flex-1 py-2 rounded-xl text-white', recording?'bg-rose-600':'bg-brand-900')}>
                  {recording ? '‚èπ Detener' : 'üé§ Grabar'}
                </button>
              </div>
              
              {transcript && (
                <div className="p-3 bg-brand-50 dark:bg-gray-700 rounded-lg mb-3">
                  <div className="text-xs text-brand-700 dark:text-gray-400 mb-1">Tu respuesta:</div>
                  <div className="text-sm text-brand-900 dark:text-gray-100">{transcript}</div>
                </div>
              )}
              
              {result !== null && (
                <div className={cx('p-3 rounded-xl mb-3', result?'bg-emerald-100 dark:bg-emerald-900 text-emerald-900 dark:text-emerald-100':'bg-amber-100 dark:bg-amber-900 text-amber-900 dark:text-amber-100')}>
                  {result ? '‚úì ¬°Qued√≥ chido!' : '‚óª Poquito m√°s'}
                </div>
              )}
              
              <button onClick={next} className="w-full py-2 rounded-xl bg-brand-900 text-white">
                {done ? 'Terminar' : 'Siguiente ‚Üí'}
              </button>
            </div>
          </div>
        );
      }
      
      // Simple Diario Tab
      function DiarioTab({ journals, setJournals, inclusive, showToast }){
        const [recording, setRecording] = useState(false);
        const [transcript, setTranscript] = useState('');
        const [currentPrompt] = useState(VOICE_PROMPTS[Math.floor(Math.random()*VOICE_PROMPTS.length)]);
        const rec = useSpeechRecognition({ onResult:(t)=>setTranscript(t), onEnd:()=>setRecording(false) });
        
        function handleRecord(){
          if(!rec.supported) return;
          if(!recording){ setTranscript(''); rec.start(); setRecording(true); }
          else {
            rec.stop();
            if(transcript){
              setJournals(prev => [...prev, { text: transcript, timestamp: Date.now() }]);
              setTranscript('');
              showToast('Guardado como frijoles en el refri', 'doom');
            }
          }
        }
        
        return (
          <div className="space-y-4">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft border border-brand-200 dark:border-gray-700">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-2">Mi diario üé§</h2>
              <p className="text-brand-700 dark:text-gray-300 mb-4">{currentPrompt}</p>
              
              <button 
                onClick={handleRecord}
                className={cx('w-full py-4 rounded-xl text-white font-semibold text-lg', recording?'bg-rose-600':'bg-brand-900')}
              >
                {recording ? '‚èπ Detener' : 'üé§ Empezar'}
              </button>
              
              {transcript && (
                <div className="mt-4 p-4 bg-brand-50 dark:bg-gray-700 rounded-xl">
                  <p className="text-brand-900 dark:text-gray-100">{transcript}</p>
                </div>
              )}
            </div>
            
            <div>
              <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-3">Entradas recientes</h3>
              {journals.length === 0 ? (
                <p className="text-center text-brand-700 dark:text-gray-400 py-8">Todav√≠a no hay nada. ¬°Empieza!</p>
              ) : (
                <div className="space-y-3">
                  {journals.slice().reverse().slice(0,5).map((j,idx)=>(
                    <div key={idx} className="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
                      <div className="text-xs text-brand-700 dark:text-gray-400 mb-2">
                        {new Date(j.timestamp).toLocaleDateString('es-MX')}
                      </div>
                      <p className="text-brand-900 dark:text-gray-100">{j.text}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      }
      
      // Stats Tab
      function StatsTab({ sessions, streak, badges, recordings }){
        const weeklyReport = useWeeklyReport();
        const report = weeklyReport.getWeeklyReport();
        const masteredCount = recordings.filter(r => r.passed).length;
        
        const last7Days = Array.from({length: 7}, (_, i) => {
          const date = daysAgo(6-i);
          const count = recordings.filter(r => {
            const rDate = new Date(r.timestamp).toISOString().slice(0,10);
            return rDate === date;
          }).length;
          return { date: new Date(date).toLocaleDateString('es-MX', {weekday:'short'}), count };
        });
        const maxCount = Math.max(...last7Days.map(d=>d.count), 1);
        
        return (
          <div className="space-y-4">
            <div className="bg-gradient-to-br from-blossom-600 to-brand-900 text-white rounded-2xl p-6 shadow-lg">
              <h2 className="text-xl font-bold mb-4">üìà Esta semana</h2>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="text-3xl font-bold">{report.thisWeekCount}</div>
                  <div className="text-sm opacity-90">Pr√°cticas</div>
                </div>
                <div>
                  <div className="text-3xl font-bold">{Math.round(report.thisWeekRate*100)}%</div>
                  <div className="text-sm opacity-90">√âxito</div>
                </div>
              </div>
            </div>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700">
              <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-4">√öltimos 7 d√≠as</h3>
              <div className="flex items-end justify-between gap-2 h-32">
                {last7Days.map((day, i) => (
                  <div key={i} className="flex-1 flex flex-col items-center gap-1">
                    <div className="flex-1 w-full flex items-end">
                      <div 
                        className="w-full bg-brand-900 dark:bg-brand-600 rounded-t"
                        style={{height: `${(day.count/maxCount)*100}%`, minHeight: day.count>0?'8px':'0'}}
                      />
                    </div>
                    <div className="text-xs text-brand-700 dark:text-gray-400">{day.date}</div>
                  </div>
                ))}
              </div>
            </div>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft border border-brand-200 dark:border-gray-700">
              <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-4">Insignias üåÆ</h3>
              <div className="grid grid-cols-3 gap-3">
                {BADGES.map(badge => {
                  const earned = badges.earned.includes(badge.id);
                  return (
                    <div key={badge.id} className={cx('p-4 rounded-xl text-center', earned?'bg-pink-100 dark:bg-pink-900 badge-earned':'bg-gray-100 dark:bg-gray-700 opacity-50')}>
                      <div className="text-4xl mb-2">{badge.emoji}</div>
                      <div className="text-xs font-semibold text-brand-900 dark:text-gray-100">{badge.name}</div>
                      {earned && badge.tooltip && (
                        <div className="text-xs text-brand-700 dark:text-gray-400 mt-1">{badge.tooltip}</div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }
      
      // Mas Tab
      function MasTab({ level, setLevel, inclusive, setInclusive, darkMode, setDarkMode }){
        const [showTips, setShowTips] = useState(false);
        
        if(showTips){
          return (
            <div>
              <button onClick={()=>setShowTips(false)} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Tips culturales</h2>
              <div className="space-y-3">
                {CULTURAL_TIPS.map(tip => (
                  <div key={tip.id} className="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
                    <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-2">{tip.title}</h3>
                    <p className="text-sm text-brand-700 dark:text-gray-300">{tip.content}</p>
                  </div>
                ))}
              </div>
            </div>
          );
        }
        
        return (
          <div className="space-y-4">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Ajustes</h2>
              
              <div className="space-y-3">
                <div className="flex items-center justify-between py-2 border-b border-brand-200 dark:border-gray-700">
                  <span className="text-brand-900 dark:text-gray-100">Nivel</span>
                  <select value={level} onChange={e=>setLevel(parseInt(e.target.value))} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                    <option value={0}>0 - Principiante</option>
                    <option value={1}>1 - Intermedio</option>
                    <option value={2}>2 - Avanzado</option>
                  </select>
                </div>
                
                <div className="flex items-center justify-between py-2 border-b border-brand-200 dark:border-gray-700">
                  <span className="text-brand-900 dark:text-gray-100">Lenguaje inclusivo</span>
                  <button onClick={()=>setInclusive(v=>!v)} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                    {inclusive ? 'S√≠' : 'No'}
                  </button>
                </div>
                
                <div className="flex items-center justify-between py-2">
                  <span className="text-brand-900 dark:text-gray-100">Modo oscuro üåô</span>
                  <button onClick={()=>setDarkMode(v=>!v)} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                    {darkMode ? 'S√≠' : 'No'}
                  </button>
                </div>
              </div>
            </div>
            
            <button onClick={()=>setShowTips(true)} className="w-full bg-blossom-600 text-white py-3 rounded-xl font-semibold">
              üìö Tips culturales
            </button>
            
            <div className="text-center space-y-2 py-4">
              <div className="flex justify-center gap-4 text-2xl">
                <span title="Otis">üê±</span>
                <span title="Doom">üêà</span>
                <span title="Jules">üêæ</span>
                <span title="Lassie">üò∏</span>
              </div>
              <div className="text-xs text-brand-700 dark:text-gray-400">
                hecho con cari√±o para stacie ¬∑ v5.0
              </div>
            </div>
          </div>
        );
      }
      
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
