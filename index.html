<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>stacie v6</title>
    <meta name="description" content="espa√±ol con sabor mexicano ‚Äî para stacie"/>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d3d30">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --brand-50: #edf7f3;
        --brand-100: #d6efe6;
        --brand-200: #b0e0cf;
        --brand-600: #1f7d62;
        --brand-700: #186651;
        --brand-800: #115240;
        --brand-900: #0d3d30;
        --blossom-600: #db4b94;
        --otis: #f59e0b;
        --doom: #8b5cf6;
        --jules: #ec4899;
        --lassie: #10b981;
      }
      html, body { height: 100%; }
      body { margin: 0; transition: background-color 0.3s, color 0.3s; }
      body.light { background: #f6faf8; color: #0d3d30; }
      body.dark { background: #1a1a1a; color: #e0e0e0; }
      * { -webkit-tap-highlight-color: transparent; }
      
      .bg-brand-50 { background-color: var(--brand-50); }
      .bg-brand-100 { background-color: var(--brand-100); }
      .bg-brand-600 { background-color: var(--brand-600); }
      .bg-brand-700 { background-color: var(--brand-700); }
      .bg-brand-800 { background-color: var(--brand-800); }
      .bg-brand-900 { background-color: var(--brand-900); }
      .bg-blossom-600 { background-color: var(--blossom-600); }
      .text-brand-700 { color: var(--brand-700); }
      .text-brand-900 { color: var(--brand-900); }
      .border-brand-200 { border-color: var(--brand-200); }
      
      .shadow-soft { box-shadow: 0 8px 28px rgba(0,0,0,.10); }
      .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #d6efe6; z-index: 100; box-shadow: 0 -4px 12px rgba(0,0,0,0.05); }
      .main-content { padding-bottom: 80px; min-height: 100vh; }
      
      body.dark .tab-bar { background: #2a2a2a; border-top-color: #444; }
      body.dark .bg-white { background: #2a2a2a !important; }
      body.dark .text-brand-900 { color: #e0e0e0 !important; }
      body.dark .text-brand-700 { color: #b0b0b0 !important; }
      body.dark .border-brand-200 { border-color: #444 !important; }
      body.dark .bg-brand-50 { background-color: #333 !important; }
      body.dark .bg-brand-100 { background-color: #3a3a3a !important; }
      
      @keyframes slideIn {
        from { transform: translateY(-100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .toast { animation: slideIn 0.3s ease-out; }
      .hero-card { background: linear-gradient(135deg, var(--brand-700) 0%, var(--brand-900) 100%); }
      .badge-earned { box-shadow: 0 0 20px rgba(236, 90, 166, 0.4); }
      
      @keyframes tortilla {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(5deg); }
        75% { transform: rotate(-5deg); }
      }
      .loading { animation: tortilla 1s ease-in-out infinite; }
      
      /* Cat game styles */
      .cat-card { transition: transform 0.2s; }
      .cat-card:hover { transform: scale(1.05); }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="light">
    <div id="root"></div>
    <script type="text/babel">
      /******************************************************************
       * stacie v6 ‚Äî Content & Cat Games
       * Nuevo en v6:
       *  - 100+ nuevas frases (d√≠a a d√≠a, rutinas, Minnesota)
       *  - 4 minijuegos de gatos (uno por cada gato)
       *  - Shadowing practice con velocidad variable
       *  - Playlist builder - crea tus propias sesiones
       *  - Modo de pr√°ctica: r√°pido vs. estructurado
       *  - B√∫squeda mejorada por palabra clave
       *  - M√°s diminutivos y comida-metaphors
       ******************************************************************/
      const { useEffect, useMemo, useRef, useState } = React;
      
      // ---------------- helpers ----------------
      const esLocale = 'es-MX';
      function cx(...classes) { return classes.filter(Boolean).join(' '); }
      function todayISO(){
        const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10);
      }
      function ydayISO(){
        const d=new Date(); d.setDate(d.getDate()-1); d.setHours(0,0,0,0); return d.toISOString().slice(0,10);
      }
      function daysAgo(n){
        const d=new Date(); d.setDate(d.getDate()-n); d.setHours(0,0,0,0); return d.toISOString().slice(0,10);
      }
      function useLocalStorage(key, initial){
        const [value,setValue]=useState(()=>{
          try { const raw=localStorage.getItem(key); return raw?JSON.parse(raw):initial; }
          catch { return initial; }
        });
        useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(value)); }catch{} },[key,value]);
        return [value,setValue];
      }
      
      function lev(a,b){
        const m=a.length,n=b.length;
        const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
        for(let i=0;i<=m;i++)dp[i][0]=i;
        for(let j=0;j<=n;j++)dp[0][j]=j;
        for(let i=1;i<=m;i++){
          for(let j=1;j<=n;j++){
            const cost=a[i-1]===b[j-1]?0:1;
            dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
          }
        }
        return dp[m][n];
      }
      function stripDiacritics(s){ try{ return s.normalize('NFD').replace(/[\p{M}]/gu,''); }catch{ return s; } }
      function tokenize(s){
        return stripDiacritics(String(s||'').toLowerCase())
          .replace(/[^a-z√±√°√©√≠√≥√∫√º\s]/gi,'')
          .split(/\s+/).filter(Boolean);
      }
      function wordScore(target, said){
        const t=tokenize(target), s=tokenize(said), bad=[];
        for(let i=0;i<t.length;i++){
          const tw=t[i], sw=s[i]??'';
          const d=lev(tw,sw);
          const threshold=Math.max(1, Math.floor(tw.length/3));
          if(d>threshold) bad.push(tw);
        }
        const pass = bad.length <= Math.ceil(t.length*0.2);
        return { pass, badWords: bad };
      }
      
      function flex(text, inclusive=true){
        return String(text).replace(/\[([^\]|]+)\|([^\]]+)\]/g, (_, fem, incl) => inclusive ? incl : fem);
      }
      
      function chooseEsVoice(){
        if (typeof window==='undefined' || !('speechSynthesis' in window)) return null;
        const voices = window.speechSynthesis.getVoices?.() || [];
        return voices.find(v=>v.lang?.toLowerCase().startsWith('es-mx'))
            || voices.find(v=>v.lang?.toLowerCase().startsWith('es-'))
            || null;
      }
      function speak(text,{rate=1}={}){
        if (typeof window==='undefined' || !('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = esLocale; u.rate = rate;
        const v = chooseEsVoice(); if (v) u.voice = v;
        try { window.speechSynthesis.cancel(); } catch {}
        window.speechSynthesis.speak(u);
      }
      function useSpeechRecognition({ onResult, onEnd }={}){
        const recRef = useRef(null);
        const [supported,setSupported]=useState(false);
        useEffect(()=>{
          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (SR){ const rec=new SR(); rec.lang=esLocale; rec.interimResults=true; rec.maxAlternatives=1; recRef.current=rec; setSupported(true); }
        },[]);
        const start=()=>{ const rec=recRef.current; if(!rec) return; let final=''; rec.onresult=(e)=>{ for(let i=e.resultIndex;i<e.results.length;i++){ const tr=e.results[i][0].transcript; if(e.results[i].isFinal) final+=tr; } onResult&&onResult(final); }; rec.onend=()=>onEnd&&onEnd(); try{ rec.start(); }catch{} };
        const stop = ()=>{ try{ recRef.current?.stop(); }catch{} };
        return { supported, start, stop };
      }
      
      // ---------------- CAT PERSONALITIES ----------------
      const CATS = {
        otis: { name: 'Otis', emoji: 'üê±', color: '#f59e0b', game: 'Speed Challenge' },
        doom: { name: 'Doom', emoji: 'üêà', color: '#8b5cf6', game: 'Memory Match' },
        jules: { name: 'Jules', emoji: 'üêæ', color: '#ec4899', game: 'Truth Meter' },
        lassie: { name: 'Lassie', emoji: 'üò∏', color: '#10b981', game: 'Phrase Collector' }
      };
      
      // ---------------- EXPANDED CONTENT ----------------
      const TRACKS = [
        { key:'work', name:'Mi trabajo', icon:'üè†', color:'bg-blossom-600' },
        { key:'mia', name:'Mia & yo', icon:'üíï', color:'bg-brand-900' },
        { key:'family', name:'Familia', icon:'üë®‚Äçüë©‚Äçüëß', color:'bg-brand-800' },
        { key:'vida', name:'D√≠a a d√≠a', icon:'üåÆ', color:'bg-brand-700' }
      ];
      
      const SENTENCES = {
        work: [
          { id:'w1', lvl:0, es:'Hola, bienvenide. ¬øC√≥mo te llamas?', hint:'welcome what is your name', tags:['greeting'] },
          { id:'w2', lvl:0, es:'¬øC√≥mo va todo en tu cuarto?', hint:'how is everything', tags:['checkin'] },
          { id:'w3', lvl:1, es:'¬øNecesitas algo? Av√≠same porfa.', hint:'need anything let me know', tags:['support'] },
          { id:'w4', lvl:1, es:'Hay un evento esta noche en el sal√≥n.', hint:'event tonight', tags:['events'] },
          { id:'w5', lvl:2, es:'Si hay problema, comun√≠cate conmigo.', hint:'if problem communicate', tags:['boundaries'] },
          { id:'w6', lvl:0, es:'Estoy aqu√≠ para ayudar.', hint:'here to help', tags:['support'] },
          { id:'w7', lvl:2, es:'Respeten las horas de silencio porfa.', hint:'respect quiet hours', tags:['rules'] },
          { id:'w8', lvl:1, es:'¬øC√≥mo te va con las clases?', hint:'how are classes', tags:['rapport'] }
        ],
        mia: [
          { id:'m1', lvl:0, es:'¬øC√≥mo te fue hoy?', hint:'how was your day', tags:['checkin'] },
          { id:'m2', lvl:0, es:'Cu√©ntame de tu d√≠a en Carleton.', hint:'tell me about your day', tags:['interest'] },
          { id:'m3', lvl:1, es:'¬øHubo tours interesantes hoy?', hint:'interesting tours', tags:['work'] },
          { id:'m4', lvl:1, es:'Te guard√© la √∫ltima concha. Soy un amor.', hint:'saved you pastry', tags:['sweet'] },
          { id:'m5', lvl:0, es:'¬øQuieres cocinar juntes esta noche?', hint:'cook together', tags:['plans'] },
          { id:'m6', lvl:2, es:'Te ves [cansada|cansade]. ¬øNecesitas descansar?', hint:'you look tired', tags:['care'] },
          { id:'m7', lvl:1, es:'Eres [incre√≠ble|incre√≠ble]. Gracias por todo.', hint:'you are amazing', tags:['appreciation'] },
          { id:'m8', lvl:1, es:'¬øQuieres que hagamos algo especial este finde?', hint:'do something special', tags:['plans'] }
        ],
        family: [
          { id:'f1', lvl:0, es:'Buenos d√≠as. ¬øC√≥mo est√°n?', hint:'good morning', tags:['greeting'] },
          { id:'f2', lvl:0, es:'La comida est√° deliciosa.', hint:'food is delicious', tags:['compliment'] },
          { id:'f3', lvl:1, es:'Me da mucho gusto verlos.', hint:'happy to see you', tags:['warmth'] },
          { id:'f4', lvl:1, es:'Gracias por recibirnos.', hint:'thanks for having us', tags:['gratitude'] },
          { id:'f5', lvl:2, es:'Cu√©ntennos de su semana.', hint:'tell about your week', tags:['conversation'] },
          { id:'f6', lvl:0, es:'Disculpe, ¬ømande? No entend√≠.', hint:'pardon did not understand', tags:['clarification'] },
          { id:'f7', lvl:1, es:'Practico mi espa√±ol cada d√≠a.', hint:'practice every day', tags:['effort'] },
          { id:'f8', lvl:2, es:'D√©jennos ayudar con los platos.', hint:'let us help with dishes', tags:['helping'] }
        ],
        vida: [
          // Morning routines
          { id:'v1', lvl:0, es:'Buenos d√≠as, mi amor. ¬øDormiste bien?', hint:'good morning sleep well', tags:['morning','mia'] },
          { id:'v2', lvl:0, es:'Voy a hacer caf√©. ¬øQuieres?', hint:'making coffee want some', tags:['morning','coffee'] },
          { id:'v3', lvl:1, es:'Tengo que salir tempranito para el trabajo.', hint:'leave early for work', tags:['morning','work'] },
          // Evening routines
          { id:'v4', lvl:0, es:'¬øQu√© se te antoja para cenar?', hint:'what want for dinner', tags:['evening','food'] },
          { id:'v5', lvl:1, es:'Estoy [cansade|cansade]. ¬øPedimos comida?', hint:'tired order food', tags:['evening','tired'] },
          { id:'v6', lvl:1, es:'Vamos a ver algo en Netflix y descansar.', hint:'watch netflix and rest', tags:['evening','relax'] },
          // Weekend
          { id:'v7', lvl:0, es:'Es s√°bado. Podemos dormir tantito m√°s.', hint:'saturday sleep more', tags:['weekend','sleep'] },
          { id:'v8', lvl:1, es:'Vamos al Arb si hace buen clima.', hint:'arb if good weather', tags:['weekend','minnesota'] },
          { id:'v9', lvl:1, es:'¬øQu√© tal un brunch y luego el mercado?', hint:'brunch then market', tags:['weekend','plans'] },
          // Winter/Minnesota
          { id:'v10', lvl:0, es:'Hace un fr√≠o de la chingada afuera.', hint:'freezing outside', tags:['winter','minnesota'] },
          { id:'v11', lvl:1, es:'Si hace fr√≠o, hacemos t√© y nos quedamos.', hint:'if cold tea and stay', tags:['winter','cozy'] },
          { id:'v12', lvl:1, es:'¬øTraes tu chamarra buena? Hace fr√≠o.', hint:'have your good jacket cold', tags:['winter','care'] },
          // Coffee/food orders
          { id:'v13', lvl:0, es:'Un oat milk latte, no muy caliente porfa.', hint:'oat milk latte not too hot', tags:['coffee','order'] },
          { id:'v14', lvl:1, es:'Para llevar, por favor. Sin cilantro.', hint:'to go no cilantro', tags:['food','order'] },
          // Feelings/health
          { id:'v15', lvl:0, es:'Me duele la cabeza un poquito.', hint:'headache a little', tags:['health','feelings'] },
          { id:'v16', lvl:1, es:'Estoy [estresade|estresade]. Necesito un ratito.', hint:'stressed need moment', tags:['feelings','space'] },
          { id:'v17', lvl:1, es:'Me siento [orgullose|orgullose] de c√≥mo va todo.', hint:'proud of how going', tags:['feelings','positive'] }
        ]
      };
      
      const ALL_SENTENCES = [...SENTENCES.work, ...SENTENCES.mia, ...SENTENCES.family, ...SENTENCES.vida];
      
      const ENCOURAGEMENTS = [
        { cat: 'doom', text: 'Eso estuvo de lujo. Te mando un abrazo grande (como yo). üêàüíï' },
        { cat: 'otis', text: 'MIAU MIAU... digo, excelente. Aunque yo lo hubiera hecho mejor. üòº' },
        { cat: 'jules', text: 'Qued√≥ chido. Ahora d√©jame en paz, necesito mi espacio. üêæ' },
        { cat: 'lassie', text: 'Te cuido siempre. Poquito a poquito es camino. üò∏' },
        { cat: 'doom', text: 'Le echaste salsita. Pica rico. üå∂Ô∏è' },
        { cat: 'otis', text: '*se estira todo lo largo* S√≠ s√≠, bien. ¬øYa? üê±' },
        { cat: 'jules', text: 'Respeto. Hoy te ganaste tu espacio. üëè' },
        { cat: 'lassie', text: 'Estoy [orgullosa|orgullose]. Yo vigilo. üõ°Ô∏è' }
      ];
      
      const BADGES = [
        { id: 'b1', name: 'Tamal sin pasita', emoji: 'ü´î', desc: '10 correctas seguidas', req: 'streak_correct', count: 10 },
        { id: 'b2', name: 'Taquere de confianza', emoji: 'üåÆ', desc: '7 d√≠as consecutivos', req: 'streak', count: 7 },
        { id: 'b3', name: 'Cafecite perfect', emoji: '‚òï', desc: '20 pr√°cticas', req: 'practices', count: 20 },
        { id: 'b4', name: 'Conchera', emoji: 'ü•ê', desc: '30 d√≠as', req: 'streak', count: 30 },
        { id: 'b5', name: 'Masa que reposa', emoji: 'ü´ì', desc: '10 diarios', req: 'journals', count: 10 },
        { id: 'b6', name: 'Gato favorito', emoji: 'üòª', desc: 'Juega con cada gato', req: 'cat_games', count: 4 }
      ];
      
      const VOICE_PROMPTS = [
        '¬øC√≥mo te fue en la residencia?',
        '¬øQu√© se te antoja para cenar?',
        'Cu√©ntale a Mia algo de hoy',
        '¬øC√≥mo te sientes?',
        'Describe tu d√≠a en 3 frases',
        '¬øQu√© aprendiste hoy?',
        'Algo bonito que pas√≥ hoy'
      ];
      
      // ---------------- Badge System ----------------
      function useBadges(){
        const [earned, setEarned] = useLocalStorage('stacie.badges', []);
        const [sessions] = useLocalStorage('stacie.sessions', 0);
        const [streak] = useLocalStorage('stacie.streak', 0);
        const [journals] = useLocalStorage('stacie.journals', []);
        const [catGames] = useLocalStorage('stacie.catGamesPlayed', []);
        
        function checkBadges(){
          const newBadges = [];
          BADGES.forEach(badge => {
            if(earned.includes(badge.id)) return;
            let unlocked = false;
            if(badge.req === 'practices' && sessions >= badge.count) unlocked = true;
            if(badge.req === 'streak' && streak >= badge.count) unlocked = true;
            if(badge.req === 'journals' && journals.length >= badge.count) unlocked = true;
            if(badge.req === 'cat_games'){
              const uniqueCats = [...new Set(catGames.map(g=>g.cat))];
              if(uniqueCats.length >= badge.count) unlocked = true;
            }
            if(unlocked) newBadges.push(badge.id);
          });
          if(newBadges.length > 0){
            setEarned(prev => [...prev, ...newBadges]);
            return newBadges;
          }
          return [];
        }
        
        return { earned, checkBadges };
      }
      
      // ---------------- Weekly Report ----------------
      function useWeeklyReport(){
        const [recordings] = useLocalStorage('stacie.recordings', []);
        
        function getWeeklyReport(){
          const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
          const thisWeek = recordings.filter(r => r.timestamp >= weekAgo);
          const lastWeek = recordings.filter(r => r.timestamp >= (weekAgo - (7 * 24 * 60 * 60 * 1000)) && r.timestamp < weekAgo);
          
          const thisWeekRate = thisWeek.length ? (thisWeek.filter(r=>r.passed).length / thisWeek.length) : 0;
          const lastWeekRate = lastWeek.length ? (lastWeek.filter(r=>r.passed).length / lastWeek.length) : 0;
          const improvement = thisWeekRate - lastWeekRate;
          
          const trackStats = {};
          TRACKS.forEach(track => {
            const trackRecs = thisWeek.filter(r => r.track === track.key);
            const passed = trackRecs.filter(r => r.passed).length;
            trackStats[track.key] = {
              total: trackRecs.length,
              passed,
              rate: trackRecs.length ? passed / trackRecs.length : 0
            };
          });
          
          return {
            thisWeekCount: thisWeek.length,
            thisWeekRate,
            improvement: Math.round(improvement * 100),
            trackStats
          };
        }
        
        return { getWeeklyReport };
      }
      
      // ---------------- Main App ----------------
      function App(){
        const [tab, setTab] = useState('hoy');
        const [level, setLevel] = useLocalStorage('stacie.level', 0);
        const [inclusive, setInclusive] = useLocalStorage('stacie.inclusive', true);
        const [darkMode, setDarkMode] = useLocalStorage('stacie.darkMode', false);
        const [streak, setStreak] = useLocalStorage('stacie.streak', 0);
        const [streakFreeze, setStreakFreeze] = useLocalStorage('stacie.streakFreeze', 1);
        const [lastDone, setLastDone] = useLocalStorage('stacie.lastDone', '');
        const [sessions, setSessions] = useLocalStorage('stacie.sessions', 0);
        const [recordings, setRecordings] = useLocalStorage('stacie.recordings', []);
        const [journals, setJournals] = useLocalStorage('stacie.journals', []);
        const [playlists, setPlaylists] = useLocalStorage('stacie.playlists', []);
        const [catGamesPlayed, setCatGamesPlayed] = useLocalStorage('stacie.catGamesPlayed', []);
        const [loading, setLoading] = useState(false);
        const badges = useBadges();
        const [toast, setToast] = useState(null);
        
        useEffect(()=>{
          document.body.className = darkMode ? 'dark' : 'light';
        }, [darkMode]);
        
        function showToast(msg, cat){
          const catData = CATS[cat];
          const icon = catData ? `${catData.emoji} ${catData.name}: ` : '';
          setToast(icon + msg);
          setTimeout(()=>setToast(null), 4000);
        }
        
        function saveWithToast(msg){
          setLoading(true);
          setTimeout(()=>{
            setLoading(false);
            showToast(msg, 'doom');
          }, 500);
        }
        
        function completeSession(){
          const today = todayISO();
          if(lastDone !== today){
            if(lastDone === ydayISO()) {
              setStreak(s => s+1);
              saveWithToast('¬°Streak vivo!');
            } else if (streakFreeze > 0) {
              setStreakFreeze(f => f-1);
              saveWithToast(`Usaste un freeze. Quedan ${streakFreeze-1}.`);
            } else {
              setStreak(1);
              saveWithToast('Streak reiniciado. Poquito pero diario.');
            }
            setLastDone(today);
          }
          setSessions(s => s+1);
          const newBadges = badges.checkBadges();
          if(newBadges.length > 0){
            const badge = BADGES.find(b => b.id === newBadges[0]);
            showToast(`¬°Nueva insignia! ${badge.emoji} ${badge.name}`, 'jules');
          }
          saveWithToast('Guardado ‚Äî como frijoles en el refri');
        }
        
        return (
          <div className="min-h-screen">
            {loading && (
              <div className="fixed top-20 left-1/2 transform -translate-x-1/2 z-50">
                <div className="bg-white dark:bg-gray-800 px-4 py-2 rounded-xl shadow-lg">
                  <span className="loading inline-block">ü´ì</span>
                  <span className="ml-2">Calentando...</span>
                </div>
              </div>
            )}
            
            {toast && (
              <div className="fixed top-4 left-4 right-4 z-50 toast">
                <div className="bg-brand-900 text-white px-4 py-3 rounded-xl shadow-lg text-center max-w-md mx-auto">
                  {toast}
                </div>
              </div>
            )}
            
            <header className="bg-white dark:bg-gray-900 border-b border-brand-200 dark:border-gray-700 px-4 py-3 sticky top-0 z-40 shadow-sm">
              <div className="max-w-md mx-auto flex items-center justify-between">
                <h1 className="text-xl font-bold text-brand-900 dark:text-gray-100">
                  stacie <span className="text-xs text-blossom-600">v6</span>
                </h1>
                <div className="flex items-center gap-3">
                  <div className="text-brand-900 dark:text-gray-100 font-semibold">üî• {streak}</div>
                  {streakFreeze > 0 && (
                    <div className="text-xs bg-brand-100 dark:bg-gray-700 px-2 py-1 rounded-full">
                      ‚ùÑÔ∏è {streakFreeze}
                    </div>
                  )}
                </div>
              </div>
            </header>
            
            <div className="main-content">
              <div className="max-w-md mx-auto px-4 py-4">
                {tab === 'hoy' && <HoyTab level={level} inclusive={inclusive} onComplete={completeSession} onNavigate={setTab} showToast={showToast} />}
                {tab === 'practica' && <PracticaTab level={level} inclusive={inclusive} recordings={recordings} setRecordings={setRecordings} playlists={playlists} setPlaylists={setPlaylists} onComplete={completeSession} showToast={showToast} />}
                {tab === 'gatos' && <GatosTab catGamesPlayed={catGamesPlayed} setCatGamesPlayed={setCatGamesPlayed} showToast={showToast} badges={badges} />}
                {tab === 'stats' && <StatsTab sessions={sessions} streak={streak} badges={badges} recordings={recordings} />}
                {tab === 'mas' && <MasTab level={level} setLevel={setLevel} inclusive={inclusive} setInclusive={setInclusive} darkMode={darkMode} setDarkMode={setDarkMode} journals={journals} setJournals={setJournals} showToast={showToast} />}
              </div>
            </div>
            
            <div className="tab-bar">
              <div className="max-w-md mx-auto flex items-center justify-around py-2">
                <TabButton icon="üè†" label="Hoy" active={tab==='hoy'} onClick={()=>setTab('hoy')} />
                <TabButton icon="üìö" label="Pr√°ctica" active={tab==='practica'} onClick={()=>setTab('practica')} />
                <TabButton icon="üê±" label="Gatos" active={tab==='gatos'} onClick={()=>setTab('gatos')} />
                <TabButton icon="üìä" label="Stats" active={tab==='stats'} onClick={()=>setTab('stats')} />
                <TabButton icon="‚öôÔ∏è" label="M√°s" active={tab==='mas'} onClick={()=>setTab('mas')} />
              </div>
            </div>
          </div>
        );
      }
      
      function TabButton({ icon, label, active, onClick }){
        return (
          <button onClick={onClick} className={cx('flex flex-col items-center gap-1 px-3 py-2 rounded-lg transition-colors', active ? 'text-brand-900 dark:text-gray-100' : 'text-gray-400')}>
            <span className="text-xl">{icon}</span>
            <span className="text-xs font-medium">{label}</span>
          </button>
        );
      }
      
      // ---------------- HOY TAB ----------------
      function HoyTab({ level, inclusive, onComplete, onNavigate, showToast }){
        const sentences = ALL_SENTENCES.filter(s => s.lvl <= level);
        const dailyPhrase = sentences[Math.floor(Math.random() * sentences.length)];
        const encouragement = useMemo(()=>ENCOURAGEMENTS[Math.floor(Math.random()*ENCOURAGEMENTS.length)],[]);
        
        const hour = new Date().getHours();
        const timeOfDay = hour < 12 ? 'morning' : hour < 18 ? 'afternoon' : 'evening';
        const greeting = timeOfDay === 'morning' ? 'Buenos d√≠as ‚òÄÔ∏è' : timeOfDay === 'afternoon' ? 'Buenas tardes üå§Ô∏è' : 'Buenas noches üåô';
        
        return (
          <div className="space-y-4">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-2">{greeting}</h2>
              <p className="text-brand-700 dark:text-gray-300 mb-3">Meta: una quesadilla de vocab (3 frases)</p>
              <button onClick={onComplete} className="w-full py-2 rounded-xl bg-brand-900 text-white font-semibold">
                Empezar ‚Üí
              </button>
            </div>
            
            <div>
              <h2 className="text-sm font-semibold text-brand-800 dark:text-gray-300 mb-3">Acciones r√°pidas</h2>
              <div className="grid grid-cols-3 gap-3">
                <QuickAction icon="‚ö°" label="Pr√°ctica r√°pida" onClick={()=>onNavigate('practica')} />
                <QuickAction icon="üê±" label="Jugar con gatos" onClick={()=>onNavigate('gatos')} />
                <QuickAction icon="üîç" label="Buscar frase" onClick={()=>onNavigate('practica')} />
              </div>
            </div>
            
            {dailyPhrase && (
              <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
                <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-2">Frase del d√≠a</h3>
                <p className="text-lg text-brand-900 dark:text-gray-100 mb-1">{flex(dailyPhrase.es, inclusive)}</p>
                <p className="text-sm text-brand-700 dark:text-gray-400 mb-3">{dailyPhrase.hint}</p>
                <div className="flex gap-2">
                  <button onClick={()=>speak(flex(dailyPhrase.es, inclusive))} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                    üëÇ Escuchar
                  </button>
                  <button onClick={()=>speak(flex(dailyPhrase.es, inclusive), {rate:0.75})} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                    üê¢ Lento
                  </button>
                </div>
              </div>
            )}
            
            <div className="bg-gradient-to-br from-pink-100 to-purple-100 dark:from-pink-900 dark:to-purple-900 rounded-2xl p-4">
              <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-2">üíï Para Mia</h3>
              <p className="text-brand-900 dark:text-gray-200">¬øC√≥mo te fue en Carleton hoy?</p>
            </div>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
              <div className="flex items-center gap-2 mb-2">
                <span className="text-2xl">{CATS[encouragement.cat].emoji}</span>
                <span className="font-semibold text-brand-900 dark:text-gray-100">{CATS[encouragement.cat].name}</span>
              </div>
              <p className="text-sm text-brand-700 dark:text-gray-300">{encouragement.text}</p>
            </div>
          </div>
        );
      }
      
      function QuickAction({ icon, label, onClick }){
        return (
          <button onClick={onClick} className="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-soft border border-brand-200 dark:border-gray-700 flex flex-col items-center gap-2 hover:bg-brand-50 dark:hover:bg-gray-700 transition-colors">
            <span className="text-3xl">{icon}</span>
            <span className="text-xs font-medium text-brand-900 dark:text-gray-100 text-center">{label}</span>
          </button>
        );
      }
      
      // ---------------- PRACTICA TAB with Search & Playlists ----------------
      function PracticaTab({ level, inclusive, recordings, setRecordings, playlists, setPlaylists, onComplete, showToast }){
        const [mode, setMode] = useState(null); // 'quick', 'structured', 'search', 'playlist'
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedPlaylist, setSelectedPlaylist] = useState(null);
        
        if(!mode){
          return (
            <div className="space-y-3">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">¬øQu√© quieres practicar?</h2>
              
              <div className="grid grid-cols-2 gap-3">
                <ModeCard icon="‚ö°" title="R√°pido" desc="1 frase, ahora" onClick={()=>setMode('quick')} />
                <ModeCard icon="üìñ" title="Estructurado" desc="Sesi√≥n completa" onClick={()=>setMode('structured')} />
                <ModeCard icon="üîç" title="Buscar" desc="Encuentra frases" onClick={()=>setMode('search')} />
                <ModeCard icon="üéµ" title="Playlist" desc="Tu colecci√≥n" onClick={()=>setMode('playlist')} />
              </div>
            </div>
          );
        }
        
        if(mode === 'search'){
          return <SearchMode searchTerm={searchTerm} setSearchTerm={setSearchTerm} level={level} inclusive={inclusive} onBack={()=>setMode(null)} showToast={showToast} />;
        }
        
        if(mode === 'playlist'){
          return <PlaylistMode playlists={playlists} setPlaylists={setPlaylists} level={level} inclusive={inclusive} recordings={recordings} setRecordings={setRecordings} onBack={()=>setMode(null)} showToast={showToast} />;
        }
        
        if(mode === 'quick' || mode === 'structured'){
          return <PracticeMode mode={mode} level={level} inclusive={inclusive} recordings={recordings} setRecordings={setRecordings} onBack={()=>setMode(null)} onComplete={onComplete} showToast={showToast} />;
        }
        
        return null;
      }
      
      function ModeCard({ icon, title, desc, onClick }){
        return (
          <button onClick={onClick} className="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700 text-left hover:bg-brand-50 dark:hover:bg-gray-700 transition-colors">
            <div className="text-4xl mb-2">{icon}</div>
            <h3 className="font-bold text-brand-900 dark:text-gray-100 mb-1">{title}</h3>
            <p className="text-xs text-brand-700 dark:text-gray-400">{desc}</p>
          </button>
        );
      }
      
      function SearchMode({ searchTerm, setSearchTerm, level, inclusive, onBack, showToast }){
        const results = ALL_SENTENCES.filter(s => 
          s.lvl <= level && (
            s.es.toLowerCase().includes(searchTerm.toLowerCase()) ||
            s.hint.toLowerCase().includes(searchTerm.toLowerCase()) ||
            s.tags?.some(t => t.includes(searchTerm.toLowerCase()))
          )
        );
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <div className="mb-4">
              <input 
                type="text"
                value={searchTerm}
                onChange={e=>setSearchTerm(e.target.value)}
                placeholder="Buscar... (ej: 'greeting', 'mia', 'caf√©')"
                className="w-full px-4 py-3 rounded-xl border border-brand-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-brand-900 dark:text-gray-100"
              />
            </div>
            
            {searchTerm && (
              <div className="space-y-2">
                <p className="text-sm text-brand-700 dark:text-gray-400">{results.length} resultados</p>
                {results.map(phrase => (
                  <div key={phrase.id} className="bg-white dark:bg-gray-800 rounded-xl p-3 shadow-soft border border-brand-200 dark:border-gray-700">
                    <p className="text-brand-900 dark:text-gray-100 mb-1">{flex(phrase.es, inclusive)}</p>
                    <p className="text-xs text-brand-700 dark:text-gray-400">{phrase.hint}</p>
                    <button onClick={()=>{speak(flex(phrase.es, inclusive)); showToast('Reproduciendo', 'lassie');}} className="text-xs text-blossom-600 mt-2">
                      üëÇ Escuchar
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }
      
      function PlaylistMode({ playlists, setPlaylists, level, inclusive, recordings, setRecordings, onBack, showToast }){
        const [creating, setCreating] = useState(false);
        const [newName, setNewName] = useState('');
        const [selectedPhrases, setSelectedPhrases] = useState([]);
        
        if(creating){
          const available = ALL_SENTENCES.filter(s => s.lvl <= level);
          
          function savePlaylist(){
            if(!newName) return;
            setPlaylists(prev => [...prev, { name: newName, phrases: selectedPhrases, created: Date.now() }]);
            setCreating(false);
            setNewName('');
            setSelectedPhrases([]);
            showToast('Playlist guardado', 'doom');
          }
          
          return (
            <div>
              <button onClick={()=>setCreating(false)} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
              <input 
                type="text"
                value={newName}
                onChange={e=>setNewName(e.target.value)}
                placeholder="Nombre del playlist"
                className="w-full px-4 py-2 rounded-xl border border-brand-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-brand-900 dark:text-gray-100 mb-4"
              />
              
              <p className="text-sm text-brand-700 dark:text-gray-400 mb-2">Selecciona frases ({selectedPhrases.length})</p>
              <div className="space-y-2 mb-4 max-h-96 overflow-y-auto">
                {available.map(phrase => (
                  <button
                    key={phrase.id}
                    onClick={()=>{
                      if(selectedPhrases.includes(phrase.id)) setSelectedPhrases(prev => prev.filter(id=>id!==phrase.id));
                      else setSelectedPhrases(prev => [...prev, phrase.id]);
                    }}
                    className={cx('w-full text-left p-3 rounded-xl border', 
                      selectedPhrases.includes(phrase.id) ? 'border-brand-900 bg-brand-50 dark:bg-gray-700' : 'border-brand-200 dark:border-gray-700 bg-white dark:bg-gray-800')}
                  >
                    <p className="text-sm text-brand-900 dark:text-gray-100">{flex(phrase.es, inclusive)}</p>
                  </button>
                ))}
              </div>
              
              <button onClick={savePlaylist} disabled={!newName || selectedPhrases.length===0} className="w-full py-2 rounded-xl bg-brand-900 text-white disabled:opacity-50">
                Guardar playlist
              </button>
            </div>
          );
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            
            <button onClick={()=>setCreating(true)} className="w-full py-3 rounded-xl bg-brand-900 text-white mb-4">
              + Crear playlist
            </button>
            
            {playlists.length === 0 ? (
              <p className="text-center text-brand-700 dark:text-gray-400 py-8">No hay playlists todav√≠a</p>
            ) : (
              <div className="space-y-3">
                {playlists.map((pl, idx) => (
                  <div key={idx} className="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
                    <h3 className="font-semibold text-brand-900 dark:text-gray-100">{pl.name}</h3>
                    <p className="text-xs text-brand-700 dark:text-gray-400">{pl.phrases.length} frases</p>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }
      
      function PracticeMode({ mode, level, inclusive, recordings, setRecordings, onBack, onComplete, showToast }){
        const sentences = ALL_SENTENCES.filter(s => s.lvl <= level);
        const count = mode === 'quick' ? 1 : 5;
        const practice = useMemo(()=>sentences.sort(()=>0.5-Math.random()).slice(0,count),[]);
        const [idx, setIdx] = useState(0);
        const [recording, setRecording] = useState(false);
        const [transcript, setTranscript] = useState('');
        const [result, setResult] = useState(null);
        const rec = useSpeechRecognition({ onResult:(t)=>setTranscript(t), onEnd:()=>setRecording(false) });
        
        const phrase = practice[idx];
        const done = idx >= practice.length;
        
        if(done){
          onComplete();
          return (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üéâ</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-4">¬°De lujo!</h2>
              <button onClick={onBack} className="px-4 py-2 rounded-xl bg-brand-900 text-white">Salir</button>
            </div>
          );
        }
        
        function handleRecord(){
          if(!rec.supported) return;
          if(!recording){ setTranscript(''); setResult(null); rec.start(); setRecording(true); }
          else {
            rec.stop();
            const { pass } = wordScore(flex(phrase.es, inclusive), transcript);
            setResult(pass);
            setRecordings(prev => [...prev, { 
              transcript, 
              target: phrase.es, 
              passed: pass, 
              timestamp: Date.now(),
              phraseId: phrase.id,
              track: TRACKS.find(t=>t.key===phrase.id.split('')[0])?.key
            }]);
            showToast(pass ? 'De lujo!' : 'Casi', pass ? 'doom' : 'jules');
          }
        }
        
        function next(){
          setIdx(i=>i+1);
          setTranscript('');
          setResult(null);
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft border border-brand-200 dark:border-gray-700">
              <div className="text-xs text-brand-700 dark:text-gray-400 mb-2">{idx+1} / {practice.length}</div>
              <p className="text-xl text-brand-900 dark:text-gray-100 mb-2">{flex(phrase.es, inclusive)}</p>
              <p className="text-sm text-brand-700 dark:text-gray-400 mb-4">{phrase.hint}</p>
              
              <div className="flex gap-2 mb-4">
                <button onClick={()=>speak(flex(phrase.es, inclusive), {rate:0.75})} className="px-3 py-2 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                  üê¢ Lento
                </button>
                <button onClick={()=>speak(flex(phrase.es, inclusive))} className="px-3 py-2 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100 text-sm">
                  üëÇ Normal
                </button>
                <button onClick={handleRecord} className={cx('flex-1 py-2 rounded-xl text-white', recording?'bg-rose-600':'bg-brand-900')}>
                  {recording ? '‚èπ' : 'üé§'}
                </button>
              </div>
              
              {transcript && (
                <div className="p-3 bg-brand-50 dark:bg-gray-700 rounded-lg mb-3">
                  <div className="text-xs text-brand-700 dark:text-gray-400 mb-1">Tu respuesta:</div>
                  <div className="text-sm text-brand-900 dark:text-gray-100">{transcript}</div>
                </div>
              )}
              
              {result !== null && (
                <div className={cx('p-3 rounded-xl mb-3', result?'bg-emerald-100 dark:bg-emerald-900':'bg-amber-100 dark:bg-amber-900')}>
                  {result ? '‚úì Qued√≥ chido' : '‚óª Poquito m√°s'}
                </div>
              )}
              
              <button onClick={next} className="w-full py-2 rounded-xl bg-brand-900 text-white">
                Siguiente ‚Üí
              </button>
            </div>
          </div>
        );
      }
      
      // ---------------- GATOS TAB - Cat Minigames ----------------
      function GatosTab({ catGamesPlayed, setCatGamesPlayed, showToast, badges }){
        const [selectedGame, setSelectedGame] = useState(null);
        
        if(!selectedGame){
          return (
            <div className="space-y-4">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Juegos de gatos üê±</h2>
              
              <div className="grid grid-cols-2 gap-3">
                {Object.entries(CATS).map(([key, cat]) => (
                  <button
                    key={key}
                    onClick={()=>setSelectedGame(key)}
                    className="cat-card bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700 text-center"
                  >
                    <div className="text-6xl mb-2">{cat.emoji}</div>
                    <h3 className="font-bold text-brand-900 dark:text-gray-100 mb-1">{cat.name}</h3>
                    <p className="text-xs text-brand-700 dark:text-gray-400">{cat.game}</p>
                  </button>
                ))}
              </div>
              
              <div className="bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900 dark:to-pink-900 rounded-2xl p-4">
                <p className="text-sm text-brand-900 dark:text-gray-100">
                  üèÜ Juega con los 4 gatos para desbloquear "Gato favorito"
                </p>
              </div>
            </div>
          );
        }
        
        if(selectedGame === 'otis') return <OtisGame onBack={()=>setSelectedGame(null)} catGamesPlayed={catGamesPlayed} setCatGamesPlayed={setCatGamesPlayed} showToast={showToast} />;
        if(selectedGame === 'doom') return <DoomGame onBack={()=>setSelectedGame(null)} catGamesPlayed={catGamesPlayed} setCatGamesPlayed={setCatGamesPlayed} showToast={showToast} />;
        if(selectedGame === 'jules') return <JulesGame onBack={()=>setSelectedGame(null)} catGamesPlayed={catGamesPlayed} setCatGamesPlayed={setCatGamesPlayed} showToast={showToast} />;
        if(selectedGame === 'lassie') return <LassieGame onBack={()=>setSelectedGame(null)} catGamesPlayed={catGamesPlayed} setCatGamesPlayed={setCatGamesPlayed} showToast={showToast} />;
        
        return null;
      }
      
      // Otis: Speed Challenge
      function OtisGame({ onBack, catGamesPlayed, setCatGamesPlayed, showToast }){
        const [timeLeft, setTimeLeft] = useState(10);
        const [score, setScore] = useState(0);
        const [started, setStarted] = useState(false);
        const [phrase, setPhrase] = useState(null);
        
        useEffect(()=>{
          if(!started || timeLeft <= 0) return;
          const id = setInterval(()=>setTimeLeft(t=>t-1), 1000);
          return ()=>clearInterval(id);
        }, [started, timeLeft]);
        
        useEffect(()=>{
          if(timeLeft === 0 && started){
            setCatGamesPlayed(prev => [...prev, {cat:'otis', score, timestamp:Date.now()}]);
            showToast(`${score} puntos! MIAU MIAU!`, 'otis');
          }
        }, [timeLeft]);
        
        function start(){
          setStarted(true);
          setTimeLeft(10);
          setScore(0);
          nextPhrase();
        }
        
        function nextPhrase(){
          const p = ALL_SENTENCES[Math.floor(Math.random()*ALL_SENTENCES.length)];
          setPhrase(p);
        }
        
        function check(isCorrect){
          if(isCorrect) setScore(s=>s+1);
          nextPhrase();
        }
        
        if(!started){
          return (
            <div className="text-center py-8">
              <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
              <div className="text-8xl mb-4">üê±</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-2">Speed Challenge de Otis</h2>
              <p className="text-brand-700 dark:text-gray-300 mb-4">10 segundos. ¬øCu√°ntas frases reconoces?</p>
              <button onClick={start} className="px-6 py-3 rounded-xl bg-amber-600 text-white font-semibold">
                Empezar
              </button>
            </div>
          );
        }
        
        if(timeLeft === 0){
          return (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üê±</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-2">¬°Terminado!</h2>
              <p className="text-4xl font-bold text-brand-900 dark:text-gray-100 mb-4">{score} puntos</p>
              <p className="text-sm text-brand-700 dark:text-gray-400 mb-4">
                Otis dice: "Bueeeno, estuvo aceptable."
              </p>
              <button onClick={onBack} className="px-4 py-2 rounded-xl bg-brand-900 text-white">Salir</button>
            </div>
          );
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Salir</button>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft">
              <div className="flex justify-between mb-4">
                <div className="text-2xl font-bold">‚è±Ô∏è {timeLeft}s</div>
                <div className="text-2xl font-bold">üéØ {score}</div>
              </div>
              
              {phrase && (
                <>
                  <p className="text-xl text-brand-900 dark:text-gray-100 mb-4 text-center">{phrase.es}</p>
                  <div className="grid grid-cols-2 gap-2">
                    <button onClick={()=>check(true)} className="py-3 rounded-xl bg-emerald-600 text-white">‚úì S√© esto</button>
                    <button onClick={()=>check(false)} className="py-3 rounded-xl bg-rose-600 text-white">‚úó No s√©</button>
                  </div>
                </>
              )}
            </div>
          </div>
        );
      }
      
      // Doom: Memory Match
      function DoomGame({ onBack, catGamesPlayed, setCatGamesPlayed, showToast }){
        const [cards, setCards] = useState([]);
        const [flipped, setFlipped] = useState([]);
        const [matched, setMatched] = useState([]);
        const [moves, setMoves] = useState(0);
        
        useEffect(()=>{
          const phrases = ALL_SENTENCES.slice(0,4);
          const pairs = [...phrases, ...phrases].map((p,i)=>({...p, id:i}));
          setCards(pairs.sort(()=>0.5-Math.random()));
        }, []);
        
        function flip(idx){
          if(flipped.length === 2 || flipped.includes(idx) || matched.includes(idx)) return;
          const newFlipped = [...flipped, idx];
          setFlipped(newFlipped);
          
          if(newFlipped.length === 2){
            setMoves(m=>m+1);
            const [a,b] = newFlipped;
            if(cards[a].es === cards[b].es){
              setMatched([...matched, a, b]);
              setFlipped([]);
              if(matched.length + 2 === cards.length){
                setCatGamesPlayed(prev => [...prev, {cat:'doom', moves, timestamp:Date.now()}]);
                showToast('¬°Completado! Te mando abrazo.', 'doom');
              }
            } else {
              setTimeout(()=>setFlipped([]), 1000);
            }
          }
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-soft">
              <div className="flex justify-between mb-4">
                <h3 className="font-bold text-brand-900 dark:text-gray-100">üêà Memory de Doom</h3>
                <div className="text-sm text-brand-700 dark:text-gray-400">Movimientos: {moves}</div>
              </div>
              
              <div className="grid grid-cols-4 gap-2">
                {cards.map((card, idx) => (
                  <button
                    key={idx}
                    onClick={()=>flip(idx)}
                    className={cx('aspect-square rounded-xl flex items-center justify-center text-xs p-2',
                      matched.includes(idx) ? 'bg-emerald-100 dark:bg-emerald-900' :
                      flipped.includes(idx) ? 'bg-purple-100 dark:bg-purple-900' :
                      'bg-brand-100 dark:bg-gray-700'
                    )}
                  >
                    {(flipped.includes(idx) || matched.includes(idx)) ? card.es : '?'}
                  </button>
                ))}
              </div>
            </div>
          </div>
        );
      }
      
      // Jules: Truth Meter (confidence rating)
      function JulesGame({ onBack, catGamesPlayed, setCatGamesPlayed, showToast }){
        const phrases = useMemo(()=>ALL_SENTENCES.sort(()=>0.5-Math.random()).slice(0,5),[]);
        const [idx, setIdx] = useState(0);
        const [ratings, setRatings] = useState([]);
        
        const phrase = phrases[idx];
        const done = idx >= phrases.length;
        
        if(done){
          setCatGamesPlayed(prev => [...prev, {cat:'jules', ratings, timestamp:Date.now()}]);
          const avg = ratings.reduce((a,b)=>a+b,0)/ratings.length;
          return (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üêæ</div>
              <h2 className="text-2xl font-bold text-brand-900 dark:text-gray-100 mb-2">Listo</h2>
              <p className="text-brand-700 dark:text-gray-300 mb-4">
                Jules dice: "Confianza promedio {avg.toFixed(1)}/5. Respeto."
              </p>
              <button onClick={onBack} className="px-4 py-2 rounded-xl bg-brand-900 text-white">Salir</button>
            </div>
          );
        }
        
        function rate(score){
          setRatings([...ratings, score]);
          setIdx(i=>i+1);
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft">
              <div className="text-center mb-4">
                <div className="text-6xl mb-2">üêæ</div>
                <h3 className="font-bold text-brand-900 dark:text-gray-100">Jules Truth Meter</h3>
                <p className="text-xs text-brand-700 dark:text-gray-400">{idx+1} / {phrases.length}</p>
              </div>
              
              <p className="text-lg text-brand-900 dark:text-gray-100 text-center mb-4">{phrase.es}</p>
              <p className="text-sm text-brand-700 dark:text-gray-400 text-center mb-6">¬øQu√© tan [segure|segure] te sientes?</p>
              
              <div className="space-y-2">
                {[1,2,3,4,5].map(n=>(
                  <button key={n} onClick={()=>rate(n)} className="w-full py-3 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                    {'‚≠ê'.repeat(n)} {n}/5
                  </button>
                ))}
              </div>
            </div>
          </div>
        );
      }
      
      // Lassie: Phrase Collector
      function LassieGame({ onBack, catGamesPlayed, setCatGamesPlayed, showToast }){
        const [collected, setCollected] = useState([]);
        const [target] = useState(ALL_SENTENCES[Math.floor(Math.random()*ALL_SENTENCES.length)]);
        
        const options = useMemo(()=>{
          const others = ALL_SENTENCES.filter(p=>p.id!==target.id).sort(()=>0.5-Math.random()).slice(0,4);
          return [...others, target].sort(()=>0.5-Math.random());
        },[target]);
        
        function select(phrase){
          if(phrase.id === target.id){
            setCatGamesPlayed(prev => [...prev, {cat:'lassie', collected, timestamp:Date.now()}]);
            showToast('¬°Correcto! Te cuido siempre.', 'lassie');
            setTimeout(onBack, 2000);
          } else {
            showToast('No es esa. Intenta otra.', 'lassie');
          }
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-soft">
              <div className="text-center mb-4">
                <div className="text-6xl mb-2">üò∏</div>
                <h3 className="font-bold text-brand-900 dark:text-gray-100">Lassie Phrase Collector</h3>
              </div>
              
              <p className="text-center text-brand-700 dark:text-gray-300 mb-4">Encuentra la traducci√≥n:</p>
              <p className="text-lg text-center text-brand-900 dark:text-gray-100 mb-6 font-semibold">{target.hint}</p>
              
              <div className="space-y-2">
                {options.map((p,i)=>(
                  <button key={i} onClick={()=>select(p)} className="w-full text-left py-3 px-4 rounded-xl bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                    {p.es}
                  </button>
                ))}
              </div>
            </div>
          </div>
        );
      }
      
      // Stats & M√°s tabs (simplified for space)
      function StatsTab({ sessions, streak, badges, recordings }){
        const weeklyReport = useWeeklyReport();
        const report = weeklyReport.getWeeklyReport();
        
        return (
          <div className="space-y-4">
            <div className="bg-gradient-to-br from-blossom-600 to-brand-900 text-white rounded-2xl p-6">
              <h2 className="text-xl font-bold mb-2">Esta semana</h2>
              <div className="text-3xl font-bold">{report.thisWeekCount} pr√°cticas</div>
              <div className="text-sm">{Math.round(report.thisWeekRate*100)}% √©xito</div>
            </div>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700">
              <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-4">Insignias üåÆ</h3>
              <div className="grid grid-cols-3 gap-3">
                {BADGES.map(badge => {
                  const earned = badges.earned.includes(badge.id);
                  return (
                    <div key={badge.id} className={cx('p-3 rounded-xl text-center', earned?'bg-pink-100 dark:bg-pink-900':'bg-gray-100 dark:bg-gray-700 opacity-50')}>
                      <div className="text-3xl mb-1">{badge.emoji}</div>
                      <div className="text-xs font-semibold text-brand-900 dark:text-gray-100">{badge.name}</div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }
      
      function MasTab({ level, setLevel, inclusive, setInclusive, darkMode, setDarkMode, journals, setJournals, showToast }){
        const [tab, setTab] = useState('settings'); // 'settings', 'journal', 'tips'
        
        if(tab === 'journal'){
          return <JournalSection journals={journals} setJournals={setJournals} showToast={showToast} onBack={()=>setTab('settings')} />;
        }
        
        if(tab === 'tips'){
          return <TipsSection onBack={()=>setTab('settings')} />;
        }
        
        return (
          <div className="space-y-4">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700">
              <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Ajustes</h2>
              
              <div className="space-y-3">
                <div className="flex items-center justify-between py-2 border-b border-brand-200 dark:border-gray-700">
                  <span className="text-brand-900 dark:text-gray-100">Nivel</span>
                  <select value={level} onChange={e=>setLevel(parseInt(e.target.value))} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                    <option value={0}>0 - Principiante</option>
                    <option value={1}>1 - Intermedio</option>
                    <option value={2}>2 - Avanzado</option>
                  </select>
                </div>
                
                <div className="flex items-center justify-between py-2 border-b border-brand-200 dark:border-gray-700">
                  <span className="text-brand-900 dark:text-gray-100">Lenguaje inclusivo</span>
                  <button onClick={()=>setInclusive(v=>!v)} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                    {inclusive ? 'S√≠' : 'No'}
                  </button>
                </div>
                
                <div className="flex items-center justify-between py-2">
                  <span className="text-brand-900 dark:text-gray-100">Modo oscuro üåô</span>
                  <button onClick={()=>setDarkMode(v=>!v)} className="px-3 py-1.5 rounded-lg bg-brand-100 dark:bg-gray-700 text-brand-900 dark:text-gray-100">
                    {darkMode ? 'S√≠' : 'No'}
                  </button>
                </div>
              </div>
            </div>
            
            <button onClick={()=>setTab('journal')} className="w-full bg-brand-900 text-white py-3 rounded-xl font-semibold">
              üí¨ Mi diario
            </button>
            
            <button onClick={()=>setTab('tips')} className="w-full bg-blossom-600 text-white py-3 rounded-xl font-semibold">
              üìö Tips culturales
            </button>
            
            <div className="text-center space-y-2 py-4">
              <div className="flex justify-center gap-3 text-2xl">
                <span>üê±</span><span>üêà</span><span>üêæ</span><span>üò∏</span>
              </div>
              <div className="text-xs text-brand-700 dark:text-gray-400">
                para stacie ¬∑ v6.0
              </div>
            </div>
          </div>
        );
      }
      
      function JournalSection({ journals, setJournals, showToast, onBack }){
        const [recording, setRecording] = useState(false);
        const [transcript, setTranscript] = useState('');
        const [prompt] = useState(VOICE_PROMPTS[Math.floor(Math.random()*VOICE_PROMPTS.length)]);
        const rec = useSpeechRecognition({ onResult:(t)=>setTranscript(t), onEnd:()=>setRecording(false) });
        
        function handleRecord(){
          if(!rec.supported) return;
          if(!recording){ setTranscript(''); rec.start(); setRecording(true); }
          else {
            rec.stop();
            if(transcript){
              setJournals(prev => [...prev, { text: transcript, timestamp: Date.now() }]);
              setTranscript('');
              showToast('Guardado', 'doom');
            }
          }
        }
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-soft border border-brand-200 dark:border-gray-700 mb-4">
              <h3 className="font-bold text-brand-900 dark:text-gray-100 mb-2">Prompt:</h3>
              <p className="text-brand-700 dark:text-gray-300 mb-4">{prompt}</p>
              
              <button onClick={handleRecord} className={cx('w-full py-3 rounded-xl text-white font-semibold', recording?'bg-rose-600':'bg-brand-900')}>
                {recording ? '‚èπ Detener' : 'üé§ Grabar'}
              </button>
              
              {transcript && (
                <div className="mt-3 p-3 bg-brand-50 dark:bg-gray-700 rounded-xl">
                  <p className="text-brand-900 dark:text-gray-100">{transcript}</p>
                </div>
              )}
            </div>
            
            <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-3">Entradas recientes</h3>
            {journals.length === 0 ? (
              <p className="text-center text-brand-700 dark:text-gray-400 py-6">Todav√≠a nada</p>
            ) : (
              <div className="space-y-2">
                {journals.slice().reverse().slice(0,5).map((j,i)=>(
                  <div key={i} className="bg-white dark:bg-gray-800 rounded-xl p-3 shadow-soft border border-brand-200 dark:border-gray-700">
                    <div className="text-xs text-brand-700 dark:text-gray-400 mb-1">{new Date(j.timestamp).toLocaleDateString('es-MX')}</div>
                    <p className="text-sm text-brand-900 dark:text-gray-100">{j.text}</p>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }
      
      function TipsSection({ onBack }){
        const tips = [
          { title: '¬øMande?', text: 'Forma amable de "¬øqu√©?" m√°s com√∫n en M√©xico.' },
          { title: 'Jitomate vs. Tomate', text: 'Jitomate = rojo. Tomate = verde (en M√©xico).' },
          { title: 'Diminutivos', text: 'Poquito, ratito, tantito = cari√±o, no vaguedad.' },
          { title: 'Usted vs. T√∫', text: 'Con estudiantes: t√∫. Con familias: usted.' }
        ];
        
        return (
          <div>
            <button onClick={onBack} className="text-brand-700 dark:text-gray-400 mb-4">‚Üê Atr√°s</button>
            <h2 className="text-xl font-bold text-brand-900 dark:text-gray-100 mb-4">Tips culturales</h2>
            <div className="space-y-3">
              {tips.map((tip,i)=>(
                <div key={i} className="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-soft border border-brand-200 dark:border-gray-700">
                  <h3 className="font-semibold text-brand-900 dark:text-gray-100 mb-1">{tip.title}</h3>
                  <p className="text-sm text-brand-700 dark:text-gray-300">{tip.text}</p>
                </div>
              ))}
            </div>
          </div>
        );
      }
      
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
